<!DOCTYPE html>
<html lang="ru">
<head>
        <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
        (function(m,e,t,r,i,k,a){
            m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
            m[i].l=1*new Date();
            for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
            k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
        })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105240174', 'ym');

        ym(105240174, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/105240174" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="WiTech - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–º–∏ –æ—Ç—á–µ—Ç–∞–º–∏">
    <link rel="icon" href="/logo.ico" type="image/x-icon">
    <title>WiTech –°—Ç—Ä–æ–π–∫–æ–Ω—Ç—Ä–æ–ª—å- –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&family=Roboto:wght@300;400;700&display=swap');
        
        :root {
            --primary: #54B0A5;
            --secondary: #3A7B8C;
            --accent: #E0F2E9;
            --dark: #1E2F40;
            --light: #F5FDFF;
        }
        
        /* –°–¢–ò–õ–ò –î–õ–Ø –§–û–†–ú–´ –í–•–û–î–ê */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .login-container {
            background: rgba(58, 123, 140, 0.9);
            padding: 40px;
            border-radius: 10px;
            border: 2px solid var(--primary);
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-logo img {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
        }
        
        .login-title {
            color: var(--accent);
            margin: 0 0 10px;
            font-size: 1.8rem;
        }
        
        .login-subtitle {
            color: var(--light);
            opacity: 0.8;
            margin: 0;
        }
        
        .login-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--secondary);
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: var(--light);
            margin-bottom: 15px;
            font-family: 'Montserrat', sans-serif;
            box-sizing: border-box;
        }
        
        .login-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(84, 176, 165, 0.3);
        }
        
        .login-button {
            width: 100%;
            background: var(--primary);
            color: var(--dark);
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s ease;
        }
        
        .login-button:hover {
            background: #4aa095;
            transform: translateY(-2px);
        }
        
        .login-error {
            color: #e74c3c;
            text-align: center;
            margin-top: 15px;
            display: none;
            font-size: 0.9rem;
        }

        /* –í–ê–®–ò –°–£–©–ï–°–¢–í–£–Æ–©–ò–ï –°–¢–ò–õ–ò */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Montserrat', sans-serif;
            background-color: var(--dark);
            color: var(--light);
            overflow-x: hidden;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--dark) 0%, #2D4B5A 100%);
        }
        
        .header-container {
            position: relative;
            width: 100%;
            padding: 20px 0;
            text-align: center;
        }
        
        .back-link {
            position: absolute;
            top: 30px;
            left: 30px;
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            font-weight: 400;
            z-index: 10;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .container {
            max-width: none;
            margin: 0 20px;
            padding: 20px 0 40px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin: 0 0 40px;
            color: var(--primary);
            text-align: center;
            font-weight: 700;
        }
        
        h2 {
            color: var(--accent);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
            margin-top: 40px;
        }
        
        /* –í–∫–ª–∞–¥–∫–∏ */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--secondary);
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            background: rgba(58, 123, 140, 0.3);
            border: none;
            color: var(--light);
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .tab.active {
            background: var(--primary);
            color: var(--dark);
            font-weight: 700;
        }

        .tab:hover:not(.active) {
            background: rgba(84, 176, 165, 0.3);
        }

        .send-report-button {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            border-radius: 8px;
            font-weight: 700;
            letter-spacing: 0.02em;
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }

        .send-report-button:hover {
            background: linear-gradient(135deg, #29b765 0%, #1f8f4c 100%);
            transform: translateY(-2px);
        }
        
        /* –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ */
        .tab-content {
            display: none;
            padding: 20px;
            background: rgba(30, 47, 64, 0.8);
            border-radius: 0 8px 8px 8px;
            border: 1px solid var(--secondary);
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* –¢–∞–±–ª–∏—Ü—ã */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            max-height: 70vh;
            overflow-y: auto;
            border: 1px solid var(--secondary);
            border-radius: 6px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(30, 47, 64, 0.6);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--secondary);
            border-right: 1px solid var(--secondary);
        }
        
        /* –°–¢–ò–õ–ò –î–õ–Ø –ó–ê–ì–û–õ–û–í–ö–û–í –° –°–û–†–¢–ò–†–û–í–ö–û–ô */
        th {
            background: var(--secondary);
            color: var(--accent);
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        th:hover {
            background: var(--primary);
            color: var(--dark);
        }
        
        th.sortable::after {
            content: " ‚Üï";
            opacity: 0.6;
        }
        
        th.sorted-asc::after {
            content: " ‚Üë";
            opacity: 1;
        }
        
        th.sorted-desc::after {
            content: " ‚Üì";
            opacity: 1;
        }
        
        th.sorted-default::after {
            content: " ‚Üï";
            opacity: 0.6;
        }
        
        tr:hover {
            background: rgba(84, 176, 165, 0.1);
        }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        button {
            background: var(--primary);
            color: var(--dark);
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background: #4aa095;
            transform: translateY(-2px);
        }
        
        button.secondary {
            background: var(--secondary);
            color: var(--light);
        }
        
        button.secondary:hover {
            background: #336977;
        }
        
        button.danger {
            background: #e74c3c;
            color: white;
        }
        
        button.danger:hover {
            background: #c0392b;
        }
        
        button.success {
            background: #2ecc71;
            color: white;
        }
        
        button.success:hover {
            background: #27ae60;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .action-buttons button {
            margin: 2px;
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .action-buttons button.success {
            background: #27ae60;
            color: white;
        }

        .action-buttons button.success:hover {
            background: #219653;
        }

        .action-buttons .verify-button {
            background: #7f8c8d;
            color: #ffffff;
        }

        .action-buttons .verify-button:hover {
            background: #707b7c;
        }

        .action-buttons .verify-button.verified {
            background: #27ae60;
            color: #ffffff;
        }

        .action-buttons .verify-button.verified:hover {
            background: #1f8f4d;
        }

        /* –§–æ—Ä–º—ã –≤–≤–æ–¥–∞ */
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--secondary);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            box-sizing: border-box;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(84, 176, 165, 0.3);
        }
        
        input[readonly] {
            background: rgba(255, 255, 255, 0.05);
            color: var(--accent);
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .notification.success {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
            color: #2ecc71;
        }
        
        .notification.error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #e74c3c;
        }
        
        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--primary);
        }
        
        /* –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .dropdown {
            position: relative;
            z-index: 20;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            background: rgba(58, 123, 140, 0.95);
            border: 1px solid var(--secondary);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            min-width: 220px;
            z-index: 1000;
            display: none;
            overflow: hidden;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--light);
            padding: 10px 14px;
            text-align: left;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.95rem;
        }

        .dropdown-item:hover {
            background: rgba(84, 176, 165, 0.2);
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ */
        select {
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            border: 1px solid var(--secondary);
            border-radius: 4px;
            padding: 8px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2354B0A5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 30px;
        }

        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(84, 176, 165, 0.3);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è option */
        select option {
            background: var(--dark);
            color: var(--light);
            padding: 10px;
            border: none;
        }

        select option:hover,
        select option:focus,
        select option:checked {
            background: var(--primary);
            color: var(--dark);
        }

        /* –î–ª—è Firefox */
        @-moz-document url-prefix() {
            select {
                color: var(--light) !important;
                text-shadow: 0 0 0 var(--light);
            }
            
            select option {
                background: var(--dark);
                color: var(--light);
            }
            
            select option:checked {
                background: var(--primary);
                color: var(--dark);
            }
        }

        /* –î–ª—è Internet Explorer */
        @media all and (-ms-high-contrast: none), (-ms-high-contrast: active) {
            select {
                color: var(--light);
            }
            
            select option {
                background: var(--dark);
                color: var(--light);
            }
        }
        
        /* –í–æ–ª–Ω—ã */
        .waves {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%2354B0A5" fill-opacity="0.1" d="M0,192L48,197.3C96,203,192,213,288,229.3C384,245,480,267,576,250.7C672,235,768,181,864,181.3C960,181,1056,235,1152,234.7C1248,235,1344,181,1392,154.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
            background-size: cover;
            z-index: -1;
        }
        
        /* –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ß–ï–ö–ë–û–ö–°–û–í –ò –ú–ê–°–°–û–í–û–ì–û –£–î–ê–õ–ï–ù–ò–Ø */
        .checkbox-cell {
            width: 40px;
            text-align: center;
        }
        
        .checkbox-cell input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .mass-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(58, 123, 140, 0.2);
            border-radius: 6px;
            border: 1px solid var(--secondary);
        }
        
        .selected-count {
            color: var(--primary);
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è */
        .fade-out {
            opacity: 0;
            transition: opacity 0.3s ease-out;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–∞–∑–¥–µ–ª–æ–≤ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
            box-sizing: border-box;
        }

        .modal-content {
            background: var(--dark);
            padding: 30px;
            border-radius: 10px;
            border: 2px solid var(--primary);
            max-width: 500px;
            width: 90%;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .modal-title {
            color: var(--primary);
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-subtitle {
            margin: 0 0 15px 0;
            color: var(--light);
            opacity: 0.8;
            font-size: 0.95rem;
        }

        .modal-form-group {
            margin-bottom: 15px;
        }

        .modal-form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--accent);
            font-weight: 600;
        }

        .modal-form-group select,
        .modal-form-group input {
            width: 100%;
        }

        .modal-note {
            margin-top: 5px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
        }

        .quantity-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .quantity-input-wrapper span {
            min-width: 60px;
            text-align: right;
            color: var(--accent);
            font-weight: 600;
        }

        #reportWorksContainer {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .report-work-item {
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--secondary);
            background: rgba(30, 47, 64, 0.6);
        }

        .report-work-item .modal-note {
            margin-bottom: 10px;
        }

        .report-work-item .remove-report-work-button {
            margin-top: 10px;
        }

        .modal-alert {
            display: none;
            padding: 12px 14px;
            border-radius: 6px;
            border: 1px solid #e74c3c;
            background: rgba(231, 76, 60, 0.15);
            color: #ffb3a7;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .work-materials-modal .modal-content {
            max-width: 720px;
        }

        .material-add-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .material-add-row select,
        .material-add-row input {
            flex: 1;
        }

        .material-add-row button {
            flex-shrink: 0;
        }

        .work-materials-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .work-materials-table th,
        .work-materials-table td {
            border: 1px solid rgba(84, 176, 165, 0.4);
            padding: 8px;
            text-align: left;
        }

        .work-materials-table th {
            background: rgba(84, 176, 165, 0.15);
            color: var(--accent);
        }

        .work-materials-table tbody tr:nth-child(even) {
            background: rgba(84, 176, 165, 0.05);
        }

        .work-materials-table input {
            width: 100%;
            box-sizing: border-box;
        }

        .work-pricing-section {
            margin-top: 20px;
            padding: 16px;
            border-radius: 10px;
            border: 1px solid rgba(84, 176, 165, 0.4);
            background: rgba(84, 176, 165, 0.08);
        }

        .work-pricing-section h4 {
            margin: 0 0 12px;
            color: var(--accent);
            font-size: 1.1rem;
        }

        .work-pricing-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .work-pricing-row {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .work-pricing-row label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .work-pricing-row input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid rgba(84, 176, 165, 0.4);
            background: rgba(30, 47, 64, 0.6);
            color: var(--light);
            font-size: 1rem;
        }

        .work-pricing-row input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(84, 176, 165, 0.25);
        }

        .work-pricing-hint {
            margin-top: 10px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.65);
        }

        .foreman-sections-modal .modal-content {
            max-width: 560px;
        }

        .foreman-sections-select-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .foreman-sections-select-row select {
            flex: 1;
        }

        .foreman-sections-list {
            border: 1px solid var(--secondary);
            border-radius: 6px;
            background: rgba(30, 47, 64, 0.6);
            max-height: 220px;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .foreman-sections-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-radius: 4px;
            border: 1px solid var(--secondary);
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .foreman-sections-list-item:hover {
            background: rgba(84, 176, 165, 0.1);
            transform: translateX(5px);
        }

        .foreman-sections-list-item button {
            margin: 0;
            padding: 4px 10px;
            font-size: 0.8rem;
        }

        .foreman-sections-list-empty {
            text-align: center;
            color: var(--accent);
            opacity: 0.7;
            padding: 10px 0;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ —Ä–∞–∑–¥–µ–ª–æ–≤ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ */
        .categories-list {
            border: 1px solid var(--secondary);
            border-radius: 6px;
            padding: 10px;
            background: rgba(30, 47, 64, 0.6);
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 5px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            border: 1px solid var(--secondary);
            transition: all 0.3s ease;
            gap: 10px;
        }

        .category-item:hover {
            background: rgba(84, 176, 165, 0.1);
            transform: translateX(5px);
        }

        .category-item .category-name {
            flex: 1;
            color: var(--light);
        }

        .category-item .category-actions {
            display: flex;
            gap: 8px;
        }

        .category-item.editing {
            background: rgba(84, 176, 165, 0.1);
        }

        .category-item.editing input[type="text"] {
            flex: 1;
            margin-right: 10px;
        }

        .category-item button {
            margin: 0;
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä—ã—Ç–æ–≥–æ input —Ñ–∞–π–ª–∞ */
        #importFileInput {
            display: none;
        }

        /* –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –¢–ê–ë–õ–ò–¶–´ –†–ê–ë–û–¢ */
        #worksTable {
            table-layout: fixed;
            width: 100%;
        }

        /* –£–∑–∫–∏–µ –∫–æ–ª–æ–Ω–∫–∏ */
        #worksTable th:nth-child(1),
        #worksTable td:nth-child(1) {
            width: 40px;
        }

        #worksTable th:nth-child(2),
        #worksTable td:nth-child(2) {
            width: 60px;
        }

        #worksTable th:nth-child(3),
        #worksTable td:nth-child(3) {
            width: auto;
            min-width: 300px;
        }

        #worksTable th:nth-child(4),
        #worksTable td:nth-child(4) {
            width: 150px;
        }

        #worksTable th:nth-child(5),
        #worksTable td:nth-child(5) {
            width: 120px;
        }

        #worksTable th:nth-child(6),
        #worksTable td:nth-child(6) {
            width: 120px;
        }

        #worksTable th:nth-child(7),
        #worksTable td:nth-child(7) {
            width: 100px;
        }

        #worksTable th:nth-child(8),
        #worksTable td:nth-child(8) {
            width: 100px;
        }

        #worksTable th:nth-child(9),
        #worksTable td:nth-child(9) {
            width: 150px;
        }
        
        @media (max-width: 768px) {
            .back-link {
                top: 20px;
                left: 20px;
            }
            
            .container {
                margin: 0 15px;
                padding: 15px 0 30px;
            }
            
            h1 {
                font-size: 2rem;
                margin-bottom: 30px;
                padding-top: 10px;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
                padding: 10px 5px;
                font-size: 0.9rem;
            }
            
            th, td {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
            
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                min-width: 100%;
            }

            #worksTable {
                table-layout: auto;
            }

            #worksTable th:nth-child(3),
            #worksTable td:nth-child(3) {
                min-width: 150px;
            }
        }

        @media (max-width: 480px) {
            .back-link {
                top: 15px;
                left: 15px;
                font-size: 0.9rem;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .tab {
                min-width: 100px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- –§–û–†–ú–ê –í–•–û–î–ê -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-container">
            <div class="login-logo">
                <img src="logo.png" alt="WiTech Logo">
                <h2 class="login-title">–í—Ö–æ–¥ –≤ –ø–∞–Ω–µ–ª—å</h2>
                <p class="login-subtitle">WiTech-–°—Ç—Ä–æ–π–∫–æ–Ω—Ç—Ä–æ–ª—å</p>
            </div>
            
            <div>
                <input type="text" id="username" class="login-input" placeholder="–õ–æ–≥–∏–Ω" autocomplete="username">
                <input type="password" id="password" class="login-input" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
            </div>
            
            <button onclick="login()" class="login-button">–í–æ–π—Ç–∏</button>
            
            <div id="loginError" class="login-error">–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å</div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –†–ê–ó–î–ï–õ–ê–ú–ò -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">–†–∞–∑–¥–µ–ª—ã –ø—Ä–æ–µ–∫—Ç–æ–≤</h3>
            
            <!-- –°–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ -->
            <div class="categories-list" id="categoriesList">
                <!-- –†–∞–∑–¥–µ–ª—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
            </div>
            
            <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="text" id="newCategoryName" class="login-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞" style="flex: 1;">
                <button onclick="saveNewCategory()" class="success">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            
            <div class="modal-actions">
                <button onclick="closeCategoryModal()" class="secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–∞–∑–¥–µ–ª–æ–≤ -->
    <div id="addBalanceModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –∫ –±–∞–ª–∞–Ω—Å—É</h3>
            <p>–†–∞–±–æ—Ç–∞: <span id="balanceWorkName"></span></p>
            <p>–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: <span id="currentBalance"></span></p>

            <input type="number" id="addBalanceAmount" class="login-input" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" step="1" min="1">

            <div class="modal-actions">
                <button onclick="confirmAddBalance()" class="success">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                <button onclick="closeAddBalanceModal()" class="secondary">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <div id="addMaterialQuantityModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ —Å–∫–ª–∞–¥</h3>
            <p>–ú–∞—Ç–µ—Ä–∏–∞–ª: <span id="materialQuantityName"></span></p>
            <p>–¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: <span id="materialCurrentQuantity"></span></p>

            <input type="number" id="addMaterialQuantityAmount" class="login-input" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" step="1" min="0.01">

            <div class="modal-actions">
                <button onclick="confirmAddMaterialQuantity()" class="success">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                <button onclick="closeAddMaterialQuantityModal()" class="secondary">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <div id="materialPricingModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">–°—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∞</h3>
            <p class="modal-subtitle">–ú–∞—Ç–µ—Ä–∏–∞–ª: <span id="materialPricingName"></span></p>

            <div class="work-pricing-section" style="padding: 0; border: none;">
                <div class="work-pricing-list">
                    <div class="work-pricing-row">
                        <label for="materialPriceUnit">–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É</label>
                        <input type="number" id="materialPriceUnit" min="0" step="0.01" placeholder="0.00">
                    </div>
                    <div class="work-pricing-row">
                        <label for="materialPriceTotal">–í—Å–µ–≥–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å</label>
                        <input type="number" id="materialPriceTotal" min="0" step="0.01" placeholder="0.00">
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button id="materialPricingSaveButton" class="success" type="button">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" class="secondary" onclick="closeMaterialPricingModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="workMaterialsModal" class="modal work-materials-modal">
        <div class="modal-content">
            <h3 class="modal-title">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã —Ä–∞–±–æ—Ç—ã</h3>
            <p class="modal-subtitle">–†–∞–±–æ—Ç–∞: <span id="workMaterialsWorkName"></span></p>

            <div class="material-add-row">
                <select id="workMaterialSelect" class="login-input">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª</option>
                </select>
                <input type="number" id="workMaterialQuantity" class="login-input" placeholder="–†–∞—Å—Ö–æ–¥ –Ω–∞ 1 –µ–¥." min="0" step="1">
                <button id="workMaterialAddButton" class="success" type="button">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>

            <table class="work-materials-table">
                <thead>
                    <tr>
                        <th>–ú–∞—Ç–µ—Ä–∏–∞–ª</th>
                        <th>–ï–¥. –∏–∑–º.</th>
                        <th>–†–∞–∑–¥–µ–ª</th>
                        <th>–ù–∞ —Å–∫–ª–∞–¥–µ</th>
                        <th>–†–∞—Å—Ö–æ–¥ –Ω–∞ 1 –µ–¥.</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="workMaterialsTableBody">
                    <tr><td colspan="6" style="text-align: center;">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</td></tr>
                </tbody>
            </table>

            <div class="work-pricing-section">
                <h4>–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã</h4>
                <div class="work-pricing-list">
                    <div class="work-pricing-row">
                        <label for="workPriceUnit">–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É</label>
                        <input type="number" id="workPriceUnit" min="0" step="0.01" placeholder="0.00">
                    </div>
                    <div class="work-pricing-row">
                        <label for="workPriceTotal">–í—Å–µ–≥–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å</label>
                        <input type="number" id="workPriceTotal" min="0" step="0.01" placeholder="0.00">
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button onclick="saveWorkMaterials()" class="success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button onclick="closeWorkMaterialsModal()" class="secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="foremanSectionsModal" class="modal foreman-sections-modal">
        <div class="modal-content">
            <h3 class="modal-title">–†–∞–∑–¥–µ–ª—ã –±—Ä–∏–≥–∞–¥–∏—Ä–∞</h3>
            <p class="modal-subtitle">–ë—Ä–∏–≥–∞–¥–∏—Ä: <span id="foremanSectionsName"></span></p>

            <div class="foreman-sections-select-row">
                <select id="foremanSectionsSelect" class="login-input">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª</option>
                </select>
                <button type="button" class="success" onclick="addSectionToForeman()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>

            <div id="foremanSectionsList" class="foreman-sections-list">
                <div class="foreman-sections-list-empty">–†–∞–∑–¥–µ–ª—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</div>
            </div>

            <div class="modal-actions">
                <button onclick="saveForemanSections()" class="success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button onclick="closeForemanSectionsModal()" class="secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="sendReportModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç</h3>
            <p class="modal-subtitle">–°–æ–∑–¥–∞–π—Ç–µ –æ—Ç—á–µ—Ç –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ –≤ –±–∞–∑–µ</p>

            <form id="sendReportForm">
                <div id="sendReportAvailabilityMessage" class="modal-alert"></div>

                <div class="modal-form-group">
                    <label for="reportForemanSelect">–ë—Ä–∏–≥–∞–¥–∏—Ä</label>
                    <select id="reportForemanSelect" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–∏–≥–∞–¥–∏—Ä–∞</option>
                    </select>
                </div>

                <div class="modal-form-group">
                    <label for="reportWorksContainer">–†–∞–±–æ—Ç—ã</label>
                    <div id="reportWorksContainer"></div>
                    <button type="button" id="addReportWorkButton" class="secondary">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É</button>
                </div>

                <div class="modal-form-group">
                    <label for="reportDate">–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞</label>
                    <input type="date" id="reportDate" required>
                </div>

                <div class="modal-form-group">
                    <label for="reportTime">–í—Ä–µ–º—è –æ—Ç—á–µ—Ç–∞</label>
                    <input type="time" id="reportTime" step="1" required>
                </div>

                <p class="modal-note">–ü–∞–ø–∫–∞ –¥–ª—è —Ñ–æ—Ç–æ–æ—Ç—á–µ—Ç–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–µ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç—á–µ—Ç–∞.</p>

                <div class="modal-actions">
                    <button type="button" onclick="closeSendReportModal()" class="secondary">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" id="submitReportButton" class="success">üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editReportModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç</h3>
            <p class="modal-subtitle">–ò–∑–º–µ–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</p>

            <form id="editReportForm">
                <div id="editReportError" class="modal-alert" style="display: none;"></div>

                <div class="modal-form-group">
                    <label for="editReportForemanSelect">–ë—Ä–∏–≥–∞–¥–∏—Ä</label>
                    <select id="editReportForemanSelect" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–∏–≥–∞–¥–∏—Ä–∞</option>
                    </select>
                </div>

                <div class="modal-form-group">
                    <label for="editReportWorkSelect">–†–∞–±–æ—Ç–∞</label>
                    <select id="editReportWorkSelect" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É</option>
                    </select>
                    <p id="editReportWorkDetails" class="modal-note">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏.</p>
                </div>

                <div class="modal-form-group">
                    <label for="editReportQuantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <div class="quantity-input-wrapper">
                        <input type="number" id="editReportQuantity" class="report-work-quantity" min="0" step="0.01" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" required>
                        <span id="editReportWorkUnit" class="report-work-unit"></span>
                    </div>
                </div>

                <div class="modal-form-group">
                    <label for="editReportDate">–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞</label>
                    <input type="date" id="editReportDate" required>
                </div>

                <div class="modal-form-group">
                    <label for="editReportTime">–í—Ä–µ–º—è –æ—Ç—á–µ—Ç–∞</label>
                    <input type="time" id="editReportTime" step="1" required>
                </div>

                <div class="modal-form-group">
                    <label for="editReportPhoto">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ–æ—Ç—á–µ—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <input type="url" id="editReportPhoto" placeholder="https://">
                </div>

                <div class="modal-actions">
                    <button type="button" id="cancelEditReportButton" class="secondary">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" id="saveEditReportButton" class="success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ (—Å–∫—Ä—ã—Ç –¥–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏) -->
    <div id="mainContent" style="display: none;">
        <div class="container">
            <h1>WiTech-–°—Ç—Ä–æ–π–∫–æ–Ω—Ç—Ä–æ–ª—å</h1>
            
            <div class="tabs">
                <button class="tab active" data-tab="works">üèóÔ∏è –†–∞–±–æ—Ç—ã –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</button>
                <button class="tab" data-tab="materials">üì¶ –°–∫–ª–∞–¥</button>
                <button class="tab" data-tab="foremen">üë∑ –ë—Ä–∏–≥–∞–¥–∏—Ä—ã</button>
                <button type="button" id="openSendReportModal" class="send-report-button">üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç</button>
                <button class="tab" data-tab="accumulative">üì¶ –ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è –≤–µ–¥–æ–º–æ—Å—Ç—å</button>
                <button class="tab" data-tab="all-reports">üìã –í—Å–µ –æ—Ç—á–µ—Ç—ã</button>
            </div>
            
            <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
            <div id="notification" class="notification"></div>
            
            <!-- –í–∫–ª–∞–¥–∫–∞ —Ä–∞–±–æ—Ç -->
            <div id="works" class="tab-content active">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–º–∏</h2>
                
                <div class="toolbar">
                    <button id="addWork" class="success">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É –∏–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª</button>
                    <button id="addCategory" class="success">üìÅ –†–∞–∑–¥–µ–ª—ã</button>
                    <button id="saveAllWorks" class="secondary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                    <button id="exportWorks" class="secondary">üì• –í—ã–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö</button>
                    <button id="importWorks" class="secondary">üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä</button>
                    <input type="file" id="importFileInput" accept=".xlsx,.xls" style="display: none;">
                    <button id="deleteSelectedWorks" class="danger" style="display: none;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
                    <div class="search-box">
                        <input type="text" id="searchWorks" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ä–∞–±–æ—Ç–∞–º...">
                    </div>
                </div>
                
                <!-- –ü–∞–Ω–µ–ª—å –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π -->
                <div class="mass-actions" id="massActions" style="display: none;">
                    <span class="selected-count" id="selectedCount">0</span>
                    <span>–≤—ã–±—Ä–∞–Ω–æ</span>
                </div>
                
                <div class="loading" id="worksLoading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                
                <div class="table-container">
                    <table id="worksTable">
                        <thead>
                            <tr>
                                <th class="checkbox-cell">
                                    <input type="checkbox" id="selectAllWorks">
                                </th>
                                <th class="sortable">ID</th>
                                <th class="sortable">–†–∞–∑–¥–µ–ª—ã</th>
                                <th class="sortable">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                                <th class="sortable">–ï–¥.–∏–∑–º.</th>
                                <th class="sortable">–ù–∞ –±–∞–ª–∞–Ω—Å–µ</th>
                                <th class="sortable">–ü—Ä–æ–µ–∫—Ç</th>
                                <th class="sortable">–ê–∫—Ç–∏–≤–Ω–æ</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="worksTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ —Å–∫–ª–∞–¥–∞ -->
            <div id="materials" class="tab-content">
                <h2>–°–∫–ª–∞–¥ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h2>

                <div class="toolbar">
                    <button id="addMaterial" class="success">‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</button>
                    <button id="exportMaterials" class="secondary">üì• –í—ã–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö</button>
                    <button id="importMaterials" class="secondary">üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä</button>
                    <button id="toggleMaterialsHistory" class="secondary">üìú –ò—Å—Ç–æ—Ä–∏—è</button>
                    <input type="file" id="materialsImportInput" accept=".xlsx,.xls" style="display: none;">
                    <div class="search-box">
                        <input type="text" id="searchMaterials" placeholder="–ü–æ–∏—Å–∫ –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º...">
                    </div>
                </div>

                <div class="loading" id="materialsLoading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

                <div class="table-container" id="materialsTableContainer">
                    <table id="materialsTable">
                        <thead>
                            <tr>
                                <th class="sortable">ID</th>
                                <th class="sortable">–†–∞–∑–¥–µ–ª</th>
                                <th class="sortable">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                                <th class="sortable">–ï–¥. –∏–∑–º.</th>
                                <th class="sortable">–ö–æ–ª-–≤–æ</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="materialsTableBody"></tbody>
                    </table>
                </div>

                <div class="loading" id="materialsHistoryLoading" style="display: none;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>

                <div class="table-container" id="materialHistoryContainer" style="display: none;">
                    <table id="materialHistoryTable">
                        <thead>
                            <tr>
                                <th class="sortable">ID</th>
                                <th class="sortable">–ú–∞—Ç–µ—Ä–∏–∞–ª</th>
                                <th class="sortable">–î–µ–π—Å—Ç–≤–∏–µ</th>
                                <th class="sortable">–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
                                <th class="sortable">–û—Å—Ç–∞—Ç–æ–∫</th>
                                <th class="sortable">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                <th class="sortable">–ö–µ–º</th>
                                <th class="sortable">–ö–æ–≥–¥–∞</th>
                            </tr>
                        </thead>
                        <tbody id="materialHistoryTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤ -->
            <div id="foremen" class="tab-content">
               <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–∏–≥–∞–¥–∏—Ä–∞–º–∏</h2>
<div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px; background: rgba(84, 176, 165, 0.1); padding: 15px; border-radius: 8px; border: 1px solid var(--primary);">
    <div style="flex-shrink: 0;">
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://t.me/Buildrep_bot" 
             alt="QR –∫–æ–¥ –¥–ª—è Telegram –±–æ—Ç–∞" 
             style="width: 120px; height: 120px; border: 2px solid var(--primary); border-radius: 8px;">
    </div>
    <div style="flex: 1;">
        <p style="margin: 0 0 10px 0; color: var(--accent); font-weight: bold; font-size: 1.1rem;">
            üì± Telegram –±–æ—Ç –¥–ª—è –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤
        </p>
        <p style="margin: 0 0 8px 0; color: var(--light);">
            <strong>–°—Å—ã–ª–∫–∞:</strong> 
            <a href="https://t.me/Buildrep_bot" target="_blank" style="color: var(--primary); text-decoration: none;">
                t.me/Buildrep_bot
            </a>
        </p>
        <p style="margin: 0; color: var(--light); opacity: 0.8; font-size: 0.9rem;">
            –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∏–ª–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –±–æ—Ç—É
        </p>
    </div>
</div>
                
                <div class="toolbar">
                    <button id="saveAllForemen" class="secondary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                    <div class="search-box">
                        <input type="text" id="searchForemen" placeholder="–ü–æ–∏—Å–∫ –ø–æ –±—Ä–∏–≥–∞–¥–∏—Ä–∞–º...">
                    </div>
                </div>
                
                <div class="loading" id="foremenLoading">–ó–∞–≥—Ä—É–∑–∫–∞ –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤...</div>
                
                <div class="table-container">
                    <table id="foremenTable">
                        <thead>
                            <tr>
                                <th class="sortable" width="150">ID</th>
                                <th class="sortable">–§–∞–º–∏–ª–∏—è –∏ –∏–º—è</th>
                                <th class="sortable">–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                                <th class="sortable">Username</th>
                                <th class="sortable" width="200">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                                <th class="sortable" width="150">–î–æ—Å—Ç—É–ø</th>
                                <th width="200">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="foremenTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- –í–∫–ª–∞–¥–∫–∞ –æ—Ç—á–µ—Ç–æ–≤ -->
            <div id="reports" class="tab-content">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞–º–∏</h2>
                
                <div class="toolbar">
                    <button id="addReport" class="success">‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç</button>
                    <button id="saveAllReports" class="secondary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                    <div class="search-box">
                        <input type="text" id="searchReports" placeholder="–ü–æ–∏—Å–∫ –ø–æ –æ—Ç—á–µ—Ç–∞–º...">
                    </div>
                </div>
                
                <div class="loading" id="reportsLoading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–æ–≤...</div>
                
                <div class="table-container">
                    <table id="reportsTable">
                        <thead>
                            <tr>
                                <th class="sortable" width="50">ID</th>
                                <th class="sortable" width="100">ID –±—Ä–∏–≥–∞–¥–∏—Ä–∞</th>
                                <th class="sortable" width="100">ID —Ä–∞–±–æ—Ç—ã</th>
                                <th class="sortable" width="100">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                <th class="sortable" width="120">–î–∞—Ç–∞</th>
                                <th class="sortable" width="120">–í—Ä–µ–º—è</th>
                                <th class="sortable">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ</th>
                                <th width="150">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ–π –≤–µ–¥–æ–º–æ—Å—Ç–∏ -->
            <div id="accumulative" class="tab-content">
                <h2>–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è –≤–µ–¥–æ–º–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç</h2>
                
                <div class="toolbar">
                    <button id="refreshAccumulative" class="secondary">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                    <button id="exportAccumulative" class="secondary">üì• –°–∫–∞—á–∞—Ç—å XLS</button>
                    <div class="dropdown" id="accumulativeForemanDropdown">
                        <button id="foremanFilterButton" class="secondary">üë∑ –í—Å–µ –±—Ä–∏–≥–∞–¥–∏—Ä—ã</button>
                        <div id="foremanDropdownMenu" class="dropdown-menu"></div>
                    </div>
                    <div class="search-box">
                    <input type="text" id="searchAccumulative" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º –∏–ª–∏ —Ä–∞–±–æ—Ç–µ...">
                    </div>
                </div>
                
                <div class="loading" id="accumulativeLoading">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ–π –≤–µ–¥–æ–º–æ—Å—Ç–∏...</div>
                
                <div class="table-container">
                    <table id="accumulativeTable">
                        <thead>
                            <tr>
                                <th class="sortable">–†–∞–∑–¥–µ–ª</th>
                                <th class="sortable">–†–∞–±–æ—Ç–∞</th>
                                <th class="sortable">–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</th>
                                <th class="sortable">–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É</th>
                                <th class="sortable">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                <th class="sortable">–ü—Ä–æ–µ–∫—Ç</th>
                                <th class="sortable">%–í—ã–ø–æ–ª–Ω–µ–Ω–∏—è</th>
                                <th class="sortable">–°—É–º–º–∞</th>
                            </tr>
                        </thead>
                        <tbody id="accumulativeTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- –í–∫–ª–∞–¥–∫–∞ –≤—Å–µ—Ö –æ—Ç—á–µ—Ç–æ–≤ -->
            <div id="all-reports" class="tab-content">
                <h2>–í—Å–µ –æ—Ç—á–µ—Ç—ã (—Å–≤–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)</h2>
                
                <div class="toolbar">
                    <button id="refreshAllReports" class="secondary">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                    <div class="search-box">
                        <input type="text" id="searchAllReports" placeholder="–ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –æ—Ç—á–µ—Ç–∞–º...">
                    </div>
                </div>
                
                <div class="loading" id="allReportsLoading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–æ–≤...</div>
                
                <div class="table-container">
                    <table id="allReportsTable">
                        <thead>
                            <tr>
                                <th class="sortable" width="50">ID</th>
                                <th class="sortable">–ë—Ä–∏–≥–∞–¥–∏—Ä</th>
                                <th class="sortable">–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                                <th class="sortable">–†–∞–±–æ—Ç–∞</th>
                                <th class="sortable" width="100">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                <th class="sortable" width="120">–î–∞—Ç–∞</th>
                                <th class="sortable" width="120">–í—Ä–µ–º—è</th>
                                <th class="sortable">–§–æ—Ç–æ</th>
                                <th width="150">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="allReportsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="waves"></div>
    </div>

    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API
        const API_CONFIG = {
        BASE_URL: 'https://build-report.ru/',
        ENDPOINTS: {
            WORKS: 'api/works',
            ALL_WORKS: 'api/all-works',
            MATERIALS: 'api/materials',
            MATERIALS_HISTORY: 'api/materials/history',
            MATERIALS_EXPORT: 'api/materials/export',
            MATERIALS_IMPORT: 'api/materials/import',
            MATERIALS_TEMPLATE: 'api/materials/template',
            FOREMEN: 'api/foremen',
            REPORTS: 'api/reports',
            ALL_REPORTS: 'api/all-reports',
            REPORT: 'api/report',
            LOGIN: 'api/site-login',
            CATEGORIES: 'api/categories',
            ACCUMULATIVE: 'api/accumulative-statement',
            WORK_REPORTS: 'api/work-reports'
        }
    };

    function buildApiUrl(endpoint) {
        if (!endpoint) {
            return API_CONFIG.BASE_URL;
        }

        if (/^https?:\/\//i.test(endpoint)) {
            return endpoint;
        }

        const normalizedBase = API_CONFIG.BASE_URL.replace(/\/+$/, '');
        const normalizedPath = String(endpoint).replace(/^\/+/, '');
        return `${normalizedBase}/${normalizedPath}`;
    }

    

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    let works = [];
    let availableReportWorks = [];
    let materials = [];
    let foremen = [];
    let reports = [];
    let allReports = [];
    let categories = [];
    let currentWorkIdForMaterials = null;
    let currentWorkMaterials = [];
    let currentWorkPricing = {
        unitCost: null,
        totalCost: null
    };
    let currentMaterialIdForQuantity = null;
    let currentMaterialQuantity = 0;
    let currentMaterialUnit = '';
    let currentMaterialIdForPricing = null;
    let currentMaterialPricing = {
        unitCost: null,
        totalCost: null
    };
    let materialHistory = [];
    let materialHistoryLoaded = false;
    let isMaterialHistoryView = false;
    let currentForemanIdForSections = null;
    let currentForemanSections = [];
    let currentEditingReportId = null;
    let accumulativeForemen = [];
    let selectedAccumulativeForemanId = null;

    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü
    const tableSortStates = new Map();

    const sortableTableConfigs = {
        worksTable: {
            columns: {
                1: { type: 'number' },
                2: { type: 'string' },
                3: { type: 'string' },
                4: { type: 'string' },
                5: { type: 'number' },
                6: { type: 'number' },
                7: { type: 'boolean' }
            },
            getRowId: (row) => {
                const input = row.querySelector('td:nth-child(2) input');
                return input ? parseInt(input.value, 10) : null;
            }
        },
        materialsTable: {
            columns: {
                0: { type: 'number' },
                1: { type: 'string' },
                2: { type: 'string' },
                3: { type: 'string' },
                4: { type: 'number' }
            },
            getRowId: (row) => {
                const input = row.querySelector('td:first-child input');
                return input ? parseInt(input.value, 10) : null;
            }
        },
        materialHistoryTable: {
            columns: {
                0: { type: 'number' },
                1: { type: 'string' },
                2: { type: 'string' },
                3: { type: 'number' },
                4: { type: 'number' },
                5: { type: 'string' },
                6: { type: 'string' },
                7: { type: 'date' }
            }
        },
        foremenTable: {
            columns: {
                0: { type: 'number' },
                1: { type: 'string' },
                2: { type: 'string' },
                3: { type: 'string' },
                4: { type: 'date' },
                5: { type: 'boolean' }
            },
            getRowId: (row) => {
                const input = row.querySelector('td:first-child input');
                return input ? parseInt(input.value, 10) : null;
            }
        },
        reportsTable: {
            columns: {
                0: { type: 'number' },
                1: { type: 'number' },
                2: { type: 'number' },
                3: { type: 'number' },
                4: { type: 'date' },
                5: { type: 'string' },
                6: { type: 'string' }
            }
        },
        accumulativeTable: {
            columns: {
                0: { type: 'string' },
                1: { type: 'string' },
                2: { type: 'string' },
                3: { type: 'number' },
                4: { type: 'number' },
                5: { type: 'number' },
                6: { type: 'number' },
                7: { type: 'number' },
                8: { type: 'number' },
                9: { type: 'number' }
            }
        },
        allReportsTable: {
            columns: {
                0: { type: 'number' },
                1: { type: 'string' },
                2: { type: 'string' },
                3: { type: 'string' },
                4: { type: 'number' },
                5: { type: 'date' },
                6: { type: 'string' },
                7: { type: 'string' }
            }
        }
    };

    function refreshTableSorting(tableId) {
        const config = sortableTableConfigs[tableId] || {};
        const columnConfigs = config.columns || {};
        const options = {};

        if (typeof config.getRowId === 'function') {
            options.getRowId = config.getRowId;
        }

        initializeSortableTable(tableId, columnConfigs, options);
    }

    function initializeSortableTable(tableId, columnConfigs = {}, options = {}) {
        const table = document.getElementById(tableId);
        if (!table) {
            return;
        }

        const tbody = table.querySelector('tbody');
        if (!tbody) {
            return;
        }

        const rows = Array.from(tbody.querySelectorAll('tr'));

        rows.forEach((row, index) => {
            if (typeof options.getRowId === 'function') {
                const rowId = options.getRowId(row, index);
                if (rowId !== null && rowId !== undefined && !Number.isNaN(rowId)) {
                    row.dataset.sortId = rowId;
                } else {
                    delete row.dataset.sortId;
                }
            } else {
                delete row.dataset.sortId;
            }
        });

        const state = {
            currentColumn: -1,
            direction: 0,
            columnConfigs,
            getRowId: options.getRowId,
            originalRows: rows.slice()
        };

        tableSortStates.set(tableId, state);

        const headers = table.querySelectorAll('th.sortable');
        headers.forEach(header => {
            header.dataset.tableId = tableId;
            header.dataset.columnIndex = header.cellIndex;
            header.classList.remove('sorted-asc', 'sorted-desc', 'sorted-default');

            if (header.dataset.sortListenerAttached !== 'true') {
                header.addEventListener('click', handleTableSortClick);
                header.dataset.sortListenerAttached = 'true';
            }
        });
    }

    function handleTableSortClick(event) {
        const header = event.currentTarget;
        const tableId = header.dataset.tableId;
        const columnIndex = parseInt(header.dataset.columnIndex, 10);

        if (Number.isNaN(columnIndex)) {
            return;
        }

        sortTable(tableId, columnIndex);
    }

    function sortTable(tableId, columnIndex) {
        const table = document.getElementById(tableId);
        if (!table) {
            return;
        }

        const tbody = table.querySelector('tbody');
        if (!tbody) {
            return;
        }

        const state = tableSortStates.get(tableId);
        if (!state) {
            return;
        }

        const rows = Array.from(tbody.querySelectorAll('tr'));
        const validRows = rows.filter(row => row.cells[columnIndex]);

        if (validRows.length <= 1) {
            return;
        }

        if (!state.originalRows || state.originalRows.length !== rows.length) {
            state.originalRows = rows.slice();
        }

        if (state.currentColumn !== columnIndex) {
            state.currentColumn = columnIndex;
            state.direction = 1;
        } else {
            if (state.direction === 0) {
                state.direction = 1;
            } else if (state.direction === 1) {
                state.direction = -1;
            } else {
                state.direction = 0;
            }
        }

        if (state.direction === 0) {
            state.originalRows.forEach(row => tbody.appendChild(row));
            updateSortIndicators(tableId, columnIndex, state.direction);
            tableSortStates.set(tableId, state);
            return;
        }

        const columnConfig = state.columnConfigs[columnIndex] || {};
        const sortedRows = validRows.slice().sort((a, b) =>
            compareTableCells(a, b, columnIndex, columnConfig, state.direction)
        );

        sortedRows.forEach(row => tbody.appendChild(row));

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å colspan)
        rows
            .filter(row => !validRows.includes(row))
            .forEach(row => tbody.appendChild(row));

        updateSortIndicators(tableId, columnIndex, state.direction);
        tableSortStates.set(tableId, state);
    }

    function compareTableCells(rowA, rowB, columnIndex, columnConfig, direction) {
        const cellA = rowA.cells[columnIndex];
        const cellB = rowB.cells[columnIndex];

        const valueA = getCellSortValue(cellA, columnConfig);
        const valueB = getCellSortValue(cellB, columnConfig);

        let result;

        switch (columnConfig.type) {
            case 'number':
                result = parseNumber(valueA) - parseNumber(valueB);
                break;
            case 'boolean':
                result = parseBoolean(valueA) - parseBoolean(valueB);
                break;
            case 'date':
                result = parseDate(valueA) - parseDate(valueB);
                break;
            default:
                result = String(valueA ?? '').localeCompare(String(valueB ?? ''), 'ru', {
                    sensitivity: 'base',
                    numeric: false
                });
        }

        if (result === 0) {
            const fallbackA = rowA.dataset && rowA.dataset.sortId
                ? parseInt(rowA.dataset.sortId, 10)
                : rowA.rowIndex;
            const fallbackB = rowB.dataset && rowB.dataset.sortId
                ? parseInt(rowB.dataset.sortId, 10)
                : rowB.rowIndex;
            result = fallbackA - fallbackB;
        }

        return result * direction;
    }

    function getCellSortValue(cell, columnConfig) {
        if (!cell) {
            return '';
        }

        if (columnConfig && typeof columnConfig.getValue === 'function') {
            return columnConfig.getValue(cell);
        }

        if (cell.dataset && cell.dataset.sortValue !== undefined) {
            return cell.dataset.sortValue;
        }

        const formElement = cell.querySelector('input, select, textarea');
        if (formElement) {
            return formElement.value;
        }

        return cell.textContent.trim();
    }

    function parseNumber(value) {
        if (typeof value === 'number') {
            return Number.isFinite(value) ? value : 0;
        }

        if (typeof value === 'string') {
            const normalized = value
                .replace(/\u00A0/g, ' ')
                .replace(/\s+/g, '')
                .replace(',', '.');
            const cleaned = normalized.replace(/[^0-9+\-\.]/g, '');
            const parsed = parseFloat(cleaned);
            return Number.isFinite(parsed) ? parsed : 0;
        }

        const numeric = Number(value);
        return Number.isFinite(numeric) ? numeric : 0;
    }

    function parseBoolean(value) {
        if (typeof value === 'boolean') {
            return value ? 1 : 0;
        }

        if (typeof value === 'number') {
            return value ? 1 : 0;
        }

        const normalized = String(value || '')
            .toLowerCase()
            .trim();

        if (['1', 'true', '–¥–∞', 'yes', '–∞–∫—Ç–∏–≤–Ω–æ', '‚úÖ –¥–æ—Å—Ç—É–ø–µ–Ω'].includes(normalized)) {
            return 1;
        }

        return 0;
    }

    function parseDate(value) {
        if (!value) {
            return 0;
        }

        if (value instanceof Date) {
            return value.getTime();
        }

        if (typeof value === 'number') {
            return value;
        }

        if (typeof value === 'string') {
            const normalized = value.replace(' ', 'T');
            const timestamp = Date.parse(normalized);
            return Number.isNaN(timestamp) ? 0 : timestamp;
        }

        return 0;
    }

    function updateSortIndicators(tableId, columnIndex, direction) {
        const table = document.getElementById(tableId);
        if (!table) {
            return;
        }

        const headers = table.querySelectorAll('th.sortable');
        headers.forEach(header => {
            header.classList.remove('sorted-asc', 'sorted-desc', 'sorted-default');
        });

        const targetHeader = Array.from(headers).find(header =>
            parseInt(header.dataset.columnIndex, 10) === columnIndex
        );

        if (!targetHeader) {
            return;
        }

        if (direction === 1) {
            targetHeader.classList.add('sorted-asc');
        } else if (direction === -1) {
            targetHeader.classList.add('sorted-desc');
        } else {
            targetHeader.classList.add('sorted-default');
        }
    }

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
    let currentWorkIdForBalance = null;
    let currentWorkBalance = 0;
    
    // –ü—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    const UNITS = ['—à—Ç', '–º', '–º¬≤', '–º¬≥', '–∫–≥', '—Ç', '–ª', '–ø.–º.', '–∫–æ–º–ø–ª–µ–∫—Ç'];

    // –§–£–ù–ö–¶–ò–ò –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò
    async function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const errorElement = document.getElementById('loginError');
        
        // –ë–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
        if (!username || !password) {
            errorElement.textContent = '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å';
            errorElement.style.display = 'block';
            return;
        }
        
        try {
            const response = await fetch(buildApiUrl(API_CONFIG.ENDPOINTS.LOGIN), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password })
            });

            if (!response.ok) {
                let errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';

                try {
                    const errorData = await response.json();

                    if (errorData?.error) {
                        errorMessage = errorData.error;
                    } else if (errorData?.detail) {
                        errorMessage = Array.isArray(errorData.detail)
                            ? errorData.detail.map(item => item.msg || item).join(', ')
                            : errorData.detail;
                    }
                } catch (parseError) {
                    console.error('Login error parse failed:', parseError);
                }

                errorElement.textContent = errorMessage;
                errorElement.style.display = 'block';
                document.getElementById('password').value = '';
                return;
            }

            const data = await response.json();
            
            if (data.success) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                localStorage.setItem('authenticated', 'true');
                localStorage.setItem('user', JSON.stringify(data.user));
                localStorage.setItem('token', data.token || '');
                
                // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                initializeApp();
            } else {
                errorElement.textContent = data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                errorElement.style.display = 'block';
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–∞—Ä–æ–ª—è
                document.getElementById('password').value = '';
            }
        } catch (error) {
            console.error('Login error:', error);
            errorElement.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É';
            errorElement.style.display = 'block';
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–∞—Ä–æ–ª—è
            document.getElementById('password').value = '';
        }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function checkAuth() {
        const isAuthenticated = localStorage.getItem('authenticated') === 'true';
        
        if (isAuthenticated) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å—Ç–µ–∫ –ª–∏ —Ç–æ–∫–µ–Ω (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            if (token && user) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                initializeApp();
            } else {
                // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
                showLoginForm();
            }
        } else {
            showLoginForm();
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞
    function showLoginForm() {
        document.getElementById('loginOverlay').style.display = 'flex';
        document.getElementById('mainContent').style.display = 'none';
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('loginError').style.display = 'none';
        
        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –ª–æ–≥–∏–Ω–∞
        document.getElementById('username').focus();
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞
    function logout() {
        localStorage.removeItem('authenticated');
        localStorage.removeItem('user');
        localStorage.removeItem('token');
        showLoginForm();
    }

    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø API –ó–ê–ü–†–û–°–û–í
    async function makeApiRequest(endpoint, options = {}) {
        const token = localStorage.getItem('token');

        const headers = {
            'Content-Type': 'application/json',
            ...options.headers
        };

        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        
        try {
            const url = buildApiUrl(endpoint);
            const response = await fetch(url, {
                headers,
                ...options
            });
            
            if (response.status === 401) {
                logout();
                return { success: false, error: '–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞' };
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω—ã–π
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`API Error: ${response.status} - ${errorText}`);
                return { 
                    success: false, 
                    error: `HTTP ${response.status}: ${errorText || 'Unknown error'}` 
                };
            }
            
            const data = await response.json();
            return data;
            
        } catch (error) {
            console.error('API Request failed:', error);
            return { 
                success: false, 
                error: `Network error: ${error.message}` 
            };
        }
    }

    function getCurrentUsername() {
        try {
            const userRaw = localStorage.getItem('user');
            if (!userRaw) {
                return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            }
            const user = JSON.parse(userRaw);
            return user?.username || user?.login || user?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        } catch (error) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        }
    }


    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ —Ñ–æ—Ä–º–µ –≤—Ö–æ–¥–∞
    document.addEventListener('DOMContentLoaded', function() {
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
        document.getElementById('username').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
        
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        checkAuth();
    });

    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    function initializeApp() {
        initializeTabs();
        initializeWorksTab();
        initializeWorkMaterialsModal();
        initializeMaterialPricingModal();
        initializeMaterialsTab();
        initializeForemenTab();
        initializeReportsTab();
        initializeAllReportsTab();
        initializeSendReportFeature();
        initializeEditReportFeature();
        initializeAccumulativeTab();

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        loadWorks();
        loadMaterials();
        loadForemen();
        loadReports();
        loadAllReports();
        loadCategories();
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–æ–∫
    function initializeTabs() {
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
                tabs.forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
                this.classList.add('active');
                document.getElementById(tabId).classList.add('active');

                // –ó–∞–≥—Ä—É–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏
                if (tabId === 'accumulative') {
                    loadAccumulativeStatement();
                } else if (tabId === 'materials') {
                    loadMaterials();
                }
            });
        });
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–∫–∏ —Ä–∞–±–æ—Ç
    function initializeWorksTab() {
        document.getElementById('addWork').addEventListener('click', addNewWork);
        document.getElementById('addCategory').addEventListener('click', openCategoryModal);
        document.getElementById('saveAllWorks').addEventListener('click', saveAllWorks);
        document.getElementById('searchWorks').addEventListener('input', filterWorks);

        document.getElementById('exportWorks').addEventListener('click', exportWorksToExcel);
        document.getElementById('importWorks').addEventListener('click', triggerImportWorks);
        document.getElementById('importFileInput').addEventListener('change', handleWorksImport);
    }

    function initializeWorkMaterialsModal() {
        const addButton = document.getElementById('workMaterialAddButton');
        if (addButton) {
            addButton.addEventListener('click', event => {
                event.preventDefault();
                addMaterialToWorkList();
            });
        }

        const pricingInputs = [
            { id: 'workPriceUnit', field: 'unitCost' },
            { id: 'workPriceTotal', field: 'totalCost' }
        ];

        pricingInputs.forEach(({ id, field }) => {
            const input = document.getElementById(id);
            if (!input) return;

            input.addEventListener('input', event => {
                handlePricingInput(field, event.target.value);
                updateWorkPricingInputs(id);
            });

            input.addEventListener('blur', () => {
                updateWorkPricingInputs();
            });
        });

        // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ–Ω
        const modal = document.getElementById('workMaterialsModal');
        if (modal) {
            modal.addEventListener('click', event => {
                if (event.target === modal) {
                    event.stopPropagation();
                }
            });
        }
    }

    function initializeMaterialPricingModal() {
        const pricingInputs = [
            { id: 'materialPriceUnit', field: 'unitCost' },
            { id: 'materialPriceTotal', field: 'totalCost' }
        ];

        pricingInputs.forEach(({ id, field }) => {
            const input = document.getElementById(id);
            if (!input) return;

            input.addEventListener('input', event => {
                handleMaterialPricingInput(field, event.target.value);
                updateMaterialPricingInputs(id);
            });

            input.addEventListener('blur', () => {
                updateMaterialPricingInputs();
            });
        });

        const saveButton = document.getElementById('materialPricingSaveButton');
        if (saveButton) {
            saveButton.addEventListener('click', event => {
                event.preventDefault();
                saveMaterialPricing();
            });
        }

        const modal = document.getElementById('materialPricingModal');
        if (modal) {
            modal.addEventListener('click', event => {
                if (event.target === modal) {
                    event.stopPropagation();
                }
            });
        }
    }

    function initializeMaterialsTab() {
        const addMaterialBtn = document.getElementById('addMaterial');
        const exportMaterialsBtn = document.getElementById('exportMaterials');
        const importMaterialsBtn = document.getElementById('importMaterials');
        const toggleHistoryBtn = document.getElementById('toggleMaterialsHistory');
        const importInput = document.getElementById('materialsImportInput');
        const searchInput = document.getElementById('searchMaterials');

        if (addMaterialBtn) addMaterialBtn.addEventListener('click', addNewMaterial);
        if (exportMaterialsBtn) exportMaterialsBtn.addEventListener('click', exportMaterialsToExcel);
        if (importMaterialsBtn) importMaterialsBtn.addEventListener('click', triggerImportMaterials);
        if (toggleHistoryBtn) toggleHistoryBtn.addEventListener('click', toggleMaterialHistoryView);
        if (importInput) importInput.addEventListener('change', handleMaterialsImport);
        if (searchInput) searchInput.addEventListener('input', filterMaterials);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–∫–∏ –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤
    function initializeForemenTab() {
        document.getElementById('saveAllForemen').addEventListener('click', saveAllForemen);
        document.getElementById('searchForemen').addEventListener('input', filterForemen);
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–∫–∏ –æ—Ç—á–µ—Ç–æ–≤
    function initializeReportsTab() {
        document.getElementById('addReport').addEventListener('click', addNewReport);
        document.getElementById('saveAllReports').addEventListener('click', saveAllReports);
        document.getElementById('searchReports').addEventListener('input', filterReports);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–∫–∏ –≤—Å–µ—Ö –æ—Ç—á–µ—Ç–æ–≤
    function initializeAllReportsTab() {
        document.getElementById('refreshAllReports').addEventListener('click', loadAllReports);
        document.getElementById('searchAllReports').addEventListener('input', filterAllReports);
    }

    function initializeSendReportFeature() {
        const openButton = document.getElementById('openSendReportModal');
        if (openButton) {
            openButton.addEventListener('click', () => {
                openSendReportModal();
            });
        }

        // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ–Ω
        const modal = document.getElementById('sendReportModal');
        if (modal) {
            modal.addEventListener('click', event => {
                if (event.target === modal) {
                    event.stopPropagation();
                }
            });
        }

        const form = document.getElementById('sendReportForm');
        if (form) {
            form.addEventListener('submit', submitSendReport);
        }

        const addWorkButton = document.getElementById('addReportWorkButton');
        if (addWorkButton) {
            addWorkButton.addEventListener('click', () => addReportWorkItem());
        }
    }

    async function openSendReportModal() {
        const modal = document.getElementById('sendReportModal');
        if (!modal) return;

        try {
            if (!Array.isArray(foremen) || foremen.length === 0) {
                await loadForemen();
            }
        } catch (error) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –æ—Ç—á–µ—Ç–∞:', error);
        }

        try {
            if (!Array.isArray(works) || works.length === 0) {
                await loadWorks();
            }
        } catch (error) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –æ—Ç—á–µ—Ç–∞:', error);
        }

        const availability = populateSendReportOptions();
        resetSendReportForm();
        updateSendReportAvailabilityMessage(availability);

        const submitButton = document.getElementById('submitReportButton');
        if (submitButton) {
            submitButton.disabled = !(availability.hasForemen && availability.hasWorks);
        }

        modal.style.display = 'flex';
    }

    function closeSendReportModal() {
        const modal = document.getElementById('sendReportModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    function updateReportWorkSelectOptions(selectElement, selectedValue) {
        if (!selectElement) return;

        const currentValue = selectedValue !== undefined ? selectedValue : selectElement.value;
        const options = ['<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É</option>'];

        availableReportWorks.forEach(item => {
            const sectionName = item['–†–∞–∑–¥–µ–ª'] || item['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'] || '';
            const categoryLabel = sectionName ? ` ‚Äî ${sectionName}` : '';
            options.push(`<option value="${item.id}">${item['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã'] || item.id}${categoryLabel}</option>`);
        });

        selectElement.innerHTML = options.join('');

        if (currentValue) {
            selectElement.value = String(currentValue);
            if (selectElement.value !== String(currentValue)) {
                selectElement.value = '';
            }
        }

        selectElement.disabled = availableReportWorks.length === 0;
    }

    function updateReportWorkItemDetails(itemElement) {
        if (!itemElement) return;

        const selectElement = itemElement.querySelector('.report-work-select');
        const detailsElement = itemElement.querySelector('.report-work-details');
        const unitElement = itemElement.querySelector('.report-work-unit');
        const quantityInput = itemElement.querySelector('.report-work-quantity');

        const workId = selectElement ? parseInt(selectElement.value, 10) : NaN;
        if (!Number.isInteger(workId)) {
            if (detailsElement) {
                detailsElement.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å –∏ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è.';
            }
            if (unitElement) {
                unitElement.textContent = '';
            }
            if (quantityInput) {
                quantityInput.placeholder = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ';
            }
            return;
        }

        const work = Array.isArray(works) ? works.find(item => item && item.id === workId) : null;
        if (!work) {
            if (detailsElement) {
                detailsElement.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ.';
            }
            if (unitElement) {
                unitElement.textContent = '';
            }
            if (quantityInput) {
                quantityInput.placeholder = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ';
            }
            return;
        }

        const unit = work['–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è'] || '—à—Ç';
        const balanceRaw = work['–ù–∞ –±–∞–ª–∞–Ω—Å–µ'];
        const balanceNumber = typeof balanceRaw === 'number' ? balanceRaw : parseFloat(balanceRaw) || 0;
        const formattedBalance = Number.isFinite(balanceNumber)
            ? balanceNumber.toLocaleString('ru-RU', { maximumFractionDigits: 2 })
            : balanceRaw;
        const category = work['–†–∞–∑–¥–µ–ª'] || work['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'] || '‚Äî';

        if (detailsElement) {
            detailsElement.textContent = `–†–∞–∑–¥–µ–ª: ${category} ‚Ä¢ –ù–∞ –±–∞–ª–∞–Ω—Å–µ: ${formattedBalance} ${unit}`;
        }

        if (unitElement) {
            unitElement.textContent = unit;
        }

        if (quantityInput) {
            quantityInput.placeholder = `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (${unit})`;
        }
    }

    function updateRemoveReportWorkButtonsState() {
        const container = document.getElementById('reportWorksContainer');
        if (!container) return;

        const items = Array.from(container.querySelectorAll('.report-work-item'));
        const shouldDisable = items.length <= 1;

        items.forEach(item => {
            const button = item.querySelector('.remove-report-work-button');
            if (button) {
                button.disabled = shouldDisable;
                button.style.display = shouldDisable ? 'none' : '';
            }
        });
    }

    function removeReportWorkItem(itemElement) {
        const container = document.getElementById('reportWorksContainer');
        if (!container || !itemElement) return;

        container.removeChild(itemElement);
        updateRemoveReportWorkButtonsState();
    }

    function addReportWorkItem(selectedWorkId) {
        const container = document.getElementById('reportWorksContainer');
        if (!container) return;

        const itemElement = document.createElement('div');
        itemElement.className = 'report-work-item';

        const selectElement = document.createElement('select');
        selectElement.className = 'report-work-select';
        selectElement.required = true;
        updateReportWorkSelectOptions(selectElement, selectedWorkId);
        selectElement.addEventListener('change', () => updateReportWorkItemDetails(itemElement));

        const quantityWrapper = document.createElement('div');
        quantityWrapper.className = 'quantity-input-wrapper';

        const quantityInput = document.createElement('input');
        quantityInput.type = 'number';
        quantityInput.min = '0';
        quantityInput.step = '0.01';
        quantityInput.placeholder = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ';
        quantityInput.required = true;
        quantityInput.className = 'report-work-quantity';

        const unitElement = document.createElement('span');
        unitElement.className = 'report-work-unit';

        quantityWrapper.appendChild(quantityInput);
        quantityWrapper.appendChild(unitElement);

        const detailsElement = document.createElement('p');
        detailsElement.className = 'modal-note report-work-details';
        detailsElement.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å –∏ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è.';

        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.className = 'secondary remove-report-work-button';
        removeButton.textContent = '–£–¥–∞–ª–∏—Ç—å';
        removeButton.addEventListener('click', () => removeReportWorkItem(itemElement));

        itemElement.appendChild(selectElement);
        itemElement.appendChild(quantityWrapper);
        itemElement.appendChild(detailsElement);
        itemElement.appendChild(removeButton);

        container.appendChild(itemElement);

        updateReportWorkItemDetails(itemElement);
        updateRemoveReportWorkButtonsState();
    }

    function resetSendReportForm() {
        const form = document.getElementById('sendReportForm');
        if (form) {
            form.reset();
        }

        const now = new Date();
        const dateInput = document.getElementById('reportDate');
        const timeInput = document.getElementById('reportTime');

        if (dateInput) {
            dateInput.value = now.toISOString().slice(0, 10);
        }

        if (timeInput) {
            timeInput.value = now.toTimeString().slice(0, 8);
        }

        const container = document.getElementById('reportWorksContainer');
        if (container) {
            container.innerHTML = '';
            addReportWorkItem();
        }

        const addButton = document.getElementById('addReportWorkButton');
        if (addButton) {
            addButton.disabled = availableReportWorks.length === 0;
        }

        updateRemoveReportWorkButtonsState();
    }

    function populateSendReportOptions() {
        const foremanSelect = document.getElementById('reportForemanSelect');

        let hasForemen = false;
        let hasWorks = false;

        if (foremanSelect) {
            const availableForemen = (Array.isArray(foremen) ? foremen : [])
                .filter(item => item && (item.is_active === undefined || item.is_active));

            if (availableForemen.length > 0) {
                const options = ['<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–∏–≥–∞–¥–∏—Ä–∞</option>'].concat(
                    availableForemen
                        .slice()
                        .sort((a, b) => (a.full_name || '').localeCompare(b.full_name || ''))
                        .map(item => {
                            const position = item.position ? ` ‚Ä¢ ${item.position}` : '';
                            return `<option value="${item.id}">${item.full_name || item.id}${position}</option>`;
                        })
                );
                foremanSelect.innerHTML = options.join('');
                foremanSelect.disabled = false;
                hasForemen = true;
            } else {
                foremanSelect.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤</option>';
                foremanSelect.disabled = true;
            }
        }

        availableReportWorks = (Array.isArray(works) ? works : [])
            .filter(item => item && (item.is_active === undefined ? true : Boolean(item.is_active)))
            .slice()
            .sort((a, b) => (a['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã'] || '').localeCompare(b['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã'] || ''));

        hasWorks = availableReportWorks.length > 0;

        const container = document.getElementById('reportWorksContainer');
        if (container) {
            container.querySelectorAll('.report-work-select').forEach(select => {
                updateReportWorkSelectOptions(select);
                const itemElement = select.closest('.report-work-item');
                if (itemElement) {
                    updateReportWorkItemDetails(itemElement);
                }
            });
        }

        const addButton = document.getElementById('addReportWorkButton');
        if (addButton) {
            addButton.disabled = !hasWorks;
        }

        return { hasForemen, hasWorks };
    }

    function updateSendReportAvailabilityMessage(availability) {
        const messageElement = document.getElementById('sendReportAvailabilityMessage');
        if (!messageElement) return;

        if (!availability.hasForemen && !availability.hasWorks) {
            messageElement.textContent = '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤ –∏ —Ä–∞–±–æ—Ç. –î–æ–±–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç.';
            messageElement.style.display = 'block';
            return;
        }

        if (!availability.hasForemen) {
            messageElement.textContent = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –∏–ª–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ –±—Ä–∏–≥–∞–¥–∏—Ä–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ë—Ä–∏–≥–∞–¥–∏—Ä—ã¬ª.';
            messageElement.style.display = 'block';
            return;
        }

        if (!availability.hasWorks) {
            messageElement.textContent = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞–±–æ—Ç. –î–æ–±–∞–≤—å—Ç–µ —Ä–∞–±–æ—Ç—É –∏–ª–∏ –≤–∫–ª—é—á–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–†–∞–±–æ—Ç—ã –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã¬ª.';
            messageElement.style.display = 'block';
            return;
        }

        messageElement.textContent = '';
        messageElement.style.display = 'none';
    }

    async function submitSendReport(event) {
        event.preventDefault();

        const foremanSelect = document.getElementById('reportForemanSelect');
        const dateInput = document.getElementById('reportDate');
        const timeInput = document.getElementById('reportTime');
        const container = document.getElementById('reportWorksContainer');
        const submitButton = document.getElementById('submitReportButton');

        if (submitButton) {
            submitButton.disabled = true;
        }

        try {
            const foremanIdValue = foremanSelect ? parseInt(foremanSelect.value, 10) : NaN;

            if (!Number.isInteger(foremanIdValue)) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–∏–≥–∞–¥–∏—Ä–∞ –¥–ª—è –æ—Ç—á–µ—Ç–∞', 'error');
                return;
            }

            const now = new Date();
            const reportDate = (dateInput && dateInput.value) ? dateInput.value : now.toISOString().slice(0, 10);
            let reportTime = (timeInput && timeInput.value) ? timeInput.value : now.toTimeString().slice(0, 8);
            if (reportTime.length === 5) {
                reportTime += ':00';
            }

            const workItems = container ? Array.from(container.querySelectorAll('.report-work-item')) : [];
            if (workItems.length === 0) {
                showNotification('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ä–∞–±–æ—Ç—É –¥–ª—è –æ—Ç—á–µ—Ç–∞', 'error');
                return;
            }

            const worksPayload = [];
            const usedWorkIds = new Set();

            for (const item of workItems) {
                const selectElement = item.querySelector('.report-work-select');
                const quantityInput = item.querySelector('.report-work-quantity');

                const workIdValue = selectElement ? parseInt(selectElement.value, 10) : NaN;
                const quantityValue = quantityInput ? parseFloat(String(quantityInput.value).replace(',', '.')) : NaN;

                if (!Number.isInteger(workIdValue)) {
                    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ—Ç—á–µ—Ç–∞', 'error');
                    return;
                }

                if (usedWorkIds.has(workIdValue)) {
                    showNotification('–ö–∞–∂–¥–∞—è —Ä–∞–±–æ—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã–±—Ä–∞–Ω–∞ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑', 'error');
                    return;
                }

                if (!Number.isFinite(quantityValue) || quantityValue <= 0) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏', 'error');
                    return;
                }

                usedWorkIds.add(workIdValue);
                worksPayload.push({ work_id: workIdValue, quantity: quantityValue });
            }

            if (worksPayload.length === 0) {
                showNotification('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ä–∞–±–æ—Ç—É –¥–ª—è –æ—Ç—á–µ—Ç–∞', 'error');
                return;
            }

            const payload = {
                foreman_id: foremanIdValue,
                report_date: reportDate,
                report_time: reportTime,
                works: worksPayload
            };

            const response = await makeApiRequest(API_CONFIG.ENDPOINTS.WORK_REPORTS, {
                method: 'POST',
                body: JSON.stringify(payload)
            });

            if (!response || !response.success) {
                const errorMessage = response?.error || response?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç';
                showNotification(errorMessage, 'error');
                return;
            }

            showNotification('–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
            closeSendReportModal();

            await loadWorks();
            await loadAllReports();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç—á–µ—Ç–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç—á–µ—Ç–∞: ' + error.message, 'error');
        } finally {
            if (submitButton) {
                submitButton.disabled = false;
            }
        }
    }

    function initializeEditReportFeature() {
        // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ–Ω
        const modal = document.getElementById('editReportModal');
        if (modal) {
            modal.addEventListener('click', event => {
                if (event.target === modal) {
                    event.stopPropagation();
                }
            });
        }

        const cancelButton = document.getElementById('cancelEditReportButton');
        if (cancelButton) {
            cancelButton.addEventListener('click', closeEditReportModal);
        }

        const workSelect = document.getElementById('editReportWorkSelect');
        if (workSelect) {
            workSelect.addEventListener('change', () => {
                const selectedId = parseInt(workSelect.value, 10);
                updateEditReportWorkDetails(Number.isInteger(selectedId) ? selectedId : null);
            });
        }

        const form = document.getElementById('editReportForm');
        if (form) {
            form.addEventListener('submit', submitEditReportForm);
        }
    }

    function showEditReportError(message) {
        const errorElement = document.getElementById('editReportError');
        if (!errorElement) {
            return;
        }

        if (message) {
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        } else {
            errorElement.textContent = '';
            errorElement.style.display = 'none';
        }
    }

    function closeEditReportModal() {
        const modal = document.getElementById('editReportModal');
        if (modal) {
            modal.style.display = 'none';
        }

        const form = document.getElementById('editReportForm');
        if (form) {
            form.reset();
        }

        showEditReportError('');
        currentEditingReportId = null;

        const unitElement = document.getElementById('editReportWorkUnit');
        if (unitElement) {
            unitElement.textContent = '';
        }

        const detailsElement = document.getElementById('editReportWorkDetails');
        if (detailsElement) {
            detailsElement.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏.';
        }
    }

    function populateEditReportForemanSelect(selectedId) {
        const select = document.getElementById('editReportForemanSelect');
        if (!select) {
            return;
        }

        const availableForemen = (Array.isArray(foremen) ? foremen : [])
            .filter(item => item && (item.is_active === undefined || item.is_active));

        if (availableForemen.length === 0) {
            select.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤</option>';
            select.disabled = true;
            return;
        }

        const options = ['<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–∏–≥–∞–¥–∏—Ä–∞</option>'].concat(
            availableForemen
                .slice()
                .sort((a, b) => (a.full_name || '').localeCompare(b.full_name || ''))
                .map(item => {
                    const position = item.position ? ` ‚Ä¢ ${item.position}` : '';
                    return `<option value="${item.id}">${item.full_name || item.id}${position}</option>`;
                })
        );

        select.innerHTML = options.join('');
        select.disabled = false;

        if (selectedId) {
            select.value = String(selectedId);
            if (select.value !== String(selectedId)) {
                select.value = '';
            }
        }
    }

    function populateEditReportWorkSelect(selectedId) {
        const select = document.getElementById('editReportWorkSelect');
        if (!select) {
            return;
        }

        const availableWorks = (Array.isArray(works) ? works : [])
            .filter(item => item && (item.is_active === undefined ? true : Boolean(item.is_active)));

        if (availableWorks.length === 0) {
            select.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–∞–±–æ—Ç</option>';
            select.disabled = true;
            return;
        }

        const options = ['<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É</option>'].concat(
            availableWorks
                .slice()
                .sort((a, b) => (a['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã'] || '').localeCompare(b['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã'] || ''))
                .map(item => {
                    const sectionName = item['–†–∞–∑–¥–µ–ª'] || item['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'] || '';
                    const category = sectionName ? ` ‚Ä¢ ${sectionName}` : '';
                    return `<option value="${item.id}">${item['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã'] || item.id}${category}</option>`;
                })
        );

        select.innerHTML = options.join('');
        select.disabled = false;

        if (selectedId) {
            select.value = String(selectedId);
            if (select.value !== String(selectedId)) {
                select.value = '';
            }
        }
    }

    function updateEditReportWorkDetails(workId) {
        const detailsElement = document.getElementById('editReportWorkDetails');
        const unitElement = document.getElementById('editReportWorkUnit');
        const quantityInput = document.getElementById('editReportQuantity');

        if (!Number.isInteger(workId)) {
            if (detailsElement) {
                detailsElement.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏.';
            }
            if (unitElement) {
                unitElement.textContent = '';
            }
            if (quantityInput) {
                quantityInput.placeholder = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ';
            }
            return;
        }

        const work = Array.isArray(works) ? works.find(item => item && item.id === workId) : null;
        if (!work) {
            if (detailsElement) {
                detailsElement.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ.';
            }
            if (unitElement) {
                unitElement.textContent = '';
            }
            if (quantityInput) {
                quantityInput.placeholder = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ';
            }
            return;
        }

        const unit = work['–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è'] || '—à—Ç';
        const balanceRaw = work['–ù–∞ –±–∞–ª–∞–Ω—Å–µ'];
        const balanceNumber = typeof balanceRaw === 'number' ? balanceRaw : parseFloat(balanceRaw);
        const formattedBalance = Number.isFinite(balanceNumber)
            ? balanceNumber.toLocaleString('ru-RU', { maximumFractionDigits: 2 })
            : (balanceRaw || '0');
        const category = work['–†–∞–∑–¥–µ–ª'] || work['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'] || '‚Äî';

        if (detailsElement) {
            detailsElement.textContent = `–†–∞–∑–¥–µ–ª: ${category} ‚Ä¢ –ù–∞ –±–∞–ª–∞–Ω—Å–µ: ${formattedBalance} ${unit}`;
        }

        if (unitElement) {
            unitElement.textContent = unit;
        }

        if (quantityInput) {
            quantityInput.placeholder = `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (${unit})`;
        }
    }

    async function editReport(reportId) {
        const modal = document.getElementById('editReportModal');
        if (!modal) {
            showNotification('–û–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ', 'error');
            return;
        }

        showEditReportError('');
        currentEditingReportId = reportId;

        const saveButton = document.getElementById('saveEditReportButton');
        if (saveButton) {
            saveButton.disabled = true;
        }

        try {
            if (!Array.isArray(foremen) || foremen.length === 0) {
                await loadForemen();
            }

            if (!Array.isArray(works) || works.length === 0) {
                await loadWorks();
            }
        } catch (error) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—Ç—á–µ—Ç–∞:', error);
        }

        populateEditReportForemanSelect(null);
        populateEditReportWorkSelect(null);
        updateEditReportWorkDetails(null);

        try {
            const response = await makeApiRequest(`${API_CONFIG.ENDPOINTS.REPORT}/${reportId}`);

            if (!response || !response.success || !response.data) {
                const errorMessage = response?.error || response?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞';
                showNotification(errorMessage, 'error');
                currentEditingReportId = null;
                return;
            }

            const reportData = response.data;

            populateEditReportForemanSelect(reportData.foreman_id);
            populateEditReportWorkSelect(reportData.work_id);

            const workId = Number.isInteger(reportData.work_id) ? reportData.work_id : parseInt(reportData.work_id, 10);
            updateEditReportWorkDetails(Number.isInteger(workId) ? workId : null);

            const quantityInput = document.getElementById('editReportQuantity');
            if (quantityInput) {
                quantityInput.value = reportData.quantity ?? '';
            }

            const dateInput = document.getElementById('editReportDate');
            if (dateInput) {
                dateInput.value = reportData.report_date || '';
            }

            const timeInput = document.getElementById('editReportTime');
            if (timeInput) {
                const timeValue = (reportData.report_time || '').toString();
                timeInput.value = timeValue.length > 8 ? timeValue.slice(0, 8) : timeValue;
            }

            const photoInput = document.getElementById('editReportPhoto');
            if (photoInput) {
                photoInput.value = reportData.photo_report_url || '';
            }

            const foremanSelect = document.getElementById('editReportForemanSelect');
            if (foremanSelect && reportData.foreman_id) {
                foremanSelect.value = String(reportData.foreman_id);
                if (foremanSelect.value !== String(reportData.foreman_id)) {
                    foremanSelect.value = '';
                }
            }

            const workSelect = document.getElementById('editReportWorkSelect');
            if (workSelect && reportData.work_id) {
                workSelect.value = String(reportData.work_id);
                if (workSelect.value !== String(reportData.work_id)) {
                    workSelect.value = '';
                }
            }

            modal.style.display = 'flex';
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ç—á–µ—Ç–∞: ' + error.message, 'error');
            currentEditingReportId = null;
        } finally {
            if (saveButton) {
                saveButton.disabled = false;
            }
        }
    }

    async function submitEditReportForm(event) {
        event.preventDefault();

        if (!currentEditingReportId) {
            showNotification('–û—Ç—á–µ—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω', 'error');
            return;
        }

        const foremanSelect = document.getElementById('editReportForemanSelect');
        const workSelect = document.getElementById('editReportWorkSelect');
        const quantityInput = document.getElementById('editReportQuantity');
        const dateInput = document.getElementById('editReportDate');
        const timeInput = document.getElementById('editReportTime');
        const photoInput = document.getElementById('editReportPhoto');
        const saveButton = document.getElementById('saveEditReportButton');

        const foremanId = foremanSelect ? parseInt(foremanSelect.value, 10) : NaN;
        const workId = workSelect ? parseInt(workSelect.value, 10) : NaN;
        const quantityValue = quantityInput ? parseFloat(quantityInput.value) : NaN;
        const reportDate = dateInput ? dateInput.value : '';
        const reportTime = timeInput ? timeInput.value : '';
        const photoUrl = photoInput ? photoInput.value.trim() : '';

        if (!Number.isInteger(foremanId)) {
            showEditReportError('–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–∏–≥–∞–¥–∏—Ä–∞');
            return;
        }

        if (!Number.isInteger(workId)) {
            showEditReportError('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É');
            return;
        }

        if (!Number.isFinite(quantityValue) || quantityValue <= 0) {
            showEditReportError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–±–æ–ª—å—à–µ 0)');
            return;
        }

        if (!reportDate) {
            showEditReportError('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –æ—Ç—á–µ—Ç–∞');
            return;
        }

        if (!reportTime) {
            showEditReportError('–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –æ—Ç—á–µ—Ç–∞');
            return;
        }

        showEditReportError('');

        const payload = {
            foreman_id: foremanId,
            work_id: workId,
            quantity: quantityValue,
            report_date: reportDate,
            report_time: reportTime
        };

        if (photoUrl) {
            payload.photo_report_url = photoUrl;
        }

        if (saveButton) {
            saveButton.disabled = true;
        }

        try {
            const response = await makeApiRequest(`${API_CONFIG.ENDPOINTS.REPORT}/${currentEditingReportId}`, {
                method: 'PUT',
                body: JSON.stringify(payload)
            });

            if (!response || !response.success) {
                const errorMessage = response?.error || response?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞';
                showEditReportError(errorMessage);
                return;
            }

            const successMessage = response.message || '–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω';
            showNotification(successMessage, 'success');
            closeEditReportModal();

            await loadWorks();
            await loadAllReports();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞:', error);
            showEditReportError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞: ' + error.message);
        } finally {
            if (saveButton) {
                saveButton.disabled = false;
            }
        }
    }

    // ========== –†–ê–ë–û–¢–´ ==========

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–±–æ—Ç
    async function loadWorks() {
        const loadingElement = document.getElementById('worksLoading');
        const tableBody = document.getElementById('worksTableBody');
        
        loadingElement.style.display = 'block';
        tableBody.innerHTML = '';
        
        try {
            const data = await makeApiRequest('/api/all-works');
            
            if (data.success) {
                works = data.data || [];
                displayWorks(works);
            } else {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞–±–æ—Ç: ' + data.error, 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞–±–æ—Ç: ' + error.message, 'error');
        } finally {
            loadingElement.style.display = 'none';
        }
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç
    function displayWorks(worksToDisplay) {
        const tableBody = document.getElementById('worksTableBody');
        tableBody.innerHTML = '';
        
        if (worksToDisplay.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞–±–æ—Ç–∞—Ö</td></tr>';
            refreshTableSorting('worksTable');
            return;
        }
        
        worksToDisplay.forEach(work => {
            const sectionName = work.–†–∞–∑–¥–µ–ª || work['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'] || '';
            const categoryOptions = categories.map(cat =>
                `<option value="${cat.name}" ${cat.name === sectionName ? 'selected' : ''}>${cat.name}</option>`
            ).join('');
            const fallbackCategoryOption = sectionName && !categories.find(c => c.name === sectionName)
                ? `<option value="${sectionName}" selected>${sectionName}</option>`
                : '';
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="checkbox-cell">
                    <input type="checkbox" class="work-checkbox" value="${work.id}">
                </td>
                <td><input type="text" value="${work.id}" readonly></td>
                <td>
                    <select class="editable" data-field="category">
                        ${categoryOptions}
                        ${fallbackCategoryOption}
                    </select>
                </td>
                <td><input type="text" value="${work['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã']}" class="editable" data-field="name"></td>
                <td>
                    <select class="editable" data-field="unit">
                        ${UNITS.map(unit => 
                            `<option value="${unit}" ${unit === work['–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è'] ? 'selected' : ''}>${unit}</option>`
                        ).join('')}
                        <option value="${work['–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è']}" ${!UNITS.includes(work['–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è']) ? 'selected' : ''}>${work['–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è']}</option>
                    </select>
                </td>
                <td><input type="number" value="${work['–ù–∞ –±–∞–ª–∞–Ω—Å–µ']}" class="editable" data-field="balance" step="1"></td>
                <td><input type="number" value="${work['–ü—Ä–æ–µ–∫—Ç'] || 0}" class="editable" data-field="project_total" step="1"></td>
                <td>
                    <select class="editable" data-field="is_active">
                        <option value="1" ${work.is_active ? 'selected' : ''}>–î–∞</option>
                        <option value="0" ${!work.is_active ? 'selected' : ''}>–ù–µ—Ç</option>
                    </select>
                </td>
                <td class="action-buttons">
                    <button onclick="saveWork(${work.id})" class="secondary">üíæ</button>
                    <button onclick="openWorkMaterials(${work.id})" class="secondary" title="–ú–∞—Ç–µ—Ä–∏–∞–ª—ã —Ä–∞–±–æ—Ç—ã">üßæ</button>
                    <button onclick="addBalance(${work.id})" class="success" title="–î–æ–±–∞–≤–∏—Ç—å –∫ –±–∞–ª–∞–Ω—Å—É">‚ûï</button>
                    <button onclick="deleteWork(${work.id})" class="danger">üóëÔ∏è</button>
                </td>
            `;
            tableBody.appendChild(row);
        });

        initializeWorkCheckboxes();
        refreshTableSorting('worksTable');
    }

    function populateWorkMaterialSelect() {
        const select = document.getElementById('workMaterialSelect');
        if (!select) return;

        const selectedIds = new Set(currentWorkMaterials.map(item => item.material_id));
        const hasMaterials = Array.isArray(materials) && materials.length > 0;
        let options = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª</option>';

        if (hasMaterials) {
            materials.forEach(material => {
                const labelParts = [];
                labelParts.push(material.name || `ID ${material.id}`);
                if (material.unit) {
                    labelParts.push(material.unit);
                }
                if (material.category) {
                    labelParts.push(material.category);
                }
                const label = labelParts.join(' ‚Ä¢ ');
                const disabled = selectedIds.has(material.id) ? 'disabled' : '';
                options += `<option value="${material.id}" ${disabled}>${label}</option>`;
            });
        } else {
            options = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</option>';
        }

        select.innerHTML = options;
        select.disabled = !hasMaterials;
    }

    function displayWorkMaterialsList() {
        const tbody = document.getElementById('workMaterialsTableBody');
        if (!tbody) return;

        if (!currentWorkMaterials || currentWorkMaterials.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</td></tr>';
            return;
        }

        const rowsHtml = currentWorkMaterials.map(item => {
            const availableNumber = Number(item.available_quantity);
            const formattedAvailable = Number.isFinite(availableNumber)
                ? availableNumber.toLocaleString('ru-RU', { maximumFractionDigits: 2 })
                : '0';
            const quantityNumber = Number(item.quantity_per_unit);
            const quantityValue = Number.isFinite(quantityNumber) ? quantityNumber : 0;

            return `
                <tr data-material-id="${item.material_id}">
                    <td>${item.material_name || `ID ${item.material_id}`}</td>
                    <td>${item.unit || ''}</td>
                    <td>${item.category || ''}</td>
                    <td>${formattedAvailable}</td>
                    <td><input type="number" min="0" step="1" value="${quantityValue}" oninput="handleWorkMaterialQuantityChange(${item.material_id}, this.value)"></td>
                    <td class="action-buttons">
                        <button type="button" class="danger" onclick="removeMaterialFromWork(${item.material_id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = rowsHtml;
    }

    function roundMoneyValue(value) {
        const numeric = Number(value);
        if (!Number.isFinite(numeric)) {
            return null;
        }
        return Math.round((numeric + Number.EPSILON) * 100) / 100;
    }

    function normalizeCostValue(value) {
        if (value === null || value === undefined) {
            return null;
        }
        const numeric = Number(value);
        if (!Number.isFinite(numeric)) {
            return null;
        }
        return numeric < 0 ? 0 : roundMoneyValue(numeric);
    }

    function parseMoneyInput(rawValue) {
        if (rawValue === null || rawValue === undefined) {
            return null;
        }
        const normalized = String(rawValue).replace(',', '.').trim();
        if (normalized === '') {
            return null;
        }
        const parsed = parseFloat(normalized);
        if (Number.isNaN(parsed)) {
            return 0;
        }
        return parsed < 0 ? 0 : parsed;
    }

    function formatMoneyValue(value) {
        if (value === null || value === undefined) {
            return '';
        }
        return Number(value).toFixed(2);
    }

    function updateWorkPricingInputs(excludeIds = []) {
        const exclude = Array.isArray(excludeIds) ? new Set(excludeIds) : new Set([excludeIds]);

        const unitInput = document.getElementById('workPriceUnit');
        const totalInput = document.getElementById('workPriceTotal');

        const unitValue = typeof currentWorkPricing.unitCost === 'number'
            ? roundMoneyValue(Math.max(currentWorkPricing.unitCost, 0))
            : null;
        const totalValue = typeof currentWorkPricing.totalCost === 'number'
            ? roundMoneyValue(Math.max(currentWorkPricing.totalCost, 0))
            : null;

        if (unitInput && !exclude.has('workPriceUnit')) {
            unitInput.value = formatMoneyValue(unitValue);
        }
        if (totalInput && !exclude.has('workPriceTotal')) {
            totalInput.value = formatMoneyValue(totalValue);
        }
    }

    function handlePricingInput(field, rawValue) {
        const parsed = parseMoneyInput(rawValue);

        if (field === 'unitCost') {
            currentWorkPricing.unitCost = parsed === null ? null : roundMoneyValue(parsed);
        } else if (field === 'totalCost') {
            currentWorkPricing.totalCost = parsed === null ? null : roundMoneyValue(parsed);
        }
    }

    function resetWorkPricing() {
        currentWorkPricing = {
            unitCost: null,
            totalCost: null
        };
        updateWorkPricingInputs();
    }

    function updateMaterialPricingInputs(excludeIds = []) {
        const exclude = Array.isArray(excludeIds) ? new Set(excludeIds) : new Set([excludeIds]);

        const unitInput = document.getElementById('materialPriceUnit');
        const totalInput = document.getElementById('materialPriceTotal');

        const unitValue = typeof currentMaterialPricing.unitCost === 'number'
            ? roundMoneyValue(Math.max(currentMaterialPricing.unitCost, 0))
            : null;
        const totalValue = typeof currentMaterialPricing.totalCost === 'number'
            ? roundMoneyValue(Math.max(currentMaterialPricing.totalCost, 0))
            : null;

        if (unitInput && !exclude.has('materialPriceUnit')) {
            unitInput.value = formatMoneyValue(unitValue);
        }
        if (totalInput && !exclude.has('materialPriceTotal')) {
            totalInput.value = formatMoneyValue(totalValue);
        }
    }

    function handleMaterialPricingInput(field, rawValue) {
        const parsed = parseMoneyInput(rawValue);

        if (field === 'unitCost') {
            currentMaterialPricing.unitCost = parsed === null ? null : roundMoneyValue(parsed);
        } else if (field === 'totalCost') {
            currentMaterialPricing.totalCost = parsed === null ? null : roundMoneyValue(parsed);
        }
    }

    function resetMaterialPricing() {
        currentMaterialPricing = {
            unitCost: null,
            totalCost: null
        };
        updateMaterialPricingInputs();
    }

    async function loadMaterialPricing(materialId) {
        try {
            const response = await makeApiRequest(`/api/materials/${materialId}/pricing`);
            if (response && response.success) {
                const pricingData = response.data || {};
                currentMaterialPricing = {
                    unitCost: normalizeCostValue(pricingData.unit_cost_without_vat),
                    totalCost: normalizeCostValue(pricingData.total_cost_without_vat)
                };
            } else {
                const errorMessage = response?.error || response?.detail;
                resetMaterialPricing();
                if (errorMessage) {
                    showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∞: ' + errorMessage, 'error');
                }
            }
        } catch (error) {
            resetMaterialPricing();
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞: ' + error.message, 'error');
        }

        updateMaterialPricingInputs();
    }

    async function openMaterialPricing(materialId) {
        const modal = document.getElementById('materialPricingModal');
        if (!modal) return;

        const material = materials.find(item => item.id === materialId);
        if (!material) {
            showNotification('–ú–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
            return;
        }

        currentMaterialIdForPricing = materialId;

        const nameElement = document.getElementById('materialPricingName');
        if (nameElement) {
            const unitSuffix = material.unit ? ` (${material.unit})` : '';
            nameElement.textContent = `${material.name || `ID ${materialId}`}${unitSuffix}`;
        }

        resetMaterialPricing();
        modal.style.display = 'flex';

        await loadMaterialPricing(materialId);
    }

    async function saveMaterialPricing() {
        if (!currentMaterialIdForPricing) {
            showNotification('–ú–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ –≤—ã–±—Ä–∞–Ω', 'error');
            return;
        }

        const saveButton = document.getElementById('materialPricingSaveButton');
        if (saveButton) {
            saveButton.disabled = true;
        }

        const payload = {
            unit_cost_without_vat: typeof currentMaterialPricing.unitCost === 'number'
                ? roundMoneyValue(Math.max(currentMaterialPricing.unitCost, 0)) || 0
                : 0,
            total_cost_without_vat: typeof currentMaterialPricing.totalCost === 'number'
                ? roundMoneyValue(Math.max(currentMaterialPricing.totalCost, 0)) || 0
                : 0,
        };

        try {
            const response = await makeApiRequest(`/api/materials/${currentMaterialIdForPricing}/pricing`, {
                method: 'PUT',
                body: JSON.stringify(payload)
            });

            if (response && response.success) {
                const pricingData = response.data || payload;
                currentMaterialPricing = {
                    unitCost: normalizeCostValue(pricingData.unit_cost_without_vat),
                    totalCost: normalizeCostValue(pricingData.total_cost_without_vat)
                };
                updateMaterialPricingInputs();

                const materialIndex = materials.findIndex(item => item.id === currentMaterialIdForPricing);
                if (materialIndex !== -1) {
                    materials[materialIndex] = {
                        ...materials[materialIndex],
                        unit_cost_without_vat: currentMaterialPricing.unitCost || 0,
                        total_cost_without_vat: currentMaterialPricing.totalCost || 0
                    };
                }

                showNotification(response.message || '–°—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
            } else {
                const errorMessage = response?.error || response?.detail || response?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∞';
                showNotification(errorMessage, 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞: ' + error.message, 'error');
        } finally {
            if (saveButton) {
                saveButton.disabled = false;
            }
        }
    }

    function closeMaterialPricingModal() {
        const modal = document.getElementById('materialPricingModal');
        if (modal) {
            modal.style.display = 'none';
        }
        currentMaterialIdForPricing = null;
        resetMaterialPricing();
    }

    async function loadWorkMaterials(workId) {
        try {
            const response = await makeApiRequest(`/api/works/${workId}/materials`);
            if (response && response.success) {
                const materialsData = Array.isArray(response.data) ? response.data : [];
                currentWorkMaterials = materialsData.map(item => ({
                    material_id: item.material_id,
                    material_name: item.material_name || `ID ${item.material_id}`,
                    unit: item.unit,
                    category: item.category,
                    quantity_per_unit: parseFloat(item.quantity_per_unit) || 0,
                    available_quantity: item.available_quantity !== undefined ? Number(item.available_quantity) : 0
                }));

                if (response.pricing && typeof response.pricing === 'object') {
                    currentWorkPricing = {
                        unitCost: normalizeCostValue(response.pricing.unit_cost_without_vat),
                        totalCost: normalizeCostValue(response.pricing.total_cost_without_vat)
                    };
                    updateWorkPricingInputs();
                } else {
                    resetWorkPricing();
                }
            } else {
                currentWorkMaterials = [];
                resetWorkPricing();
                const errorMessage = response?.error || response?.detail;
                if (errorMessage) {
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Ä–∞–±–æ—Ç—ã: ' + errorMessage, 'error');
                }
            }
        } catch (error) {
            currentWorkMaterials = [];
            resetWorkPricing();
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Ä–∞–±–æ—Ç—ã: ' + error.message, 'error');
        }

        populateWorkMaterialSelect();
        displayWorkMaterialsList();
        updateWorkPricingInputs();
    }

    async function openWorkMaterials(workId) {
        const modal = document.getElementById('workMaterialsModal');
        if (!modal) return;

        const work = works.find(item => item.id === workId);
        if (!work) {
            showNotification('–†–∞–±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
            return;
        }

        currentWorkIdForMaterials = workId;

        const workNameElement = document.getElementById('workMaterialsWorkName');
        if (workNameElement) {
            const unitSuffix = work['–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è'] ? ` (${work['–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è']})` : '';
            workNameElement.textContent = `${work['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã']}${unitSuffix}`;
        }

        const select = document.getElementById('workMaterialSelect');
        const quantityInput = document.getElementById('workMaterialQuantity');
        if (select) select.value = '';
        if (quantityInput) quantityInput.value = '';

        const tbody = document.getElementById('workMaterialsTableBody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
        }

        resetWorkPricing();
        modal.style.display = 'flex';

        if (!materials || materials.length === 0) {
            await loadMaterials();
        }

        await loadWorkMaterials(workId);
    }

    function addMaterialToWorkList() {
        const select = document.getElementById('workMaterialSelect');
        const quantityInput = document.getElementById('workMaterialQuantity');
        if (!select || !quantityInput) return;

        const materialId = parseInt(select.value, 10);
        const quantity = parseFloat(quantityInput.value);

        if (!materialId) {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è', 'error');
            return;
        }

        if (isNaN(quantity) || quantity <= 0) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ —Ä–∞—Å—Ö–æ–¥ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –±–æ–ª—å—à–µ 0', 'error');
            return;
        }

        const material = materials.find(item => item.id === materialId);
        if (!material) {
            showNotification('–ú–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
            return;
        }

        const normalizedQuantity = Number(quantity);
        const existing = currentWorkMaterials.find(item => item.material_id === materialId);

        if (existing) {
            existing.quantity_per_unit = normalizedQuantity;
            existing.material_name = material.name || existing.material_name;
            existing.unit = material.unit;
            existing.category = material.category;
            existing.available_quantity = material.quantity !== undefined ? Number(material.quantity) : existing.available_quantity;
        } else {
            currentWorkMaterials.push({
                material_id: materialId,
                material_name: material.name || `ID ${materialId}`,
                unit: material.unit,
                category: material.category,
                quantity_per_unit: normalizedQuantity,
                available_quantity: material.quantity !== undefined ? Number(material.quantity) : 0
            });
        }

        quantityInput.value = '';
        select.value = '';

        populateWorkMaterialSelect();
        displayWorkMaterialsList();
    }

    function handleWorkMaterialQuantityChange(materialId, value) {
        const target = currentWorkMaterials.find(item => item.material_id === materialId);
        if (!target) return;

        let parsed = parseFloat(value);
        if (isNaN(parsed) || parsed < 0) {
            parsed = 0;
        }
        target.quantity_per_unit = parsed;
    }

    function removeMaterialFromWork(materialId) {
        currentWorkMaterials = currentWorkMaterials.filter(item => item.material_id !== materialId);
        populateWorkMaterialSelect();
        displayWorkMaterialsList();
    }

    async function saveWorkMaterials() {
        if (!currentWorkIdForMaterials) {
            showNotification('–ù–µ –≤—ã–±—Ä–∞–Ω–∞ —Ä–∞–±–æ—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤', 'error');
            return;
        }

        const materialsPayload = currentWorkMaterials.map(item => ({
            material_id: item.material_id,
            quantity_per_unit: Number(item.quantity_per_unit) || 0
        }));

        const pricingPayload = {
            unit_cost_without_vat: typeof currentWorkPricing.unitCost === 'number'
                ? roundMoneyValue(Math.max(currentWorkPricing.unitCost, 0)) || 0
                : 0,
            total_cost_without_vat: typeof currentWorkPricing.totalCost === 'number'
                ? roundMoneyValue(Math.max(currentWorkPricing.totalCost, 0)) || 0
                : 0
        };

        const requestBody = {
            materials: materialsPayload,
            pricing: pricingPayload
        };

        try {
            const response = await makeApiRequest(`/api/works/${currentWorkIdForMaterials}/materials`, {
                method: 'PUT',
                body: JSON.stringify(requestBody)
            });

            if (response && response.success) {
                const materialsData = Array.isArray(response.data) ? response.data : [];
                currentWorkMaterials = materialsData.map(item => ({
                    material_id: item.material_id,
                    material_name: item.material_name || `ID ${item.material_id}`,
                    unit: item.unit,
                    category: item.category,
                    quantity_per_unit: parseFloat(item.quantity_per_unit) || 0,
                    available_quantity: item.available_quantity !== undefined ? Number(item.available_quantity) : 0
                }));

                if (response.pricing && typeof response.pricing === 'object') {
                    currentWorkPricing = {
                        unitCost: normalizeCostValue(response.pricing.unit_cost_without_vat),
                        totalCost: normalizeCostValue(response.pricing.total_cost_without_vat)
                    };
                }

                displayWorkMaterialsList();
                populateWorkMaterialSelect();
                updateWorkPricingInputs();
                showNotification('–ú–∞—Ç–µ—Ä–∏–∞–ª—ã —Ä–∞–±–æ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
            } else {
                const errorMessage = response?.error || response?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã';
                showNotification(errorMessage, 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: ' + error.message, 'error');
        }
    }

    function closeWorkMaterialsModal() {
        const modal = document.getElementById('workMaterialsModal');
        if (modal) {
            modal.style.display = 'none';
        }
        currentWorkIdForMaterials = null;
        currentWorkMaterials = [];
        resetWorkPricing();
        populateWorkMaterialSelect();
        displayWorkMaterialsList();
    }

    // –§–£–ù–ö–¶–ò–ò –°–û–†–¢–ò–†–û–í–ö–ò
    
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–∞–±–æ—Ç
    function initializeWorkCheckboxes() {
        const selectAllCheckbox = document.getElementById('selectAllWorks');
        const workCheckboxes = document.querySelectorAll('.work-checkbox');
        const deleteSelectedBtn = document.getElementById('deleteSelectedWorks');
        const massActions = document.getElementById('massActions');
        const selectedCount = document.getElementById('selectedCount');
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
        selectAllCheckbox.checked = false;
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
        selectAllCheckbox.addEventListener('click', function(event) {
            const shouldSelectAll = selectAllCheckbox.dataset.allSelected !== 'true';

            workCheckboxes.forEach(checkbox => {
                checkbox.checked = shouldSelectAll;
            });

            selectAllCheckbox.checked = shouldSelectAll;
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.dataset.allSelected = shouldSelectAll ? 'true' : 'false';

            updateMassActions();
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
        workCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateMassActions);
        });
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏ –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
        function updateMassActions() {
            const selectedCountValue = document.querySelectorAll('.work-checkbox:checked').length;
            
            if (selectedCountValue > 0) {
                deleteSelectedBtn.style.display = 'inline-block';
                massActions.style.display = 'flex';
                selectedCount.textContent = selectedCountValue;
                const allSelected = selectedCountValue === workCheckboxes.length;
                selectAllCheckbox.checked = allSelected;
                selectAllCheckbox.indeterminate = !allSelected;
                selectAllCheckbox.dataset.allSelected = allSelected ? 'true' : 'false';
            } else {
                deleteSelectedBtn.style.display = 'none';
                massActions.style.display = 'none';
                selectedCount.textContent = '0';
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.dataset.allSelected = 'false';
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
        deleteSelectedBtn.onclick = deleteSelectedWorks;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        updateMassActions();
    }
    
    // –ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç
    async function deleteSelectedWorks() {
        const selectedCheckboxes = document.querySelectorAll('.work-checkbox:checked');
        
        if (selectedCheckboxes.length === 0) {
            showNotification('–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π —Ä–∞–±–æ—Ç—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
            return;
        }
        
        const workIds = Array.from(selectedCheckboxes).map(checkbox => parseInt(checkbox.value));
        
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${workIds.length} –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç?`)) {
            return;
        }
        
        try {
            // –°–Ω–∞—á–∞–ª–∞ –∞–Ω–∏–º–∏—Ä—É–µ–º –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫
            selectedCheckboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                row.classList.add('fade-out');
            });
            
            // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
            await new Promise(resolve => setTimeout(resolve, 300));
            
            // –£–¥–∞–ª—è–µ–º –∫–∞–∂–¥—É—é –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ä–∞–±–æ—Ç—É
            const deletePromises = workIds.map(workId => 
                makeApiRequest(`${API_CONFIG.ENDPOINTS.WORKS}/${workId}`, {
                    method: 'DELETE'
                })
            );
            
            // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —É–¥–∞–ª–µ–Ω–∏—è
            await Promise.all(deletePromises);
            
            // –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
            await loadWorks();
            
            showNotification(`–£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ ${workIds.length} —Ä–∞–±–æ—Ç`, 'success');
            
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç: ' + error.message, 'error');
            // –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, —É–±–∏—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
            selectedCheckboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                row.classList.remove('fade-out');
            });
        }
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Ä–∞–±–æ—Ç—ã
    function addNewWork() {
        const existingModal = document.getElementById('addWorkModal');
        if (existingModal) {
            existingModal.remove();
        }

        const overlay = document.createElement('div');
        overlay.className = 'modal';
        overlay.id = 'addWorkModal';
        overlay.style.display = 'flex';

        const content = document.createElement('div');
        content.className = 'modal-content';

        const title = document.createElement('h3');
        title.className = 'modal-title';
        title.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç';

        const subtitle = document.createElement('p');
        subtitle.className = 'modal-subtitle';
        subtitle.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –¥–æ–±–∞–≤—å—Ç–µ –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–±–æ—Ç.';

        const form = document.createElement('form');
        form.id = 'addWorkForm';

        const itemsContainer = document.createElement('div');
        itemsContainer.id = 'addWorkItemsContainer';
        itemsContainer.style.display = 'flex';
        itemsContainer.style.flexDirection = 'column';
        itemsContainer.style.gap = '12px';

        const addItemButton = document.createElement('button');
        addItemButton.type = 'button';
        addItemButton.className = 'secondary';
        addItemButton.textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ —Ä–∞–±–æ—Ç—É';

        const actions = document.createElement('div');
        actions.className = 'modal-actions';

        const cancelButton = document.createElement('button');
        cancelButton.type = 'button';
        cancelButton.className = 'secondary';
        cancelButton.textContent = '–û—Ç–º–µ–Ω–∞';

        const submitButton = document.createElement('button');
        submitButton.type = 'submit';
        submitButton.className = 'success';
        submitButton.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';

        actions.appendChild(cancelButton);
        actions.appendChild(submitButton);

        form.appendChild(itemsContainer);
        form.appendChild(addItemButton);
        form.appendChild(actions);

        content.appendChild(title);
        content.appendChild(subtitle);
        content.appendChild(form);

        overlay.appendChild(content);
        document.body.appendChild(overlay);

        const availableCategories = Array.isArray(categories) && categories.length > 0
            ? categories.map(cat => cat.name)
            : [''];
        const availableUnits = Array.isArray(UNITS) && UNITS.length > 0
            ? UNITS.slice()
            : ['—à—Ç'];

        function createSelectOptions(options, selectedValue = '') {
            return options.map(option => {
                const value = option ?? '';
                const selected = value === selectedValue ? ' selected' : '';
                return `<option value="${value}"${selected}>${value}</option>`;
            }).join('');
        }

        function createWorkItem(initialData = {}) {
            const item = document.createElement('div');
            item.className = 'report-work-item add-work-item';

            item.innerHTML = `
                <div class="modal-form-group">
                    <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="editable" data-field="name" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã" value="${initialData.name || ''}" required>
                </div>
                <div class="modal-form-group">
                    <label>–†–∞–∑–¥–µ–ª</label>
                    <select class="editable" data-field="category"></select>
                </div>
                <div class="modal-form-group">
                    <label>–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</label>
                    <select class="editable" data-field="unit"></select>
                </div>
                <div class="modal-form-group">
                    <label>–ù–∞ –±–∞–ª–∞–Ω—Å–µ</label>
                    <input type="number" class="editable" data-field="balance" step="1" value="${initialData.balance ?? 0}">
                </div>
                <div class="modal-form-group">
                    <label>–ü—Ä–æ–µ–∫—Ç</label>
                    <input type="number" class="editable" data-field="project_total" step="1" value="${initialData.project_total ?? 0}">
                </div>
                <div class="modal-form-group">
                    <label>–ê–∫—Ç–∏–≤–Ω–æ</label>
                    <select class="editable" data-field="is_active">
                        <option value="1"${initialData.is_active === 0 ? '' : ' selected'}>–î–∞</option>
                        <option value="0"${initialData.is_active === 0 ? ' selected' : ''}>–ù–µ—Ç</option>
                    </select>
                </div>
                <button type="button" class="secondary remove-add-work-button">–£–¥–∞–ª–∏—Ç—å</button>
            `;

            const categorySelect = item.querySelector('select[data-field="category"]');
            categorySelect.innerHTML = createSelectOptions(availableCategories, initialData.category || availableCategories[0] || '');

            const unitSelect = item.querySelector('select[data-field="unit"]');
            unitSelect.innerHTML = createSelectOptions(availableUnits, initialData.unit || availableUnits[0]);

            const removeButton = item.querySelector('.remove-add-work-button');
            removeButton.addEventListener('click', () => {
                item.remove();
                if (!itemsContainer.querySelector('.add-work-item')) {
                    addWorkEntry();
                }
            });

            return item;
        }

        function addWorkEntry(initialData = {}) {
            const item = createWorkItem(initialData);
            itemsContainer.appendChild(item);
        }

        addItemButton.addEventListener('click', () => addWorkEntry());
        cancelButton.addEventListener('click', () => {
            overlay.remove();
        });

        overlay.addEventListener('click', (event) => {
            if (event.target === overlay) {
                overlay.remove();
            }
        });

        content.addEventListener('click', (event) => event.stopPropagation());

        addWorkEntry();

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            const items = Array.from(itemsContainer.querySelectorAll('.add-work-item'));
            if (items.length === 0) {
                showNotification('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ä–∞–±–æ—Ç—É', 'error');
                return;
            }

            const worksPayload = [];

            for (const item of items) {
                const getField = (selector) => item.querySelector(selector);

                const nameInput = getField('input[data-field="name"]');
                const categorySelect = getField('select[data-field="category"]');
                const unitSelect = getField('select[data-field="unit"]');
                const balanceInput = getField('input[data-field="balance"]');
                const projectInput = getField('input[data-field="project_total"]');
                const isActiveSelect = getField('select[data-field="is_active"]');

                const name = (nameInput.value || '').trim();
                if (!name) {
                    showNotification('–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º', 'error');
                    nameInput.focus();
                    return;
                }

                worksPayload.push({
                    name,
                    category: (categorySelect?.value || '').trim(),
                    unit: unitSelect?.value || '',
                    balance: parseFloat(balanceInput?.value || '0') || 0,
                    project_total: parseFloat(projectInput?.value || '0') || 0,
                    is_active: parseInt(isActiveSelect?.value || '1', 10) || 0
                });
            }

            submitButton.disabled = true;
            cancelButton.disabled = true;
            addItemButton.disabled = true;

            let successCount = 0;
            let errorMessages = [];

            for (const workData of worksPayload) {
                try {
                    showNotification('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...', 'success');

                    const response = await fetch(buildApiUrl(API_CONFIG.ENDPOINTS.WORKS), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            name: workData.name,
                            category: workData.category,
                            unit: workData.unit,
                            balance: workData.balance,
                            project_total: workData.project_total,
                            is_active: workData.is_active
                        })
                    });

                    const workAdded = await checkIfWorkExists(workData.name, workData.category);

                    if (workAdded) {
                        successCount++;
                        showNotification(`–†–∞–±–æ—Ç–∞ "${workData.name}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞`, 'success');
                    } else {
                        let errorMessage = '–†–∞–±–æ—Ç–∞ –Ω–µ –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö';
                        try {
                            const errorText = await response.text();
                            if (errorText) {
                                const errorData = JSON.parse(errorText);
                                errorMessage = errorData.detail || errorData.error || errorMessage;
                            }
                        } catch (e) {}
                        errorMessages.push(errorMessage);
                    }
                } catch (error) {
                    errorMessages.push('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã: ' + error.message);
                }
            }

            if (successCount > 0) {
                overlay.remove();
            } else {
                submitButton.disabled = false;
                cancelButton.disabled = false;
                addItemButton.disabled = false;
            }

            if (errorMessages.length > 0) {
                showNotification(errorMessages.join(' '), 'error');
            }
        });
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Ä–∞–±–æ—Ç—ã (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–¥—É–º–∞–ª)
    function removeNewWork(button) {
        const row = button.closest('tr');
        row.remove();
        
        // –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        const tableBody = document.getElementById('worksTableBody');
        if (tableBody.children.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞–±–æ—Ç–∞—Ö</td></tr>';
        }
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Ä–∞–±–æ—Ç—ã
    async function saveNewWork(button) {
        const row = button.closest('tr');
        const inputs = row.querySelectorAll('.editable');
        
        const workData = {};
        inputs.forEach(input => {
            const field = input.getAttribute('data-field');
            let value = input.value;
            
            if (field === 'balance' || field === 'project_total') value = parseFloat(value);
            if (field === 'is_active') value = parseInt(value);
            
            workData[field] = value;
        });
        
        const workName = workData.name;
        const category = workData.category;
        
        const apiData = {
            name: workData.name,
            category: workData.category,
            unit: workData.unit,
            balance: workData.balance,
            project_total: workData.project_total,
            is_active: workData.is_active
        };
        
        try {
            showNotification('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...', 'success');
            
            const response = await fetch(buildApiUrl(API_CONFIG.ENDPOINTS.WORKS), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify(apiData)
            });
            
            const workAdded = await checkIfWorkExists(workName, category);
            
            if (workAdded) {
                showNotification('–†–∞–±–æ—Ç–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
            } else {
                let errorMessage = '–†–∞–±–æ—Ç–∞ –Ω–µ –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö';
                try {
                    const errorText = await response.text();
                    if (errorText) {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.detail || errorData.error || errorMessage;
                    }
                } catch (e) {}
                showNotification(`–û—à–∏–±–∫–∞: ${errorMessage}`, 'error');
            }
            
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã: ' + error.message, 'error');
        }
    }

    async function checkIfWorkExists(workName, category, maxAttempts = 5) {
        for (let attempt = 0; attempt < maxAttempts; attempt++) {
            await loadWorks();
            const exists = works.some(work => {
                const sectionName = work.–†–∞–∑–¥–µ–ª || work['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'] || '';
                return work['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã'] === workName && sectionName === category;
            });
            if (exists) return true;
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        return false;
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
    async function saveWork(workId) {
        const row = document.querySelector(`tr:has(input[value="${workId}"])`);
        const inputs = row.querySelectorAll('.editable');
        
        const workData = { id: workId };
        inputs.forEach(input => {
            const field = input.getAttribute('data-field');
            let value = input.value;
            
            if (field === 'balance' || field === 'project_total') value = parseFloat(value);
            if (field === 'is_active') value = parseInt(value);
            
            workData[field] = value;
        });
        
        const apiData = {
            name: workData.name,
            category: workData.category,
            unit: workData.unit,
            balance: workData.balance,
            project_total: workData.project_total,
            is_active: workData.is_active
        };
        
        try {
            const originalWork = works.find(work => work.id === workId);
            if (!originalWork) {
                showNotification('–†–∞–±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                return;
            }
            
            showNotification('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...', 'success');
            
            const response = await fetch(buildApiUrl(`${API_CONFIG.ENDPOINTS.WORKS}/${workId}`), {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify(apiData)
            });
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            await loadWorks();
            
            const updatedWork = works.find(work => work.id === workId);
            
            if (updatedWork) {
                const updatedSection = updatedWork.–†–∞–∑–¥–µ–ª || updatedWork['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'] || '';
                const isUpdated =
                    updatedWork['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã'] === workData.name &&
                    updatedSection === workData.category &&
                    updatedWork['–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è'] === workData.unit &&
                    parseFloat(updatedWork['–ù–∞ –±–∞–ª–∞–Ω—Å–µ']) === workData.balance &&
                    parseFloat(updatedWork['–ü—Ä–æ–µ–∫—Ç'] || 0) === workData.project_total &&
                    Boolean(updatedWork.is_active) === Boolean(workData.is_active);
                
                if (isUpdated) {
                    showNotification('–†–∞–±–æ—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
                } else {
                    showNotification('–†–∞–±–æ—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞, –Ω–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ –±—ã–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'warning');
                }
            } else {
                let errorMessage = '–†–∞–±–æ—Ç–∞ –Ω–µ –±—ã–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö';
                try {
                    const errorText = await response.text();
                    if (errorText) {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.detail || errorData.error || errorMessage;
                    }
                } catch (e) {}
                showNotification(`–û—à–∏–±–∫–∞: ${errorMessage}`, 'error');
            }
            
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã: ' + error.message, 'error');
        }
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö —Ä–∞–±–æ—Ç
    async function saveAllWorks() {
        const rows = document.querySelectorAll('#worksTableBody tr');
        let hasChanges = false;
        let successCount = 0;
        let errorCount = 0;
        
        showNotification('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π...', 'success');
        
        for (const row of rows) {
            const idInput = row.querySelector('td:nth-child(2) input');
            if (!idInput || idInput.value === '–Ω–æ–≤—ã–π') continue;
            
            const workId = parseInt(idInput.value);
            const inputs = row.querySelectorAll('.editable');
            
            const workData = { id: workId };
            inputs.forEach(input => {
                const field = input.getAttribute('data-field');
                let value = input.value;
                
                if (field === 'balance' || field === 'project_total') value = parseFloat(value);
                if (field === 'is_active') value = parseInt(value);
                
                workData[field] = value;
            });
            
            const apiData = {
                name: workData.name,
                category: workData.category,
                unit: workData.unit,
                balance: workData.balance,
                project_total: workData.project_total,
                is_active: workData.is_active
            };
            
            try {
                const response = await fetch(buildApiUrl(`${API_CONFIG.ENDPOINTS.WORKS}/${workId}`), {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(apiData)
                });
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (successCount + errorCount === rows.length - 1) {
                    await loadWorks();
                }
                
                successCount++;
                hasChanges = true;
                
            } catch (error) {
                errorCount++;
            }
        }
        
        await loadWorks();
        
        if (hasChanges) {
            let message = `–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –û–±–Ω–æ–≤–ª–µ–Ω–æ —Ä–∞–±–æ—Ç: ${successCount}`;
            if (errorCount > 0) {
                message += `, –æ—à–∏–±–æ–∫: ${errorCount}`;
            }
            showNotification(message, 'success');
        } else {
            showNotification('–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'success');
        }
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
    async function deleteWork(workId) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ä–∞–±–æ—Ç—É?')) {
            try {
                const row = document.querySelector(`tr:has(input[value="${workId}"])`);
                row.classList.add('fade-out');
                await new Promise(resolve => setTimeout(resolve, 300));
                
                const response = await makeApiRequest(`${API_CONFIG.ENDPOINTS.WORKS}/${workId}`, {
                    method: 'DELETE'
                });
                
                if (response.success) {
                    await loadWorks();
                    showNotification('–†–∞–±–æ—Ç–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞', 'success');
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã: ' + (response.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã: ' + error.message, 'error');
            }
        }
    }
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç
    function filterWorks() {
        const searchTerm = document.getElementById('searchWorks').value.toLowerCase();
        const filteredWorks = works.filter(work => {
            const sectionValue = (work.–†–∞–∑–¥–µ–ª || work['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'] || '').toLowerCase();
            return (
                work['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã'].toLowerCase().includes(searchTerm) ||
                sectionValue.includes(searchTerm) ||
                work['–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è'].toLowerCase().includes(searchTerm)
            );
        });
        displayWorks(filteredWorks);
    }
    
    // ========== –§–£–ù–ö–¶–ò–ò –ò–ú–ü–û–†–¢–ê/–≠–ö–°–ü–û–†–¢–ê XLS ==========
    async function exportWorksToExcel() {
        try {
            showNotification('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è...', 'success');
            
            const workbook = XLSX.utils.book_new();
            workbook.Props = {
                Title: "–°–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç",
                Subject: "–†–∞–±–æ—Ç—ã —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–π –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏",
                Author: "WiTech System",
                CreatedDate: new Date()
            };

            const exportData = works.map(work => ({
                'ID': work.id,
                '–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã': work['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã'],
                '–†–∞–∑–¥–µ–ª': work.–†–∞–∑–¥–µ–ª || work['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'] || '',
                '–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è': work['–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è'],
                '–ù–∞ –±–∞–ª–∞–Ω—Å–µ': work['–ù–∞ –±–∞–ª–∞–Ω—Å–µ'],
                '–ü—Ä–æ–µ–∫—Ç': work['–ü—Ä–æ–µ–∫—Ç'] || 0,
                '–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É': work['–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É'] ?? work.unit_cost_without_vat ?? 0,
                '–ê–∫—Ç–∏–≤–Ω–∞': work.is_active ? '–î–∞' : '–ù–µ—Ç'
            }));

            const worksheet = XLSX.utils.json_to_sheet(exportData);
            
            const colWidths = [
                { wch: 8 },   // ID
                { wch: 40 },  // –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
                { wch: 20 },  // –†–∞–∑–¥–µ–ª
                { wch: 15 },  // –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è
                { wch: 12 },  // –ù–∞ –±–∞–ª–∞–Ω—Å–µ
                { wch: 12 },  // –ü—Ä–æ–µ–∫—Ç
                { wch: 18 },  // –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É
                { wch: 10 }   // –ê–∫—Ç–∏–≤–Ω–∞
            ];
            worksheet['!cols'] = colWidths;

            XLSX.utils.book_append_sheet(workbook, worksheet, "–†–∞–±–æ—Ç—ã");

            const fileName = `works_export_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            showNotification('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω', 'success');
        } catch (error) {
            console.error('Export error:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ —Ñ–∞–π–ª–∞: ' + error.message, 'error');
        }
    }

    function triggerImportWorks() {
        document.getElementById('importFileInput').click();
    }

    async function handleWorksImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        event.target.value = '';

        try {
            showNotification('–ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞...', 'success');
            const data = await readExcelFile(file);
            await importWorksFromExcel(data);
        } catch (error) {
            console.error('Import error:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Ñ–∞–π–ª–∞: ' + error.message, 'error');
        }
    }

    function readExcelFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    resolve(jsonData);
                } catch (error) {
                    reject(error);
                }
            };
            reader.onerror = function() {
                reject(new Error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞'));
            };
            reader.readAsArrayBuffer(file);
        });
    }

    async function importWorksFromExcel(excelData) {
        if (!excelData || excelData.length === 0) {
            throw new Error('–§–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö');
        }

        let importedCount = 0;
        let updatedCount = 0;
        let errors = [];

        showNotification(`–ù–∞—á–∏–Ω–∞–µ–º –∏–º–ø–æ—Ä—Ç ${excelData.length} –∑–∞–ø–∏—Å–µ–π...`, 'success');

        for (let i = 0; i < excelData.length; i++) {
            const row = excelData[i];
            try {
                const rawSection = row['–†–∞–∑–¥–µ–ª'] ?? row['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'];
                if (!row['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã'] || !rawSection || !row['–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è']) {
                    errors.push(`–°—Ç—Ä–æ–∫–∞ ${i + 2}: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è`);
                    continue;
                }

                const sectionName = String(rawSection).trim();
                const unitCost = parseFloat(row['–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É']) || 0;
                const workData = {
                    name: String(row['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã']).trim(),
                    category: sectionName,
                    unit: String(row['–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è']).trim(),
                    balance: parseFloat(row['–ù–∞ –±–∞–ª–∞–Ω—Å–µ']) || 0,
                    project_total: parseFloat(row['–ü—Ä–æ–µ–∫—Ç']) || 0,
                    unit_cost_without_vat: unitCost,
                    total_cost_without_vat: unitCost * (parseFloat(row['–ü—Ä–æ–µ–∫—Ç']) || 0),
                    is_active: String(row['–ê–∫—Ç–∏–≤–Ω–∞']).toLowerCase() === '–¥–∞' ? 1 : 0
                };

                const existingWorkId = row['ID'] ? parseInt(row['ID']) : null;
                
                if (existingWorkId && works.find(w => w.id === existingWorkId)) {
                    const response = await makeApiRequest(`${API_CONFIG.ENDPOINTS.WORKS}/${existingWorkId}`, {
                        method: 'PUT',
                        body: JSON.stringify(workData)
                    });
                    
                    if (response && response.success) {
                        updatedCount++;
                    } else {
                        errors.push(`–°—Ç—Ä–æ–∫–∞ ${i + 2}: –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã ID ${existingWorkId}`);
                    }
                } else {
                    const response = await makeApiRequest(API_CONFIG.ENDPOINTS.WORKS, {
                        method: 'POST',
                        body: JSON.stringify(workData)
                    });
                    
                    if (response && response.success) {
                        importedCount++;
                    } else {
                        errors.push(`–°—Ç—Ä–æ–∫–∞ ${i + 2}: –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã "${workData.name}"`);
                    }
                }
            } catch (error) {
                errors.push(`–°—Ç—Ä–æ–∫–∞ ${i + 2}: ${error.message}`);
            }
        }

        await loadWorks();

        let resultMessage = `–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –î–æ–±–∞–≤–ª–µ–Ω–æ: ${importedCount}, –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${updatedCount}`;
        if (errors.length > 0) {
            resultMessage += `. –û—à–∏–±–æ–∫: ${errors.length}`;
            console.error('Import errors:', errors);
        }
        
        showNotification(resultMessage, errors.length > 0 ? 'error' : 'success');
    }

    // ========== –ú–ê–¢–ï–†–ò–ê–õ–´ ==========

    async function loadMaterials() {
        const loadingElement = document.getElementById('materialsLoading');
        const tableBody = document.getElementById('materialsTableBody');

        if (!loadingElement || !tableBody) return;

        loadingElement.style.display = 'block';
        tableBody.innerHTML = '';

        try {
            const data = await makeApiRequest(API_CONFIG.ENDPOINTS.MATERIALS);
            if (data.success) {
                materials = data.data || [];
                displayMaterials(materials);
                if (currentWorkMaterials && currentWorkMaterials.length > 0) {
                    currentWorkMaterials = currentWorkMaterials.map(item => {
                        const updated = materials.find(material => material.id === item.material_id);
                        if (updated) {
                            return {
                                ...item,
                                material_name: updated.name || item.material_name,
                                unit: updated.unit,
                                category: updated.category,
                                available_quantity: updated.quantity !== undefined ? Number(updated.quantity) : item.available_quantity
                            };
                        }
                        return item;
                    });
                    displayWorkMaterialsList();
                }
                populateWorkMaterialSelect();
            } else {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: ' + error.message, 'error');
        } finally {
            loadingElement.style.display = 'none';
        }
    }

    function displayMaterials(materialsToDisplay = materials) {
        const tableBody = document.getElementById('materialsTableBody');
        if (!tableBody) return;

        tableBody.innerHTML = '';

        if (!materialsToDisplay || materialsToDisplay.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö</td></tr>';
            refreshTableSorting('materialsTable');
            return;
        }

        materialsToDisplay.forEach(material => {
            const row = document.createElement('tr');
            row.setAttribute('data-material-id', material.id);
            const quantityValue = material.quantity !== undefined && material.quantity !== null ? Number(material.quantity) : 0;

            const categoryOptions = [
                ...categories.map(cat => `<option value="${cat.name}" ${cat.name === material.category ? 'selected' : ''}>${cat.name}</option>`)
            ];
            if (!categories.find(cat => cat.name === material.category) && material.category) {
                categoryOptions.push(`<option value="${material.category}" selected>${material.category}</option>`);
            }
            if (!material.category) {
                categoryOptions.unshift('<option value="" selected>–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>');
            }

            const unitOptions = [
                ...UNITS.map(unit => `<option value="${unit}" ${unit === material.unit ? 'selected' : ''}>${unit}</option>`)
            ];
            if (material.unit && !UNITS.includes(material.unit)) {
                unitOptions.push(`<option value="${material.unit}" selected>${material.unit}</option>`);
            }
            if (!material.unit) {
                unitOptions.unshift('<option value="" selected>–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>');
            }

            row.innerHTML = `
                <td><input type="text" value="${material.id}" readonly></td>
                <td>
                    <select class="editable" data-field="category">
                        ${categoryOptions.join('')}
                    </select>
                </td>
                <td><input type="text" value="${material.name || ''}" class="editable" data-field="name"></td>
                <td>
                    <select class="editable" data-field="unit">
                        ${unitOptions.join('')}
                    </select>
                </td>
                <td><input type="number" value="${quantityValue}" class="editable" data-field="quantity" step="1" min="0"></td>
                <td class="action-buttons">
                    <button onclick="saveMaterial(${material.id})" class="secondary">üíæ</button>
                    <button onclick="openMaterialPricing(${material.id})" class="secondary" title="–°—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∞">üßæ</button>
                    <button onclick="addMaterialQuantity(${material.id})" class="success" title="–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ —Å–∫–ª–∞–¥">‚ûï</button>
                    <button onclick="deleteMaterial(${material.id})" class="danger">üóëÔ∏è</button>
                </td>
            `;

            tableBody.appendChild(row);
        });

        refreshTableSorting('materialsTable');
    }

    async function loadMaterialHistory(forceReload = false) {
        const loadingElement = document.getElementById('materialsHistoryLoading');
        const tableBody = document.getElementById('materialHistoryTableBody');

        if (!loadingElement || !tableBody) return;

        if (forceReload) {
            materialHistoryLoaded = false;
        }

        if (materialHistoryLoaded && !forceReload) {
            displayMaterialHistory(materialHistory);
            return;
        }

        loadingElement.style.display = 'block';
        tableBody.innerHTML = '';

        try {
            const data = await makeApiRequest(API_CONFIG.ENDPOINTS.MATERIALS_HISTORY);
            if (data.success) {
                materialHistory = data.data || [];
                materialHistoryLoaded = true;
                displayMaterialHistory(materialHistory);
            } else {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: ' + error.message, 'error');
        } finally {
            loadingElement.style.display = 'none';
        }
    }

    function formatHistoryNumber(value, unit) {
        if (value === null || value === undefined || value === '') {
            return '';
        }
        const numberValue = Number(value);
        if (!Number.isFinite(numberValue)) {
            return value;
        }
        const formatted = numberValue.toLocaleString('ru-RU', { maximumFractionDigits: 2 });
        return unit ? `${formatted} ${unit}` : formatted;
    }

    function formatHistoryChange(amount, unit) {
        if (amount === null || amount === undefined || amount === '') {
            return '';
        }
        const numberValue = Number(amount);
        if (!Number.isFinite(numberValue)) {
            return amount;
        }
        const sign = numberValue > 0 ? '+' : numberValue < 0 ? '-' : '';
        const formatted = Math.abs(numberValue).toLocaleString('ru-RU', { maximumFractionDigits: 2 });
        return unit ? `${sign}${formatted} ${unit}` : `${sign}${formatted}`;
    }

    function formatHistoryDate(dateValue) {
        if (!dateValue) {
            return '';
        }
        const normalized = typeof dateValue === 'string' ? dateValue.replace(' ', 'T') : dateValue;
        const date = new Date(normalized);
        if (Number.isNaN(date.getTime())) {
            return dateValue;
        }
        return date.toLocaleString('ru-RU');
    }

    function displayMaterialHistory(historyToDisplay = materialHistory) {
        const tableBody = document.getElementById('materialHistoryTableBody');
        if (!tableBody) return;

        tableBody.innerHTML = '';

        if (!historyToDisplay || historyToDisplay.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∏—Å—Ç–æ—Ä–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</td></tr>';
            refreshTableSorting('materialHistoryTable');
            return;
        }

        historyToDisplay.forEach(entry => {
            const row = document.createElement('tr');
            const unit = entry.unit || '';
            const changeValue = Number(entry.change_amount);
            const resultingValue = Number(entry.resulting_quantity);
            const changeSortValue = Number.isFinite(changeValue) ? changeValue : '';
            const resultingSortValue = Number.isFinite(resultingValue) ? resultingValue : '';
            const dateSortValue = entry.created_at
                ? String(entry.created_at).replace(' ', 'T')
                : '';
            row.innerHTML = `
                <td>${entry.id ?? ''}</td>
                <td>${entry.material_name || '-'}</td>
                <td>${entry.change_type || '-'}</td>
                <td data-sort-value="${changeSortValue}">${formatHistoryChange(entry.change_amount, unit)}</td>
                <td data-sort-value="${resultingSortValue}">${formatHistoryNumber(entry.resulting_quantity, unit)}</td>
                <td>${entry.description || ''}</td>
                <td>${entry.performed_by || ''}</td>
                <td data-sort-value="${dateSortValue}">${formatHistoryDate(entry.created_at)}</td>
            `;
            tableBody.appendChild(row);
        });

        refreshTableSorting('materialHistoryTable');
    }

    function filterMaterialHistory(query) {
        if (!query) {
            displayMaterialHistory(materialHistory);
            return;
        }

        const normalized = query.toLowerCase();
        const filtered = materialHistory.filter(entry => {
            return [
                entry.id,
                entry.material_id,
                entry.material_name,
                entry.change_type,
                entry.change_amount,
                entry.resulting_quantity,
                entry.performed_by,
                entry.description,
                entry.created_at
            ].some(value => value !== undefined && value !== null && String(value).toLowerCase().includes(normalized));
        });

        displayMaterialHistory(filtered);
    }

    async function toggleMaterialHistoryView() {
        const button = document.getElementById('toggleMaterialsHistory');
        const materialsContainer = document.getElementById('materialsTableContainer');
        const historyContainer = document.getElementById('materialHistoryContainer');
        const materialsLoading = document.getElementById('materialsLoading');
        const historyLoading = document.getElementById('materialsHistoryLoading');
        const searchInput = document.getElementById('searchMaterials');
        const addMaterialBtn = document.getElementById('addMaterial');
        const exportMaterialsBtn = document.getElementById('exportMaterials');
        const importMaterialsBtn = document.getElementById('importMaterials');

        if (!button || !materialsContainer || !historyContainer) {
            return;
        }

        if (!isMaterialHistoryView) {
            isMaterialHistoryView = true;
            button.textContent = 'üì¶ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã';
            materialsContainer.style.display = 'none';
            if (materialsLoading) {
                materialsLoading.style.display = 'none';
            }
            historyContainer.style.display = 'block';
            if (historyLoading) {
                historyLoading.style.display = 'block';
            }
            if (addMaterialBtn) addMaterialBtn.style.display = 'none';
            if (exportMaterialsBtn) exportMaterialsBtn.style.display = 'none';
            if (importMaterialsBtn) importMaterialsBtn.style.display = 'none';
            await loadMaterialHistory(true);
            if (searchInput && searchInput.value) {
                filterMaterialHistory(searchInput.value.toLowerCase());
            }
        } else {
            isMaterialHistoryView = false;
            button.textContent = 'üìú –ò—Å—Ç–æ—Ä–∏—è';
            historyContainer.style.display = 'none';
            if (historyLoading) {
                historyLoading.style.display = 'none';
            }
            materialsContainer.style.display = 'block';
            if (addMaterialBtn) addMaterialBtn.style.display = '';
            if (exportMaterialsBtn) exportMaterialsBtn.style.display = '';
            if (importMaterialsBtn) importMaterialsBtn.style.display = '';
            if (searchInput) {
                filterMaterials({ target: searchInput });
            } else {
                displayMaterials(materials);
            }
        }
    }

    function filterMaterials(event) {
        const query = (event.target.value || '').toLowerCase();

        if (isMaterialHistoryView) {
            filterMaterialHistory(query);
            return;
        }

        if (!query) {
            displayMaterials(materials);
            return;
        }

        const filtered = materials.filter(material => {
            return [
                material.id,
                material.name,
                material.category,
                material.unit,
                material.quantity
            ].some(value => value !== undefined && value !== null && String(value).toLowerCase().includes(query));
        });

        displayMaterials(filtered);
    }

    function addNewMaterial() {
        const existingModal = document.getElementById('addMaterialModal');
        if (existingModal) {
            existingModal.remove();
        }

        const overlay = document.createElement('div');
        overlay.className = 'modal';
        overlay.id = 'addMaterialModal';
        overlay.style.display = 'flex';

        const content = document.createElement('div');
        content.className = 'modal-content';

        const title = document.createElement('h3');
        title.className = 'modal-title';
        title.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤';

        const subtitle = document.createElement('p');
        subtitle.className = 'modal-subtitle';
        subtitle.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –¥–æ–±–∞–≤—å—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.';

        const form = document.createElement('form');
        form.id = 'addMaterialForm';

        const itemsContainer = document.createElement('div');
        itemsContainer.id = 'addMaterialItemsContainer';
        itemsContainer.style.display = 'flex';
        itemsContainer.style.flexDirection = 'column';
        itemsContainer.style.gap = '12px';

        const addItemButton = document.createElement('button');
        addItemButton.type = 'button';
        addItemButton.className = 'secondary';
        addItemButton.textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ –º–∞—Ç–µ—Ä–∏–∞–ª';

        const actions = document.createElement('div');
        actions.className = 'modal-actions';

        const cancelButton = document.createElement('button');
        cancelButton.type = 'button';
        cancelButton.className = 'secondary';
        cancelButton.textContent = '–û—Ç–º–µ–Ω–∞';

        const submitButton = document.createElement('button');
        submitButton.type = 'submit';
        submitButton.className = 'success';
        submitButton.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';

        actions.appendChild(cancelButton);
        actions.appendChild(submitButton);

        form.appendChild(itemsContainer);
        form.appendChild(addItemButton);
        form.appendChild(actions);

        content.appendChild(title);
        content.appendChild(subtitle);
        content.appendChild(form);

        overlay.appendChild(content);
        document.body.appendChild(overlay);

        const availableCategories = Array.isArray(categories) && categories.length > 0
            ? categories.map(cat => cat.name).filter(Boolean)
            : [];
        const availableUnits = Array.isArray(UNITS) && UNITS.length > 0
            ? UNITS.slice()
            : ['—à—Ç'];

        function populateSelect(select, options, selectedValue = '', placeholder = '–ù–µ –≤—ã–±—Ä–∞–Ω–æ') {
            const uniqueOptions = Array.from(new Set((options || [])
                .map(option => (option ?? '').trim())
                .filter(option => option)));

            const parts = [];
            if (placeholder) {
                parts.push(`<option value=""${selectedValue ? '' : ' selected'}>${placeholder}</option>`);
            }

            uniqueOptions.forEach(option => {
                const isSelected = option === selectedValue;
                parts.push(`<option value="${option}"${isSelected ? ' selected' : ''}>${option}</option>`);
            });

            if (selectedValue && !uniqueOptions.includes(selectedValue)) {
                parts.push(`<option value="${selectedValue}" selected>${selectedValue}</option>`);
            }

            select.innerHTML = parts.join('');
        }

        function createMaterialItem(initialData = {}) {
            const item = document.createElement('div');
            item.className = 'report-work-item add-material-item';

            item.innerHTML = `
                <div class="modal-form-group">
                    <label>–†–∞–∑–¥–µ–ª</label>
                    <select class="editable" data-field="category"></select>
                </div>
                <div class="modal-form-group">
                    <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="editable" data-field="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞" value="${initialData.name || ''}" required>
                </div>
                <div class="modal-form-group">
                    <label>–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</label>
                    <select class="editable" data-field="unit"></select>
                </div>
                <div class="modal-form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" class="editable" data-field="quantity" step="1" min="0" value="${initialData.quantity ?? 0}">
                </div>
                <button type="button" class="secondary remove-add-material-button">–£–¥–∞–ª–∏—Ç—å</button>
            `;

            const categorySelect = item.querySelector('select[data-field="category"]');
            populateSelect(categorySelect, availableCategories, initialData.category || '', '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª');

            const unitSelect = item.querySelector('select[data-field="unit"]');
            populateSelect(unitSelect, availableUnits, initialData.unit || '', '–í—ã–±–µ—Ä–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è');

            const removeButton = item.querySelector('.remove-add-material-button');
            removeButton.addEventListener('click', () => {
                item.remove();
                if (!itemsContainer.querySelector('.add-material-item')) {
                    addMaterialEntry();
                }
            });

            return item;
        }

        function addMaterialEntry(initialData = {}) {
            const item = createMaterialItem(initialData);
            itemsContainer.appendChild(item);
        }

        addItemButton.addEventListener('click', () => addMaterialEntry());
        cancelButton.addEventListener('click', () => {
            overlay.remove();
        });

        overlay.addEventListener('click', event => {
            if (event.target === overlay) {
                overlay.remove();
            }
        });

        content.addEventListener('click', event => event.stopPropagation());

        addMaterialEntry();

        form.addEventListener('submit', async event => {
            event.preventDefault();

            const items = Array.from(itemsContainer.querySelectorAll('.add-material-item'));
            if (items.length === 0) {
                showNotification('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –º–∞—Ç–µ—Ä–∏–∞–ª', 'error');
                return;
            }

            const materialsPayload = [];

            for (const item of items) {
                const getField = selector => item.querySelector(selector);

                const categorySelect = getField('select[data-field="category"]');
                const nameInput = getField('input[data-field="name"]');
                const unitSelect = getField('select[data-field="unit"]');
                const quantityInput = getField('input[data-field="quantity"]');

                const name = (nameInput?.value || '').trim();
                const category = (categorySelect?.value || '').trim();
                const unit = (unitSelect?.value || '').trim();
                const quantity = parseFloat(quantityInput?.value || '0') || 0;

                if (!category) {
                    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –¥–ª—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞', 'error');
                    categorySelect.focus();
                    return;
                }

                if (!name) {
                    showNotification('–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º', 'error');
                    nameInput.focus();
                    return;
                }

                if (!unit) {
                    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è', 'error');
                    unitSelect.focus();
                    return;
                }

                if (quantity < 0) {
                    showNotification('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º', 'error');
                    quantityInput.focus();
                    return;
                }

                materialsPayload.push({
                    name,
                    category,
                    unit,
                    quantity,
                    performed_by: getCurrentUsername()
                });
            }

            submitButton.disabled = true;
            cancelButton.disabled = true;
            addItemButton.disabled = true;

            let successCount = 0;
            const errorMessages = [];

            for (const materialData of materialsPayload) {
                try {
                    showNotification(`–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ "${materialData.name}"...`, 'success');

                    const response = await makeApiRequest(API_CONFIG.ENDPOINTS.MATERIALS, {
                        method: 'POST',
                        body: JSON.stringify(materialData)
                    });

                    if (response && response.success) {
                        successCount++;
                    } else {
                        const errorMessage = response?.detail || response?.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª';
                        errorMessages.push(errorMessage);
                    }
                } catch (error) {
                    errorMessages.push('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞: ' + error.message);
                }
            }

            if (successCount > 0) {
                materialHistoryLoaded = false;
                await loadMaterials();
                overlay.remove();
                showNotification(`–ú–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ: ${successCount}`, 'success');
            } else {
                submitButton.disabled = false;
                cancelButton.disabled = false;
                addItemButton.disabled = false;
            }

            if (errorMessages.length > 0) {
                showNotification(errorMessages.join('\n'), 'error');
            }
        });
    }

    async function saveMaterial(materialId) {
        const row = document.querySelector(`#materialsTableBody tr[data-material-id="${materialId}"]`);
        if (!row) {
            showNotification('–°—Ç—Ä–æ–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
            return;
        }

        const inputs = row.querySelectorAll('.editable');
        const materialData = {};
        inputs.forEach(input => {
            const field = input.getAttribute('data-field');
            materialData[field] = input.value;
        });

        materialData.performed_by = getCurrentUsername();

        if (!materialData.name || !materialData.category || !materialData.unit) {
            showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞', 'error');
            return;
        }

        materialData.quantity = parseFloat(materialData.quantity);
        if (isNaN(materialData.quantity) || materialData.quantity < 0) {
            showNotification('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º –±–æ–ª—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω—ã–º –Ω—É–ª—é', 'error');
            return;
        }

        try {
            const response = await makeApiRequest(`${API_CONFIG.ENDPOINTS.MATERIALS}/${materialId}`, {
                method: 'PUT',
                body: JSON.stringify(materialData)
            });

            if (response && response.success) {
                showNotification('–ú–∞—Ç–µ—Ä–∏–∞–ª —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                materialHistoryLoaded = false;
                await loadMaterials();
            } else {
                const errorMessage = response?.detail || response?.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª';
                showNotification(errorMessage, 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞: ' + error.message, 'error');
        }
    }

    async function deleteMaterial(materialId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª?')) {
            return;
        }

        try {
            const response = await makeApiRequest(`${API_CONFIG.ENDPOINTS.MATERIALS}/${materialId}`, {
                method: 'DELETE'
            });

            if (response && response.success) {
                showNotification('–ú–∞—Ç–µ—Ä–∏–∞–ª —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω', 'success');
                materialHistoryLoaded = false;
                await loadMaterials();
            } else {
                const errorMessage = response?.detail || response?.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª';
                showNotification(errorMessage, 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞: ' + error.message, 'error');
        }
    }

    async function exportMaterialsToExcel() {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(buildApiUrl(API_CONFIG.ENDPOINTS.MATERIALS_EXPORT), {
                headers: token ? { 'Authorization': `Bearer ${token}` } : {}
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || '–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞');
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `materials_export_${new Date().toISOString().split('T')[0]}.xlsx`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);

            showNotification('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω', 'success');
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: ' + error.message, 'error');
        }
    }

    function triggerImportMaterials() {
        const importInput = document.getElementById('materialsImportInput');
        if (importInput) {
            importInput.click();
        }
    }

    async function handleMaterialsImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        event.target.value = '';

        try {
            const formData = new FormData();
            formData.append('file', file);

            const token = localStorage.getItem('token');
            const response = await fetch(buildApiUrl(API_CONFIG.ENDPOINTS.MATERIALS_IMPORT), {
                method: 'POST',
                headers: token ? { 'Authorization': `Bearer ${token}` } : {},
                body: formData
            });

            const responseText = await response.text();
            let result = {};
            try {
                result = responseText ? JSON.parse(responseText) : {};
            } catch (parseError) {
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
            }

            if (!response.ok || !result.success) {
                const errorMessage = result.detail || result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤';
                throw new Error(errorMessage);
            }

            await loadMaterials();
            materialHistoryLoaded = false;

            let message = result.message || '–ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω';
            if (result.errors && result.errors.length > 0) {
                message += `. –û—à–∏–±–æ–∫: ${result.errors.length}`;
                console.warn('–û—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤:', result.errors);
                showNotification(message, 'warning');
            } else {
                showNotification(message, 'success');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: ' + error.message, 'error');
        }
    }

    async function downloadMaterialsTemplate() {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(buildApiUrl(API_CONFIG.ENDPOINTS.MATERIALS_TEMPLATE), {
                headers: token ? { 'Authorization': `Bearer ${token}` } : {}
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || '–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —à–∞–±–ª–æ–Ω–∞');
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'materials_template.xlsx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);

            showNotification('–®–∞–±–ª–æ–Ω —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω', 'success');
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —à–∞–±–ª–æ–Ω–∞: ' + error.message, 'error');
        }
    }

    // ========== –ö–ê–¢–ï–ì–û–†–ò–ò ==========
    async function loadCategories() {
        try {
            const data = await makeApiRequest(API_CONFIG.ENDPOINTS.CATEGORIES);
            if (data.success) {
                categories = data.data || [];
                if (document.getElementById('works').classList.contains('active')) {
                    await loadWorks();
                }
                displayMaterials(materials);
                const foremanSectionsModal = document.getElementById('foremanSectionsModal');
                if (foremanSectionsModal && foremanSectionsModal.style.display === 'flex') {
                    populateForemanSectionsSelect();
                    displayForemanSectionsList();
                }
            } else {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞–∑–¥–µ–ª–æ–≤: ' + data.error, 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞–∑–¥–µ–ª–æ–≤: ' + error.message, 'error');
        }
    }
    
    function displayCategoriesInModal() {
        const categoriesList = document.getElementById('categoriesList');
        categoriesList.innerHTML = '';
        
        if (categories.length === 0) {
            categoriesList.innerHTML = '<div style="text-align: center; color: var(--accent); opacity: 0.7;">–ù–µ—Ç —Ä–∞–∑–¥–µ–ª–æ–≤</div>';
            return;
        }
        
        categories.forEach(category => {
            const categoryItem = document.createElement('div');
            categoryItem.className = 'category-item';
            categoryItem.dataset.categoryId = category.id;

            const nameSpan = document.createElement('span');
            nameSpan.className = 'category-name';
            nameSpan.textContent = category.name;

            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'category-actions';

            const editButton = document.createElement('button');
            editButton.className = 'secondary';
            editButton.textContent = '‚úèÔ∏è';
            editButton.addEventListener('click', () => startEditCategory(category.id));

            const deleteButton = document.createElement('button');
            deleteButton.className = 'danger';
            deleteButton.textContent = 'üóëÔ∏è';
            deleteButton.addEventListener('click', () => deleteCategory(category.id));

            actionsContainer.appendChild(editButton);
            actionsContainer.appendChild(deleteButton);

            categoryItem.appendChild(nameSpan);
            categoryItem.appendChild(actionsContainer);

            categoriesList.appendChild(categoryItem);
        });
    }

    function openCategoryModal() {
        displayCategoriesInModal();
        document.getElementById('categoryModal').style.display = 'flex';
        document.getElementById('newCategoryName').value = '';
        document.getElementById('newCategoryName').focus();
    }
    
    function closeCategoryModal() {
        document.getElementById('categoryModal').style.display = 'none';
    }

    function startEditCategory(categoryId) {
        const categoryItem = document.querySelector(`.category-item[data-category-id="${categoryId}"]`);
        if (!categoryItem) {
            return;
        }

        const category = categories.find(cat => cat.id === categoryId);
        if (!category) {
            return;
        }

        categoryItem.classList.add('editing');
        categoryItem.innerHTML = '';

        const input = document.createElement('input');
        input.type = 'text';
        input.value = category.name;
        input.className = 'login-input';
        input.setAttribute('data-category-edit', 'true');

        const actionsContainer = document.createElement('div');
        actionsContainer.className = 'category-actions';

        const saveButton = document.createElement('button');
        saveButton.className = 'success';
        saveButton.textContent = 'üíæ';
        saveButton.addEventListener('click', () => confirmEditCategory(categoryId));

        const cancelButton = document.createElement('button');
        cancelButton.className = 'secondary';
        cancelButton.textContent = '‚Ü©Ô∏è';
        cancelButton.addEventListener('click', () => cancelEditCategory(categoryId));

        actionsContainer.appendChild(saveButton);
        actionsContainer.appendChild(cancelButton);

        categoryItem.appendChild(input);
        categoryItem.appendChild(actionsContainer);

        input.focus();
        input.select();

        input.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                confirmEditCategory(categoryId);
            } else if (event.key === 'Escape') {
                event.preventDefault();
                cancelEditCategory(categoryId);
            }
        });
    }

    function cancelEditCategory(categoryId) {
        displayCategoriesInModal();
        const list = document.getElementById('categoriesList');
        if (list) {
            const item = list.querySelector(`.category-item[data-category-id="${categoryId}"] input[data-category-edit]`);
            if (item) {
                item.blur();
            }
        }
    }

    async function confirmEditCategory(categoryId) {
        const category = categories.find(cat => cat.id === categoryId);
        if (!category) {
            return;
        }

        const categoryItem = document.querySelector(`.category-item[data-category-id="${categoryId}"]`);
        const input = categoryItem ? categoryItem.querySelector('input[data-category-edit]') : null;
        const newName = input ? input.value.trim() : '';

        if (!newName) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞', 'error');
            if (input) {
                input.focus();
            }
            return;
        }

        if (category.name === newName) {
            displayCategoriesInModal();
            return;
        }

        try {
            showNotification('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞...', 'success');
            const response = await makeApiRequest(`${API_CONFIG.ENDPOINTS.CATEGORIES}/${categoryId}`, {
                method: 'PUT',
                body: JSON.stringify({ name: newName })
            });

            if (response && response.success) {
                showNotification('–†–∞–∑–¥–µ–ª —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                await loadCategories();
                displayCategoriesInModal();
            } else {
                const errorMessage = response?.error || response?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª';
                showNotification(`–û—à–∏–±–∫–∞: ${errorMessage}`, 'error');
                displayCategoriesInModal();
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–∞–∑–¥–µ–ª–∞: ' + error.message, 'error');
            displayCategoriesInModal();
        }
    }

    async function saveNewCategory() {
        const categoryName = document.getElementById('newCategoryName').value.trim();
        if (!categoryName) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞', 'error');
            return;
        }

        try {
            showNotification('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞...', 'success');
            const response = await fetch(buildApiUrl(API_CONFIG.ENDPOINTS.CATEGORIES), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({ name: categoryName })
            });
            
            const categoryAdded = await checkIfCategoryExists(categoryName);
            
            if (categoryAdded) {
                showNotification('–†–∞–∑–¥–µ–ª —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                document.getElementById('newCategoryName').value = '';
                displayCategoriesInModal();
                if (document.getElementById('works').classList.contains('active')) {
                    await loadWorks();
                }
            } else {
                let errorMessage = '–†–∞–∑–¥–µ–ª –Ω–µ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö';
                try {
                    const errorText = await response.text();
                    if (errorText) {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.detail || errorData.error || errorMessage;
                    }
                } catch (e) {}
                showNotification(`–û—à–∏–±–∫–∞: ${errorMessage}`, 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–∞–∑–¥–µ–ª–∞: ' + error.message, 'error');
        }
    }

    async function checkIfCategoryExists(categoryName, maxAttempts = 5) {
        for (let attempt = 0; attempt < maxAttempts; attempt++) {
            await loadCategories();
            const exists = categories.some(cat => cat.name === categoryName);
            if (exists) return true;
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        return false;
    }
    
    async function deleteCategory(categoryId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª?')) {
            return;
        }
        
        try {
            const categoryToDelete = categories.find(cat => cat.id === categoryId);
            if (!categoryToDelete) return;
            
            const categoryName = categoryToDelete.name;
            const response = await fetch(buildApiUrl(`${API_CONFIG.ENDPOINTS.CATEGORIES}/${categoryId}`), {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            await loadCategories();
            
            const categoryStillExists = categories.some(cat => cat.id === categoryId);
            
            if (!categoryStillExists) {
                showNotification('–†–∞–∑–¥–µ–ª —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω', 'success');
                displayCategoriesInModal();
                if (document.getElementById('works').classList.contains('active')) {
                    await loadWorks();
                }
            } else {
                let errorMessage = '–†–∞–∑–¥–µ–ª –Ω–µ –±—ã–ª —É–¥–∞–ª–µ–Ω –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö';
                try {
                    const errorText = await response.text();
                    if (errorText) {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.detail || errorData.error || errorMessage;
                    }
                } catch (e) {}
                showNotification(`–û—à–∏–±–∫–∞: ${errorMessage}`, 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–∞–∑–¥–µ–ª–∞: ' + error.message, 'error');
        }
    }

    // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ë–ê–õ–ê–ù–°–ê ==========
    function addBalance(workId) {
        const work = works.find(w => w.id === workId);
        if (!work) return;
        
        currentWorkIdForBalance = workId;
        currentWorkBalance = parseFloat(work['–ù–∞ –±–∞–ª–∞–Ω—Å–µ']) || 0;
        
        document.getElementById('balanceWorkName').textContent = work['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã'];
        document.getElementById('currentBalance').textContent = currentWorkBalance + ' ' + work['–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è'];
        document.getElementById('addBalanceAmount').value = '';
        document.getElementById('addBalanceModal').style.display = 'flex';
        document.getElementById('addBalanceAmount').focus();
    }

    function closeAddBalanceModal() {
        document.getElementById('addBalanceModal').style.display = 'none';
        currentWorkIdForBalance = null;
        currentWorkBalance = 0;
    }

    async function confirmAddBalance() {
        const amount = parseFloat(document.getElementById('addBalanceAmount').value);

        if (!amount || amount <= 0) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ', 'error');
            return;
        }
        
        try {
            const work = works.find(w => w.id === currentWorkIdForBalance);
            if (!work) {
                showNotification('–†–∞–±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                return;
            }
            
            showNotification('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫ –±–∞–ª–∞–Ω—Å—É...', 'success');
            
            const response = await fetch(buildApiUrl(`${API_CONFIG.ENDPOINTS.WORKS}/${currentWorkIdForBalance}/add-balance`), {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({ amount })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || `HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('–ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                closeAddBalanceModal();
                
                const balanceCell = document.querySelector(`tr:has(input[value="${currentWorkIdForBalance}"]) td:nth-child(6) input`);
                if (balanceCell) {
                    const newBalance = currentWorkBalance + amount;
                    balanceCell.value = newBalance;
                }
                
                const workIndex = works.findIndex(w => w.id === currentWorkIdForBalance);
                if (workIndex !== -1) {
                    works[workIndex]['–ù–∞ –±–∞–ª–∞–Ω—Å–µ'] = currentWorkBalance + amount;
                }
            } else {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞: ' + data.error, 'error');
            }
        } catch (error) {
            console.error('Add balance error:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞: ' + error.message, 'error');
        }
    }

    function addMaterialQuantity(materialId) {
        const material = materials.find(item => item.id === materialId);
        if (!material) {
            showNotification('–ú–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
            return;
        }

        currentMaterialIdForQuantity = materialId;
        currentMaterialQuantity = material.quantity !== undefined && material.quantity !== null
            ? Number(material.quantity)
            : 0;
        currentMaterialUnit = material.unit || '';

        const nameElement = document.getElementById('materialQuantityName');
        if (nameElement) {
            nameElement.textContent = material.name || `ID ${materialId}`;
        }

        const currentQuantityElement = document.getElementById('materialCurrentQuantity');
        if (currentQuantityElement) {
            const formattedQuantity = Number.isFinite(currentMaterialQuantity)
                ? currentMaterialQuantity.toLocaleString('ru-RU', { maximumFractionDigits: 2 })
                : '0';
            currentQuantityElement.textContent = currentMaterialUnit
                ? `${formattedQuantity} ${currentMaterialUnit}`
                : formattedQuantity;
        }

        const amountInput = document.getElementById('addMaterialQuantityAmount');
        if (amountInput) {
            amountInput.value = '';
            amountInput.focus();
        }

        const modal = document.getElementById('addMaterialQuantityModal');
        if (modal) {
            modal.style.display = 'flex';
        }
    }

    function closeAddMaterialQuantityModal() {
        const modal = document.getElementById('addMaterialQuantityModal');
        if (modal) {
            modal.style.display = 'none';
        }

        currentMaterialIdForQuantity = null;
        currentMaterialQuantity = 0;
        currentMaterialUnit = '';
    }

    async function confirmAddMaterialQuantity() {
        const amountInput = document.getElementById('addMaterialQuantityAmount');
        if (!amountInput) {
            showNotification('–ü–æ–ª–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
            return;
        }

        const amount = parseFloat(amountInput.value);

        if (!amount || amount <= 0) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ', 'error');
            return;
        }

        if (!currentMaterialIdForQuantity) {
            showNotification('–ú–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ –≤—ã–±—Ä–∞–Ω', 'error');
            return;
        }

        const materialId = currentMaterialIdForQuantity;
        const previousQuantity = currentMaterialQuantity;

        try {
            showNotification('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–∫–ª–∞–¥...', 'success');

            const response = await fetch(buildApiUrl(`${API_CONFIG.ENDPOINTS.MATERIALS}/${materialId}/add-quantity`), {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({
                    amount,
                    performed_by: getCurrentUsername(),
                    description: '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è'
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || `HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.success) {
                const newQuantity = previousQuantity + amount;
                showNotification('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                closeAddMaterialQuantityModal();
                materialHistoryLoaded = false;

                const quantityInput = document.querySelector(`#materialsTableBody tr[data-material-id="${materialId}"] input[data-field="quantity"]`);
                if (quantityInput) {
                    quantityInput.value = newQuantity;
                }

                const materialIndex = materials.findIndex(item => item.id === materialId);
                if (materialIndex !== -1) {
                    materials[materialIndex].quantity = newQuantity;
                }
            } else {
                const errorMessage = data.error || data.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ';
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞: ' + errorMessage, 'error');
            }
        } catch (error) {
            console.error('Add material quantity error:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞: ' + error.message, 'error');
        }
    }

    // ========== –ë–†–ò–ì–ê–î–ò–†–´ ==========
    async function loadForemen() {
        const loadingElement = document.getElementById('foremenLoading');
        const tableBody = document.getElementById('foremenTableBody');
        
        loadingElement.style.display = 'block';
        tableBody.innerHTML = '';
        
        try {
            const data = await makeApiRequest(API_CONFIG.ENDPOINTS.FOREMEN);
            
            if (data.success) {
                foremen = data.data || [];
                displayForemen(foremen);
            } else {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤: ' + data.error, 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤: ' + error.message, 'error');
        } finally {
            loadingElement.style.display = 'none';
        }
    }
    
    function displayForemen(foremenToDisplay) {
        const tableBody = document.getElementById('foremenTableBody');
        tableBody.innerHTML = '';
        
        if (foremenToDisplay.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –±—Ä–∏–≥–∞–¥–∏—Ä–∞—Ö</td></tr>';
            refreshTableSorting('foremenTable');
            return;
        }

        foremenToDisplay.forEach(foreman => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" value="${foreman.id}" readonly></td>
                <td><input type="text" value="${foreman.full_name || ''}" class="editable" data-field="full_name"></td>
                <td><input type="text" value="${foreman.position || ''}" class="editable" data-field="position"></td>
                <td><input type="text" value="${foreman.username || ''}" readonly></td>
                <td><input type="text" value="${foreman.registration_date || ''}" readonly></td>
                <td>
                    <select class="editable" data-field="is_active">
                        <option value="1" ${foreman.is_active ? 'selected' : ''}>‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω</option>
                        <option value="0" ${!foreman.is_active ? 'selected' : ''}>‚ùå –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</option>
                    </select>
                </td>
                <td class="action-buttons">
                    <button onclick="saveForeman(${foreman.id})" class="secondary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button onclick="openForemanSections(${foreman.id})" class="secondary" title="–ü—Ä–∏–≤—è–∑–∞—Ç—å —Ä–∞–∑–¥–µ–ª—ã">üßæ</button>
                    <button onclick="deleteForeman(${foreman.id})" class="danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </td>
            `;
            tableBody.appendChild(row);
        });

        refreshTableSorting('foremenTable');
    }

    async function openForemanSections(foremanId) {
        const modal = document.getElementById('foremanSectionsModal');
        if (!modal) {
            return;
        }

        const foreman = foremen.find(item => item.id === foremanId);
        if (!foreman) {
            showNotification('–ë—Ä–∏–≥–∞–¥–∏—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
            return;
        }

        currentForemanIdForSections = foremanId;
        const nameParts = [];
        if (foreman.full_name) {
            nameParts.push(foreman.full_name);
        }
        if (foreman.position) {
            nameParts.push(foreman.position);
        }
        document.getElementById('foremanSectionsName').textContent = nameParts.join(' ‚Ä¢ ') || `ID ${foremanId}`;

        if (!categories || categories.length === 0) {
            await loadCategories();
        }

        await loadForemanSections(foremanId);
        populateForemanSectionsSelect();
        displayForemanSectionsList();
        const select = document.getElementById('foremanSectionsSelect');
        if (select) {
            select.value = '';
        }

        modal.style.display = 'flex';
    }

    async function loadForemanSections(foremanId) {
        try {
            const response = await makeApiRequest(`${API_CONFIG.ENDPOINTS.FOREMEN}/${foremanId}/sections`);
            if (response && response.success) {
                currentForemanSections = (response.data || []).map(item => ({
                    id: item.id,
                    name: item.name
                }));
            } else {
                currentForemanSections = [];
                const errorMessage = response?.error || response?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞–∑–¥–µ–ª—ã –±—Ä–∏–≥–∞–¥–∏—Ä–∞';
                showNotification(errorMessage, 'error');
            }
        } catch (error) {
            currentForemanSections = [];
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞–∑–¥–µ–ª–æ–≤ –±—Ä–∏–≥–∞–¥–∏—Ä–∞: ' + error.message, 'error');
        }
    }

    function populateForemanSectionsSelect() {
        const select = document.getElementById('foremanSectionsSelect');
        if (!select) {
            return;
        }

        const assignedIds = new Set((currentForemanSections || []).map(item => item.id));

        if (!categories || categories.length === 0) {
            select.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤</option>';
            select.disabled = true;
            return;
        }

        let optionsHtml = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª</option>';
        categories.forEach(category => {
            const disabled = assignedIds.has(category.id) ? 'disabled' : '';
            optionsHtml += `<option value="${category.id}" ${disabled}>${category.name}</option>`;
        });

        select.innerHTML = optionsHtml;
        select.disabled = false;
    }

    function displayForemanSectionsList() {
        const listContainer = document.getElementById('foremanSectionsList');
        if (!listContainer) {
            return;
        }

        if (!currentForemanSections || currentForemanSections.length === 0) {
            listContainer.innerHTML = '<div class="foreman-sections-list-empty">–†–∞–∑–¥–µ–ª—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</div>';
            return;
        }

        const rows = currentForemanSections.map(section => `
            <div class="foreman-sections-list-item" data-section-id="${section.id}">
                <span>${section.name || `ID ${section.id}`}</span>
                <button type="button" class="danger" onclick="removeSectionFromForeman(${section.id})">üóëÔ∏è</button>
            </div>
        `);

        listContainer.innerHTML = rows.join('');
    }

    function addSectionToForeman() {
        const select = document.getElementById('foremanSectionsSelect');
        if (!select) {
            return;
        }

        const selectedValue = select.value;
        if (!selectedValue) {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è', 'error');
            return;
        }

        let categoryId;
        try {
            categoryId = parseInt(selectedValue, 10);
        } catch (e) {
            categoryId = NaN;
        }

        if (!Number.isInteger(categoryId) || categoryId <= 0) {
            showNotification('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ä–∞–∑–¥–µ–ª–∞', 'error');
            return;
        }

        if (currentForemanSections.some(section => section.id === categoryId)) {
            showNotification('–†–∞–∑–¥–µ–ª —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω', 'error');
            return;
        }

        const category = categories.find(cat => cat.id === categoryId);
        if (!category) {
            showNotification('–†–∞–∑–¥–µ–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ —Ä–∞–∑–¥–µ–ª–æ–≤', 'error');
            return;
        }

        currentForemanSections = [...currentForemanSections, { id: category.id, name: category.name }];
        displayForemanSectionsList();
        populateForemanSectionsSelect();
        select.value = '';
    }

    function removeSectionFromForeman(categoryId) {
        currentForemanSections = currentForemanSections.filter(section => section.id !== categoryId);
        displayForemanSectionsList();
        populateForemanSectionsSelect();
    }

    async function saveForemanSections() {
        if (!currentForemanIdForSections) {
            showNotification('–ù–µ –≤—ã–±—Ä–∞–Ω –±—Ä–∏–≥–∞–¥–∏—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–æ–≤', 'error');
            return;
        }

        const categoryIds = currentForemanSections.map(section => section.id);

        try {
            const response = await makeApiRequest(`${API_CONFIG.ENDPOINTS.FOREMEN}/${currentForemanIdForSections}/sections`, {
                method: 'PUT',
                body: JSON.stringify({ category_ids: categoryIds })
            });

            if (response && response.success) {
                const updatedSections = Array.isArray(response.data) ? response.data : null;
                if (updatedSections) {
                    currentForemanSections = updatedSections.map(item => ({ id: item.id, name: item.name }));
                    displayForemanSectionsList();
                    populateForemanSectionsSelect();
                }
                showNotification('–†–∞–∑–¥–µ–ª—ã –±—Ä–∏–≥–∞–¥–∏—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
            } else {
                const errorMessage = response?.error || response?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞–∑–¥–µ–ª—ã –±—Ä–∏–≥–∞–¥–∏—Ä–∞';
                showNotification(errorMessage, 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–∞–∑–¥–µ–ª–æ–≤: ' + error.message, 'error');
        }
    }

    function closeForemanSectionsModal() {
        const modal = document.getElementById('foremanSectionsModal');
        if (modal) {
            modal.style.display = 'none';
        }
        currentForemanIdForSections = null;
        currentForemanSections = [];
        const select = document.getElementById('foremanSectionsSelect');
        if (select) {
            select.value = '';
        }
        displayForemanSectionsList();
        populateForemanSectionsSelect();
    }

    async function saveForeman(foremanId) {
        const row = document.querySelector(`tr:has(input[value="${foremanId}"])`);
        const inputs = row.querySelectorAll('.editable');

        const foremanData = { id: foremanId };
        inputs.forEach(input => {
            const field = input.getAttribute('data-field');
            let value = input.value;
            
            if (field === 'is_active') value = parseInt(value);
            
            foremanData[field] = value;
        });
        
        try {
            const response = await makeApiRequest(`${API_CONFIG.ENDPOINTS.FOREMEN}/${foremanId}`, {
                method: 'PUT',
                body: JSON.stringify(foremanData)
            });
            
            if (response.success) {
                showNotification('–î–∞–Ω–Ω—ã–µ –±—Ä–∏–≥–∞–¥–∏—Ä–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
            } else {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±—Ä–∏–≥–∞–¥–∏—Ä–∞: ' + (response.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±—Ä–∏–≥–∞–¥–∏—Ä–∞: ' + error.message, 'error');
        }
    }

    async function deleteForeman(foremanId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –±—Ä–∏–≥–∞–¥–∏—Ä–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
            return;
        }
        
        try {
            const response = await makeApiRequest(`${API_CONFIG.ENDPOINTS.FOREMEN}/${foremanId}`, {
                method: 'DELETE'
            });
            
            if (response.success) {
                showNotification('–ë—Ä–∏–≥–∞–¥–∏—Ä —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω', 'success');
                await loadForemen();
            } else {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –±—Ä–∏–≥–∞–¥–∏—Ä–∞: ' + (response.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –±—Ä–∏–≥–∞–¥–∏—Ä–∞: ' + error.message, 'error');
        }
    }
    
    async function saveAllForemen() {
        const button = document.getElementById('saveAllForemen');
        const rows = document.querySelectorAll('#foremenTableBody tr');

        if (!rows.length) {
            showNotification('–ù–µ—Ç –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
            return;
        }

        if (button) {
            button.disabled = true;
        }

        const updates = [];

        rows.forEach(row => {
            const idInput = row.querySelector('td:first-child input');
            if (!idInput) {
                return;
            }

            const foremanId = parseInt(idInput.value, 10);
            if (!Number.isInteger(foremanId)) {
                return;
            }

            const foremanData = { id: foremanId };
            row.querySelectorAll('.editable').forEach(input => {
                const field = input.getAttribute('data-field');
                if (!field) {
                    return;
                }

                let value = input.value;
                if (field === 'is_active') {
                    value = parseInt(value, 10);
                }

                foremanData[field] = value;
            });

            updates.push(foremanData);
        });

        if (!updates.length) {
            if (button) {
                button.disabled = false;
            }
            showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
            return;
        }

        let successCount = 0;
        const failedIds = [];

        for (const foremanData of updates) {
            try {
                const response = await makeApiRequest(`${API_CONFIG.ENDPOINTS.FOREMEN}/${foremanData.id}`, {
                    method: 'PUT',
                    body: JSON.stringify(foremanData)
                });

                if (response && response.success) {
                    successCount += 1;
                } else {
                    failedIds.push(foremanData.id);
                }
            } catch (error) {
                console.error('Bulk foreman update error:', error);
                failedIds.push(foremanData.id);
            }
        }

        if (button) {
            button.disabled = false;
        }

        if (successCount > 0) {
            await loadForemen();
            showNotification(`–î–∞–Ω–Ω—ã–µ ${successCount} –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã`, 'success');
        }

        if (failedIds.length > 0) {
            showNotification(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–ª—è –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤: ${failedIds.join(', ')}`, 'error');
        }
    }
    
    function filterForemen() {
        const searchTerm = document.getElementById('searchForemen').value.toLowerCase();
        const filteredForemen = foremen.filter(foreman =>
            (foreman.full_name && foreman.full_name.toLowerCase().includes(searchTerm)) ||
            (foreman.position && foreman.position.toLowerCase().includes(searchTerm)) ||
            (foreman.username && foreman.username.toLowerCase().includes(searchTerm))
        );
        displayForemen(filteredForemen);
    }
    
    // ========== –û–¢–ß–ï–¢–´ ==========
    async function loadReports() {
        const loadingElement = document.getElementById('reportsLoading');
        const tableBody = document.getElementById('reportsTableBody');
        
        loadingElement.style.display = 'block';
        tableBody.innerHTML = '';
        
        try {
            reports = [];
            displayReports(reports);
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ç—á–µ—Ç–æ–≤: ' + error.message, 'error');
        } finally {
            loadingElement.style.display = 'none';
        }
    }
    
    function displayReports(reportsToDisplay) {
        const tableBody = document.getElementById('reportsTableBody');
        tableBody.innerHTML = '';

        if (reportsToDisplay.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Ç—á–µ—Ç–∞—Ö</td></tr>';
            refreshTableSorting('reportsTable');
            return;
        }

        refreshTableSorting('reportsTable');
    }
    
    function addNewReport() {
        showNotification('–§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏', 'success');
    }
    
    async function saveAllReports() {
        showNotification('–§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–æ–≤ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏', 'success');
    }
    
    function filterReports() {}

    // ========== –ù–ê–ö–û–ü–ò–¢–ï–õ–¨–ù–ê–Ø –í–ï–î–û–ú–û–°–¢–¨ ==========
    let accumulativeData = [];

    function initializeAccumulativeTab() {
        document.getElementById('refreshAccumulative').addEventListener('click', loadAccumulativeStatement);
        document.getElementById('exportAccumulative').addEventListener('click', exportAccumulativeToExcel);
        document.getElementById('searchAccumulative').addEventListener('input', filterAccumulative);
        document.getElementById('foremanFilterButton').addEventListener('click', toggleForemanDropdown);
        document.addEventListener('click', handleForemanDropdownOutsideClick);
    }

    async function loadAccumulativeStatement() {
        const loadingElement = document.getElementById('accumulativeLoading');
        const tableBody = document.getElementById('accumulativeTableBody');

        loadingElement.style.display = 'block';
        tableBody.innerHTML = '';

        try {
            const query = selectedAccumulativeForemanId ? `?foreman_id=${selectedAccumulativeForemanId}` : '';
            const data = await makeApiRequest(`/api/accumulative-statement${query}`);

            if (data.success) {
                accumulativeData = data.data || [];
                accumulativeForemen = data.foremen || [];
                updateAccumulativeForemanButton();
                populateForemanDropdown();
                displayAccumulativeStatement(accumulativeData);
            } else {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ–π –≤–µ–¥–æ–º–æ—Å—Ç–∏: ' + data.error, 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ–π –≤–µ–¥–æ–º–æ—Å—Ç–∏: ' + error.message, 'error');
        } finally {
            loadingElement.style.display = 'none';
        }
    }

    function updateAccumulativeForemanButton() {
        const button = document.getElementById('foremanFilterButton');
        if (!button) {
            return;
        }

        const selectedForeman = accumulativeForemen.find(foreman => String(foreman.id) === String(selectedAccumulativeForemanId));
        const label = selectedForeman ? selectedForeman.full_name : '–í—Å–µ –±—Ä–∏–≥–∞–¥–∏—Ä—ã';
        button.textContent = `üë∑ ${label}`;
    }

    function populateForemanDropdown() {
        const dropdownMenu = document.getElementById('foremanDropdownMenu');
        if (!dropdownMenu) {
            return;
        }

        dropdownMenu.innerHTML = '';

        const allOption = document.createElement('button');
        allOption.className = 'dropdown-item';
        allOption.type = 'button';
        allOption.textContent = '–í—Å–µ –±—Ä–∏–≥–∞–¥–∏—Ä—ã';
        allOption.addEventListener('click', () => selectAccumulativeForeman(null));
        dropdownMenu.appendChild(allOption);

        accumulativeForemen.forEach(foreman => {
            const option = document.createElement('button');
            option.className = 'dropdown-item';
            option.type = 'button';
            option.textContent = foreman.full_name || `ID ${foreman.id}`;
            option.addEventListener('click', () => selectAccumulativeForeman(foreman.id));
            dropdownMenu.appendChild(option);
        });
    }

    function toggleForemanDropdown(event) {
        event.stopPropagation();
        const dropdownMenu = document.getElementById('foremanDropdownMenu');
        if (!dropdownMenu) {
            return;
        }
        dropdownMenu.classList.toggle('show');
    }

    function handleForemanDropdownOutsideClick(event) {
        const dropdown = document.getElementById('accumulativeForemanDropdown');
        const dropdownMenu = document.getElementById('foremanDropdownMenu');

        if (!dropdown || !dropdownMenu) {
            return;
        }

        if (!dropdown.contains(event.target)) {
            dropdownMenu.classList.remove('show');
        }
    }

    function selectAccumulativeForeman(foremanId) {
        selectedAccumulativeForemanId = foremanId;
        updateAccumulativeForemanButton();
        const dropdownMenu = document.getElementById('foremanDropdownMenu');
        if (dropdownMenu) {
            dropdownMenu.classList.remove('show');
        }
        loadAccumulativeStatement();
    }

    function displayAccumulativeStatement(data) {
        const tableBody = document.getElementById('accumulativeTableBody');
        tableBody.innerHTML = '';
        
        if (data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            refreshTableSorting('accumulativeTable');
            return;
        }

        data.forEach(item => {
            const sectionName = item.–†–∞–∑–¥–µ–ª || item.–ö–∞—Ç–µ–≥–æ—Ä–∏—è || '';
            const row = document.createElement('tr');
            const quantityValue = Number(item.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ);
            const projectValue = Number(item.–ü—Ä–æ–µ–∫—Ç);
            const percentValue = Number(item['%–í—ã–ø–æ–ª–Ω–µ–Ω–∏—è']);
            const unitCost = Number(item['–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É'] ?? 0);
            const totalCost = Number(item['–°—É–º–º–∞'] ?? 0);
            row.innerHTML = `
                <td>${sectionName}</td>
                <td>${item.–†–∞–±–æ—Ç–∞}</td>
                <td>${item['–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è']}</td>
                <td data-sort-value="${Number.isFinite(unitCost) ? unitCost : ''}">${formatMoneyValue(unitCost)}</td>
                <td data-sort-value="${Number.isFinite(quantityValue) ? quantityValue : ''}">${item.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ}</td>
                <td data-sort-value="${Number.isFinite(projectValue) ? projectValue : ''}">${item.–ü—Ä–æ–µ–∫—Ç}</td>
                <td data-sort-value="${Number.isFinite(percentValue) ? percentValue : ''}">${item['%–í—ã–ø–æ–ª–Ω–µ–Ω–∏—è']}%</td>
                <td data-sort-value="${Number.isFinite(totalCost) ? totalCost : ''}">${formatMoneyValue(totalCost)}</td>
            `;
            tableBody.appendChild(row);
        });

        refreshTableSorting('accumulativeTable');
    }

    function filterAccumulative() {
        const searchTerm = document.getElementById('searchAccumulative').value.toLowerCase();
        const filteredData = accumulativeData.filter(item => {
            const sectionValue = (item.–†–∞–∑–¥–µ–ª || item.–ö–∞—Ç–µ–≥–æ—Ä–∏—è || '').toLowerCase();
            return sectionValue.includes(searchTerm) || item.–†–∞–±–æ—Ç–∞.toLowerCase().includes(searchTerm);
        });
        displayAccumulativeStatement(filteredData);
    }

    async function exportAccumulativeToExcel() {
        try {
            showNotification('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è...', 'success');
            
            const workbook = XLSX.utils.book_new();
            workbook.Props = {
                Title: "–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è –≤–µ–¥–æ–º–æ—Å—Ç—å",
                Subject: "–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è –≤–µ–¥–æ–º–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç",
                Author: "WiTech System",
                CreatedDate: new Date()
            };

            const exportData = accumulativeData.map(item => ({
                '–†–∞–∑–¥–µ–ª': item.–†–∞–∑–¥–µ–ª || item.–ö–∞—Ç–µ–≥–æ—Ä–∏—è || '',
                '–†–∞–±–æ—Ç–∞': item.–†–∞–±–æ—Ç–∞,
                '–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è': item['–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è'],
                '–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É': formatMoneyValue(item['–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É']),
                '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': item.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ,
                '–ü—Ä–æ–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ': item.–ü—Ä–æ–µ–∫—Ç,
                '% –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è': item['%–í—ã–ø–æ–ª–Ω–µ–Ω–∏—è'],
                '–°—É–º–º–∞': formatMoneyValue(item['–°—É–º–º–∞'])
            }));

            const worksheet = XLSX.utils.json_to_sheet(exportData);
            
            const colWidths = [
                { wch: 25 },
                { wch: 40 },
                { wch: 18 },
                { wch: 18 },
                { wch: 16 },
                { wch: 18 },
                { wch: 18 },
                { wch: 18 }
            ];
            worksheet['!cols'] = colWidths;

            XLSX.utils.book_append_sheet(workbook, worksheet, "–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è –≤–µ–¥–æ–º–æ—Å—Ç—å");

            const fileName = `accumulative_statement_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            showNotification('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω', 'success');
        } catch (error) {
            console.error('Export error:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ —Ñ–∞–π–ª–∞: ' + error.message, 'error');
        }
    }

    // ========== –í–°–ï –û–¢–ß–ï–¢–´ ==========
    async function loadAllReports() {
        const loadingElement = document.getElementById('allReportsLoading');
        const tableBody = document.getElementById('allReportsTableBody');
        
        loadingElement.style.display = 'block';
        tableBody.innerHTML = '';
        
        try {
            const data = await makeApiRequest(API_CONFIG.ENDPOINTS.ALL_REPORTS);
            
            if (data.success) {
                allReports = data.data || [];
                displayAllReportsTable(allReports);
            } else {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ç—á–µ—Ç–æ–≤: ' + data.error, 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ç—á–µ—Ç–æ–≤: ' + error.message, 'error');
        } finally {
            loadingElement.style.display = 'none';
        }
    }
    
    function displayAllReportsTable(reportsToDisplay) {
        const tableBody = document.getElementById('allReportsTableBody');
        tableBody.innerHTML = '';
        
        if (reportsToDisplay.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Ç—á–µ—Ç–∞—Ö</td></tr>';
            refreshTableSorting('allReportsTable');
            return;
        }

        reportsToDisplay.forEach(report => {
            const photoLink = report.photo_report_url ?
                `<a href="${report.photo_report_url}" target="_blank" style="color: var(--primary);">üì∑ –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å</a>` :
                '–ù–µ—Ç —Ñ–æ—Ç–æ';

            const isVerified = Boolean(report.is_verified);
            const verifyButtonClass = `verify-button${isVerified ? ' verified' : ''}`;
            const verifyButtonLabel = isVerified ? '‚úÖ' : '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
            const verifyButtonTitle = isVerified ? '–û—Ç—á–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω' : '–û—Ç–º–µ—Ç–∏—Ç—å –æ—Ç—á–µ—Ç –∫–∞–∫ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π';

            const quantityValue = Number(report.quantity);
            const dateSortValue = report.report_date
                ? String(report.report_date).replace(' ', 'T')
                : '';
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${report.id}</td>
                <td>${report.foreman_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                <td>${report.foreman_position || '‚Äî'}</td>
                <td>${report.work_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                <td data-sort-value="${Number.isFinite(quantityValue) ? quantityValue : ''}">${report.quantity} ${report.unit || '—à—Ç'}</td>
                <td data-sort-value="${dateSortValue}">${report.report_date}</td>
                <td>${report.report_time}</td>
                <td>${photoLink}</td>
                <td class="action-buttons">
                    <button onclick="editReport(${report.id})" class="secondary">‚úèÔ∏è</button>
                    <button onclick="deleteReport(${report.id})" class="danger">üóëÔ∏è</button>
                    <button onclick="toggleReportVerification(${report.id}, ${!isVerified})" class="${verifyButtonClass}" title="${verifyButtonTitle}">${verifyButtonLabel}</button>
                </td>
            `;
            tableBody.appendChild(row);
        });

        refreshTableSorting('allReportsTable');
    }
    
    async function deleteReport(reportId) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç—á–µ—Ç?')) {
            try {
                const response = await makeApiRequest(`${API_CONFIG.ENDPOINTS.REPORT}/${reportId}`, {
                    method: 'DELETE'
                });
                
                if (response.success) {
                    showNotification('–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω', 'success');
                    loadAllReports();
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞: ' + (response.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞: ' + error.message, 'error');
            }
        }
    }

    async function toggleReportVerification(reportId, shouldVerify) {
        try {
            const response = await makeApiRequest(`${API_CONFIG.ENDPOINTS.REPORT}/${reportId}/verify`, {
                method: 'POST',
                body: JSON.stringify({ is_verified: shouldVerify })
            });

            if (response.success) {
                const updatedStatus = response.data?.is_verified ?? shouldVerify;
                const reportIndex = allReports.findIndex(report => report.id === reportId);
                if (reportIndex !== -1) {
                    allReports[reportIndex].is_verified = updatedStatus;
                }

                const message = updatedStatus ? '–û—Ç—á–µ—Ç –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π' : '–û—Ç–º–µ—Ç–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–Ω—è—Ç–∞';
                showNotification(message, 'success');

                const searchInput = document.getElementById('searchAllReports');
                if (searchInput && searchInput.value.trim()) {
                    filterAllReports();
                } else {
                    displayAllReportsTable(allReports);
                }
            } else {
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏: ' + (response.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ' + error.message, 'error');
        }
    }

    function filterAllReports() {
        const searchInput = document.getElementById('searchAllReports');
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

        const filteredReports = allReports.filter(report =>
            (report.foreman_name && report.foreman_name.toLowerCase().includes(searchTerm)) ||
            (report.foreman_position && report.foreman_position.toLowerCase().includes(searchTerm)) ||
            (report.work_name && report.work_name.toLowerCase().includes(searchTerm)) ||
            (report.report_date && report.report_date.toLowerCase().includes(searchTerm))
        );
        displayAllReportsTable(filteredReports);
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    function showNotification(message, type) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 5000);
    }
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –≤–æ–ª–Ω
    const waves = document.querySelector('.waves');
    let waveOffset = 0;
    
    function animateWaves() {
        waveOffset += 0.5;
        waves.style.backgroundPositionX = -waveOffset + 'px';
        requestAnimationFrame(animateWaves);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
    document.addEventListener('DOMContentLoaded', function() {
        const addBalanceInput = document.getElementById('addBalanceAmount');
        if (addBalanceInput) {
            addBalanceInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmAddBalance();
                }
            });
        }

        const addMaterialQuantityInput = document.getElementById('addMaterialQuantityAmount');
        if (addMaterialQuantityInput) {
            addMaterialQuantityInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmAddMaterialQuantity();
                }
            });
        }
    });
    
    animateWaves();
    </script>
</body>
</html>