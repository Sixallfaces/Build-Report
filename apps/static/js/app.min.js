const API_CONFIG={BASE_URL:"https://build-report.ru/",ENDPOINTS:{WORKS:"api/works",ALL_WORKS:"api/all-works",MATERIALS:"api/materials",MATERIALS_HISTORY:"api/materials/history",MATERIALS_EXPORT:"api/materials/export",MATERIALS_IMPORT:"api/materials/import",MATERIALS_TEMPLATE:"api/materials/template",FOREMEN:"api/foremen",REPORTS:"api/reports",ALL_REPORTS:"api/all-reports",REPORT:"api/report",LOGIN:"api/site-login",CATEGORIES:"api/categories",ACCUMULATIVE:"api/accumulative-statement",WORK_REPORTS:"api/work-reports"}};function buildApiUrl(t){if(!t)return API_CONFIG.BASE_URL;if(/^https?:\/\//i.test(t))return t;return`${API_CONFIG.BASE_URL.replace(/\/+$/,"")}/${String(t).replace(/^\/+/,"")}`}let works=[],availableReportWorks=[],materials=[],foremen=[],reports=[],allReports=[],categories=[],currentWorkIdForMaterials=null,currentWorkMaterials=[],currentWorkPricing={unitCost:null,totalCost:null},currentMaterialIdForQuantity=null,currentMaterialQuantity=0,currentMaterialUnit="",currentMaterialIdForPricing=null,currentMaterialQuantityForPricing=0,currentMaterialPricing={unitCost:null,totalCost:null},materialHistory=[],materialHistoryLoaded=!1,isMaterialHistoryView=!1,currentForemanIdForSections=null,currentForemanSections=[],currentEditingReportId=null,accumulativeForemen=[],selectedAccumulativeForemanId=null;const tableSortStates=new Map,sortableTableConfigs={worksTable:{columns:{1:{type:"number"},2:{type:"string"},3:{type:"string"},4:{type:"string"},5:{type:"number"},6:{type:"number"},7:{type:"boolean"}},getRowId:t=>{const e=t.querySelector("td:nth-child(2) input");return e?parseInt(e.value,10):null}},materialsTable:{columns:{0:{type:"number"},1:{type:"string"},2:{type:"string"},3:{type:"string"},4:{type:"number"}},getRowId:t=>{const e=t.querySelector("td:first-child input");return e?parseInt(e.value,10):null}},materialHistoryTable:{columns:{0:{type:"number"},1:{type:"string"},2:{type:"string"},3:{type:"number"},4:{type:"number"},5:{type:"string"},6:{type:"string"},7:{type:"date"}}},foremenTable:{columns:{0:{type:"number"},1:{type:"string"},2:{type:"string"},3:{type:"string"},4:{type:"date"},5:{type:"boolean"}},getRowId:t=>{const e=t.querySelector("td:first-child input");return e?parseInt(e.value,10):null}},reportsTable:{columns:{0:{type:"number"},1:{type:"number"},2:{type:"number"},3:{type:"number"},4:{type:"date"},5:{type:"string"},6:{type:"string"}}},accumulativeTable:{columns:{0:{type:"string"},1:{type:"string"},2:{type:"string"},3:{type:"number"},4:{type:"number"},5:{type:"number"},6:{type:"number"},7:{type:"number"},8:{type:"number"},9:{type:"number"}}},allReportsTable:{columns:{0:{type:"number"},1:{type:"string"},2:{type:"string"},3:{type:"string"},4:{type:"number"},5:{type:"date"},6:{type:"string"},7:{type:"string"}}}};function refreshTableSorting(t){const e=sortableTableConfigs[t]||{},o=e.columns||{},r={};"function"==typeof e.getRowId&&(r.getRowId=e.getRowId),initializeSortableTable(t,o,r)}function initializeSortableTable(t,e={},o={}){const r=document.getElementById(t);if(!r)return;const n=r.querySelector("tbody");if(!n)return;const a=Array.from(n.querySelectorAll("tr"));a.forEach((t,e)=>{if("function"==typeof o.getRowId){const r=o.getRowId(t,e);null==r||Number.isNaN(r)?delete t.dataset.sortId:t.dataset.sortId=r}else delete t.dataset.sortId});const i={currentColumn:-1,direction:0,columnConfigs:e,getRowId:o.getRowId,originalRows:a.slice()};tableSortStates.set(t,i);r.querySelectorAll("th.sortable").forEach(e=>{e.dataset.tableId=t,e.dataset.columnIndex=e.cellIndex,e.classList.remove("sorted-asc","sorted-desc","sorted-default"),"true"!==e.dataset.sortListenerAttached&&(e.addEventListener("click",handleTableSortClick),e.dataset.sortListenerAttached="true")})}function handleTableSortClick(t){const e=t.currentTarget,o=e.dataset.tableId,r=parseInt(e.dataset.columnIndex,10);Number.isNaN(r)||sortTable(o,r)}function sortTable(t,e){const o=document.getElementById(t);if(!o)return;const r=o.querySelector("tbody");if(!r)return;const n=tableSortStates.get(t);if(!n)return;const a=Array.from(r.querySelectorAll("tr")),i=a.filter(t=>t.cells[e]);if(i.length<=1)return;if(n.originalRows&&n.originalRows.length===a.length||(n.originalRows=a.slice()),n.currentColumn!==e?(n.currentColumn=e,n.direction=1):0===n.direction?n.direction=1:1===n.direction?n.direction=-1:n.direction=0,0===n.direction)return n.originalRows.forEach(t=>r.appendChild(t)),updateSortIndicators(t,e,n.direction),void tableSortStates.set(t,n);const c=n.columnConfigs[e]||{};i.slice().sort((t,o)=>compareTableCells(t,o,e,c,n.direction)).forEach(t=>r.appendChild(t)),a.filter(t=>!i.includes(t)).forEach(t=>r.appendChild(t)),updateSortIndicators(t,e,n.direction),tableSortStates.set(t,n)}function compareTableCells(t,e,o,r,n){const a=t.cells[o],i=e.cells[o],c=getCellSortValue(a,r),s=getCellSortValue(i,r);let l;switch(r.type){case"number":l=parseNumber(c)-parseNumber(s);break;case"boolean":l=parseBoolean(c)-parseBoolean(s);break;case"date":l=parseDate(c)-parseDate(s);break;default:l=String(c??"").localeCompare(String(s??""),"ru",{sensitivity:"base",numeric:!1})}if(0===l){l=(t.dataset&&t.dataset.sortId?parseInt(t.dataset.sortId,10):t.rowIndex)-(e.dataset&&e.dataset.sortId?parseInt(e.dataset.sortId,10):e.rowIndex)}return l*n}function getCellSortValue(t,e){if(!t)return"";if(e&&"function"==typeof e.getValue)return e.getValue(t);if(t.dataset&&void 0!==t.dataset.sortValue)return t.dataset.sortValue;const o=t.querySelector("input, select, textarea");return o?o.value:t.textContent.trim()}function parseNumber(t){if("number"==typeof t)return Number.isFinite(t)?t:0;if("string"==typeof t){const e=t.replace(/\u00A0/g," ").replace(/\s+/g,"").replace(",",".").replace(/[^0-9+\-\.]/g,""),o=parseFloat(e);return Number.isFinite(o)?o:0}const e=Number(t);return Number.isFinite(e)?e:0}function parseBoolean(t){if("boolean"==typeof t)return t?1:0;if("number"==typeof t)return t?1:0;const e=String(t||"").toLowerCase().trim();return["1","true","–¥–∞","yes","–∞–∫—Ç–∏–≤–Ω–æ","‚úÖ –¥–æ—Å—Ç—É–ø–µ–Ω"].includes(e)?1:0}function parseDate(t){if(!t)return 0;if(t instanceof Date)return t.getTime();if("number"==typeof t)return t;if("string"==typeof t){const e=t.replace(" ","T"),o=Date.parse(e);return Number.isNaN(o)?0:o}return 0}function updateSortIndicators(t,e,o){const r=document.getElementById(t);if(!r)return;const n=r.querySelectorAll("th.sortable");n.forEach(t=>{t.classList.remove("sorted-asc","sorted-desc","sorted-default")});const a=Array.from(n).find(t=>parseInt(t.dataset.columnIndex,10)===e);a&&(1===o?a.classList.add("sorted-asc"):-1===o?a.classList.add("sorted-desc"):a.classList.add("sorted-default"))}let currentWorkIdForBalance=null,currentWorkBalance=0;const UNITS=["—à—Ç","–º","–º¬≤","–º¬≥","–∫–≥","—Ç","–ª","–ø.–º.","–∫–æ–º–ø–ª–µ–∫—Ç"];async function login(){const t=document.getElementById("username").value,e=document.getElementById("password").value,o=document.getElementById("loginError");if(!t||!e)return o.textContent="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å",void(o.style.display="block");try{const r=await fetch(buildApiUrl(API_CONFIG.ENDPOINTS.LOGIN),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,password:e})});if(!r.ok){let t="–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å";try{const e=await r.json();e?.error?t=e.error:e?.detail&&(t=Array.isArray(e.detail)?e.detail.map(t=>t.msg||t).join(", "):e.detail)}catch(t){console.error("Login error parse failed:",t)}return o.textContent=t,o.style.display="block",void(document.getElementById("password").value="")}const n=await r.json();n.success?(localStorage.setItem("authenticated","true"),localStorage.setItem("user",JSON.stringify(n.user)),localStorage.setItem("token",n.token||""),document.getElementById("loginOverlay").style.display="none",document.getElementById("mainContent").style.display="block",initializeApp()):(o.textContent=n.error||"–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å",o.style.display="block",document.getElementById("password").value="")}catch(t){console.error("Login error:",t),o.textContent="–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É",o.style.display="block",document.getElementById("password").value=""}}function checkAuth(){if("true"===localStorage.getItem("authenticated")){const t=localStorage.getItem("token"),e=localStorage.getItem("user");t&&e?(document.getElementById("loginOverlay").style.display="none",document.getElementById("mainContent").style.display="block",initializeApp()):showLoginForm()}else showLoginForm()}function showLoginForm(){document.getElementById("loginOverlay").style.display="flex",document.getElementById("mainContent").style.display="none",document.getElementById("username").value="",document.getElementById("password").value="",document.getElementById("loginError").style.display="none",document.getElementById("username").focus()}function logout(){localStorage.removeItem("authenticated"),localStorage.removeItem("user"),localStorage.removeItem("token"),showLoginForm()}async function makeApiRequest(t,e={}){const o=localStorage.getItem("token"),r={"Content-Type":"application/json",...e.headers};o&&(r.Authorization=`Bearer ${o}`);try{const o=buildApiUrl(t),n=await fetch(o,{headers:r,...e});if(401===n.status)return logout(),{success:!1,error:"–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞"};if(!n.ok){const t=await n.text();return console.error(`API Error: ${n.status} - ${t}`),{success:!1,error:`HTTP ${n.status}: ${t||"Unknown error"}`}}return await n.json()}catch(t){return console.error("API Request failed:",t),{success:!1,error:`Network error: ${t.message}`}}}function getCurrentUsername(){try{const t=localStorage.getItem("user");if(!t)return"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";const e=JSON.parse(t);return e?.username||e?.login||e?.name||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"}catch(t){return console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:",t),"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"}}function initializeApp(){initializeTabs(),initializeWorksTab(),initializeWorkMaterialsModal(),initializeMaterialPricingModal(),initializeMaterialsTab(),initializeForemenTab(),initializeReportsTab(),initializeAllReportsTab(),initializeSendReportFeature(),initializeEditReportFeature(),initializeAccumulativeTab(),loadWorks(),loadMaterials(),loadForemen(),loadReports(),loadAllReports(),loadCategories()}function initializeTabs(){const t=document.querySelectorAll(".tab");t.forEach(e=>{e.addEventListener("click",function(){const e=this.getAttribute("data-tab");t.forEach(t=>t.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active")),this.classList.add("active"),document.getElementById(e).classList.add("active"),"accumulative"===e?loadAccumulativeStatement():"materials"===e&&loadMaterials()})})}function initializeWorksTab(){document.getElementById("addWork").addEventListener("click",addNewWork),document.getElementById("addCategory").addEventListener("click",openCategoryModal),document.getElementById("saveAllWorks").addEventListener("click",saveAllWorks),document.getElementById("searchWorks").addEventListener("input",filterWorks),document.getElementById("exportWorks").addEventListener("click",exportWorksToExcel),document.getElementById("importWorks").addEventListener("click",triggerImportWorks),document.getElementById("importFileInput").addEventListener("change",handleWorksImport)}function initializeWorkMaterialsModal(){const t=document.getElementById("workMaterialAddButton");t&&t.addEventListener("click",t=>{t.preventDefault(),addMaterialToWorkList()});[{id:"workPriceUnit",field:"unitCost"},{id:"workPriceTotal",field:"totalCost"}].forEach(({id:t,field:e})=>{const o=document.getElementById(t);o&&(o.addEventListener("input",o=>{handlePricingInput(e,o.target.value),updateWorkPricingInputs(t)}),o.addEventListener("blur",()=>{updateWorkPricingInputs()}))});const e=document.getElementById("workMaterialsModal");e&&e.addEventListener("click",t=>{t.target===e&&t.stopPropagation()})}function initializeMaterialPricingModal(){[{id:"materialPriceUnit",field:"unitCost"}].forEach(({id:t,field:e})=>{const o=document.getElementById(t);o&&(o.addEventListener("input",o=>{handleMaterialPricingInput(e,o.target.value),updateMaterialPricingInputs(t)}),o.addEventListener("blur",()=>{updateMaterialPricingInputs()}))});const t=document.getElementById("materialPricingSaveButton");t&&t.addEventListener("click",t=>{t.preventDefault(),saveMaterialPricing()});const e=document.getElementById("materialPricingModal");e&&e.addEventListener("click",t=>{t.target===e&&t.stopPropagation()})}function initializeMaterialsTab(){const t=document.getElementById("addMaterial"),e=document.getElementById("exportMaterials"),o=document.getElementById("importMaterials"),r=document.getElementById("toggleMaterialsHistory"),n=document.getElementById("materialsImportInput"),a=document.getElementById("searchMaterials");t&&t.addEventListener("click",addNewMaterial),e&&e.addEventListener("click",exportMaterialsToExcel),o&&o.addEventListener("click",triggerImportMaterials),r&&r.addEventListener("click",toggleMaterialHistoryView),n&&n.addEventListener("change",handleMaterialsImport),a&&a.addEventListener("input",filterMaterials)}function initializeForemenTab(){document.getElementById("saveAllForemen").addEventListener("click",saveAllForemen),document.getElementById("searchForemen").addEventListener("input",filterForemen)}function initializeReportsTab(){document.getElementById("addReport").addEventListener("click",addNewReport),document.getElementById("saveAllReports").addEventListener("click",saveAllReports),document.getElementById("searchReports").addEventListener("input",filterReports)}function initializeAllReportsTab(){document.getElementById("refreshAllReports").addEventListener("click",loadAllReports),document.getElementById("searchAllReports").addEventListener("input",filterAllReports)}function initializeSendReportFeature(){const t=document.getElementById("openSendReportModal");t&&t.addEventListener("click",()=>{openSendReportModal()});const e=document.getElementById("sendReportModal");e&&e.addEventListener("click",t=>{t.target===e&&t.stopPropagation()});const o=document.getElementById("sendReportForm");o&&o.addEventListener("submit",submitSendReport);const r=document.getElementById("addReportWorkButton");r&&r.addEventListener("click",()=>addReportWorkItem())}async function openSendReportModal(){const t=document.getElementById("sendReportModal");if(!t)return;try{Array.isArray(foremen)&&0!==foremen.length||await loadForemen()}catch(t){console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –æ—Ç—á–µ—Ç–∞:",t)}try{Array.isArray(works)&&0!==works.length||await loadWorks()}catch(t){console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –æ—Ç—á–µ—Ç–∞:",t)}const e=populateSendReportOptions();resetSendReportForm(),updateSendReportAvailabilityMessage(e);const o=document.getElementById("submitReportButton");o&&(o.disabled=!(e.hasForemen&&e.hasWorks)),t.style.display="flex"}function closeSendReportModal(){const t=document.getElementById("sendReportModal");t&&(t.style.display="none")}function updateReportWorkSelectOptions(t,e){if(!t)return;const o=void 0!==e?e:t.value,r=['<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É</option>'];availableReportWorks.forEach(t=>{const e=t["–†–∞–∑–¥–µ–ª"]||t["–ö–∞—Ç–µ–≥–æ—Ä–∏—è"]||"",o=e?` ‚Äî ${e}`:"";r.push(`<option value="${t.id}">${t["–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã"]||t.id}${o}</option>`)}),t.innerHTML=r.join(""),o&&(t.value=String(o),t.value!==String(o)&&(t.value="")),t.disabled=0===availableReportWorks.length}function updateReportWorkItemDetails(t){if(!t)return;const e=t.querySelector(".report-work-select"),o=t.querySelector(".report-work-details"),r=t.querySelector(".report-work-unit"),n=t.querySelector(".report-work-quantity"),a=e?parseInt(e.value,10):NaN;if(!Number.isInteger(a))return o&&(o.textContent="–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å –∏ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è."),r&&(r.textContent=""),void(n&&(n.placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"));const i=Array.isArray(works)?works.find(t=>t&&t.id===a):null;if(!i)return o&&(o.textContent="–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ."),r&&(r.textContent=""),void(n&&(n.placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"));const c=i["–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è"]||"—à—Ç",s=i["–ù–∞ –±–∞–ª–∞–Ω—Å–µ"],l="number"==typeof s?s:parseFloat(s)||0,u=Number.isFinite(l)?l.toLocaleString("ru-RU",{maximumFractionDigits:2}):s,d=i["–†–∞–∑–¥–µ–ª"]||i["–ö–∞—Ç–µ–≥–æ—Ä–∏—è"]||"‚Äî";o&&(o.textContent=`–†–∞–∑–¥–µ–ª: ${d} ‚Ä¢ –ù–∞ –±–∞–ª–∞–Ω—Å–µ: ${u} ${c}`),r&&(r.textContent=c),n&&(n.placeholder=`–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (${c})`)}function updateRemoveReportWorkButtonsState(){const t=document.getElementById("reportWorksContainer");if(!t)return;const e=Array.from(t.querySelectorAll(".report-work-item")),o=e.length<=1;e.forEach(t=>{const e=t.querySelector(".remove-report-work-button");e&&(e.disabled=o,e.style.display=o?"none":"")})}function removeReportWorkItem(t){const e=document.getElementById("reportWorksContainer");e&&t&&(e.removeChild(t),updateRemoveReportWorkButtonsState())}function addReportWorkItem(t){const e=document.getElementById("reportWorksContainer");if(!e)return;const o=document.createElement("div");o.className="report-work-item";const r=document.createElement("select");r.className="report-work-select",r.required=!0,updateReportWorkSelectOptions(r,t),r.addEventListener("change",()=>updateReportWorkItemDetails(o));const n=document.createElement("div");n.className="quantity-input-wrapper";const a=document.createElement("input");a.type="number",a.min="0",a.step="0.01",a.placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ",a.required=!0,a.className="report-work-quantity";const i=document.createElement("span");i.className="report-work-unit",n.appendChild(a),n.appendChild(i);const c=document.createElement("p");c.className="modal-note report-work-details",c.textContent="–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å –∏ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è.";const s=document.createElement("button");s.type="button",s.className="secondary remove-report-work-button",s.textContent="–£–¥–∞–ª–∏—Ç—å",s.addEventListener("click",()=>removeReportWorkItem(o)),o.appendChild(r),o.appendChild(n),o.appendChild(c),o.appendChild(s),e.appendChild(o),updateReportWorkItemDetails(o),updateRemoveReportWorkButtonsState()}function resetSendReportForm(){const t=document.getElementById("sendReportForm");t&&t.reset();const e=new Date,o=document.getElementById("reportDate"),r=document.getElementById("reportTime");o&&(o.value=e.toISOString().slice(0,10)),r&&(r.value=e.toTimeString().slice(0,8));const n=document.getElementById("reportWorksContainer");n&&(n.innerHTML="",addReportWorkItem());const a=document.getElementById("addReportWorkButton");a&&(a.disabled=0===availableReportWorks.length),updateRemoveReportWorkButtonsState()}function populateSendReportOptions(){const t=document.getElementById("reportForemanSelect");let e=!1,o=!1;if(t){const o=(Array.isArray(foremen)?foremen:[]).filter(t=>t&&(void 0===t.is_active||t.is_active));if(o.length>0){const r=['<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–∏–≥–∞–¥–∏—Ä–∞</option>'].concat(o.slice().sort((t,e)=>(t.full_name||"").localeCompare(e.full_name||"")).map(t=>{const e=t.position?` ‚Ä¢ ${t.position}`:"";return`<option value="${t.id}">${t.full_name||t.id}${e}</option>`}));t.innerHTML=r.join(""),t.disabled=!1,e=!0}else t.innerHTML='<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤</option>',t.disabled=!0}availableReportWorks=(Array.isArray(works)?works:[]).filter(t=>t&&(void 0===t.is_active||Boolean(t.is_active))).slice().sort((t,e)=>(t["–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã"]||"").localeCompare(e["–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã"]||"")),o=availableReportWorks.length>0;const r=document.getElementById("reportWorksContainer");r&&r.querySelectorAll(".report-work-select").forEach(t=>{updateReportWorkSelectOptions(t);const e=t.closest(".report-work-item");e&&updateReportWorkItemDetails(e)});const n=document.getElementById("addReportWorkButton");return n&&(n.disabled=!o),{hasForemen:e,hasWorks:o}}function updateSendReportAvailabilityMessage(t){const e=document.getElementById("sendReportAvailabilityMessage");if(e){if(!t.hasForemen&&!t.hasWorks)return e.textContent="–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤ –∏ —Ä–∞–±–æ—Ç. –î–æ–±–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç.",void(e.style.display="block");if(!t.hasForemen)return e.textContent="–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –∏–ª–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ –±—Ä–∏–≥–∞–¥–∏—Ä–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ë—Ä–∏–≥–∞–¥–∏—Ä—ã¬ª.",void(e.style.display="block");if(!t.hasWorks)return e.textContent="–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞–±–æ—Ç. –î–æ–±–∞–≤—å—Ç–µ —Ä–∞–±–æ—Ç—É –∏–ª–∏ –≤–∫–ª—é—á–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–†–∞–±–æ—Ç—ã –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã¬ª.",void(e.style.display="block");e.textContent="",e.style.display="none"}}async function submitSendReport(t){t.preventDefault();const e=document.getElementById("reportForemanSelect"),o=document.getElementById("reportDate"),r=document.getElementById("reportTime"),n=document.getElementById("reportWorksContainer"),a=document.getElementById("submitReportButton");a&&(a.disabled=!0);try{const t=e?parseInt(e.value,10):NaN;if(!Number.isInteger(t))return void showNotification("–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–∏–≥–∞–¥–∏—Ä–∞ –¥–ª—è –æ—Ç—á–µ—Ç–∞","error");const a=new Date,i=o&&o.value?o.value:a.toISOString().slice(0,10);let c=r&&r.value?r.value:a.toTimeString().slice(0,8);5===c.length&&(c+=":00");const s=n?Array.from(n.querySelectorAll(".report-work-item")):[];if(0===s.length)return void showNotification("–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ä–∞–±–æ—Ç—É –¥–ª—è –æ—Ç—á–µ—Ç–∞","error");const l=[],u=new Set;for(const t of s){const e=t.querySelector(".report-work-select"),o=t.querySelector(".report-work-quantity"),r=e?parseInt(e.value,10):NaN,n=o?parseFloat(String(o.value).replace(",",".")):NaN;if(!Number.isInteger(r))return void showNotification("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ—Ç—á–µ—Ç–∞","error");if(u.has(r))return void showNotification("–ö–∞–∂–¥–∞—è —Ä–∞–±–æ—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã–±—Ä–∞–Ω–∞ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑","error");if(!Number.isFinite(n)||n<=0)return void showNotification("–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏","error");u.add(r),l.push({work_id:r,quantity:n})}if(0===l.length)return void showNotification("–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ä–∞–±–æ—Ç—É –¥–ª—è –æ—Ç—á–µ—Ç–∞","error");const d={foreman_id:t,report_date:i,report_time:c,works:l},m=await makeApiRequest(API_CONFIG.ENDPOINTS.WORK_REPORTS,{method:"POST",body:JSON.stringify(d)});if(!m||!m.success){return void showNotification(m?.error||m?.detail||"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç","error")}showNotification("–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω","success"),closeSendReportModal(),await loadWorks(),await loadAllReports()}catch(t){console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç—á–µ—Ç–∞:",t),showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç—á–µ—Ç–∞: "+t.message,"error")}finally{a&&(a.disabled=!1)}}function initializeEditReportFeature(){const t=document.getElementById("editReportModal");t&&t.addEventListener("click",e=>{e.target===t&&e.stopPropagation()});const e=document.getElementById("cancelEditReportButton");e&&e.addEventListener("click",closeEditReportModal);const o=document.getElementById("editReportWorkSelect");o&&o.addEventListener("change",()=>{const t=parseInt(o.value,10);updateEditReportWorkDetails(Number.isInteger(t)?t:null)});const r=document.getElementById("editReportForm");r&&r.addEventListener("submit",submitEditReportForm)}function showEditReportError(t){const e=document.getElementById("editReportError");e&&(t?(e.textContent=t,e.style.display="block"):(e.textContent="",e.style.display="none"))}function closeEditReportModal(){const t=document.getElementById("editReportModal");t&&(t.style.display="none");const e=document.getElementById("editReportForm");e&&e.reset(),showEditReportError(""),currentEditingReportId=null;const o=document.getElementById("editReportWorkUnit");o&&(o.textContent="");const r=document.getElementById("editReportWorkDetails");r&&(r.textContent="–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏.")}function populateEditReportForemanSelect(t){const e=document.getElementById("editReportForemanSelect");if(!e)return;const o=(Array.isArray(foremen)?foremen:[]).filter(t=>t&&(void 0===t.is_active||t.is_active));if(0===o.length)return e.innerHTML='<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤</option>',void(e.disabled=!0);const r=['<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–∏–≥–∞–¥–∏—Ä–∞</option>'].concat(o.slice().sort((t,e)=>(t.full_name||"").localeCompare(e.full_name||"")).map(t=>{const e=t.position?` ‚Ä¢ ${t.position}`:"";return`<option value="${t.id}">${t.full_name||t.id}${e}</option>`}));e.innerHTML=r.join(""),e.disabled=!1,t&&(e.value=String(t),e.value!==String(t)&&(e.value=""))}function populateEditReportWorkSelect(t){const e=document.getElementById("editReportWorkSelect");if(!e)return;const o=(Array.isArray(works)?works:[]).filter(t=>t&&(void 0===t.is_active||Boolean(t.is_active)));if(0===o.length)return e.innerHTML='<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–∞–±–æ—Ç</option>',void(e.disabled=!0);const r=['<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É</option>'].concat(o.slice().sort((t,e)=>(t["–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã"]||"").localeCompare(e["–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã"]||"")).map(t=>{const e=t["–†–∞–∑–¥–µ–ª"]||t["–ö–∞—Ç–µ–≥–æ—Ä–∏—è"]||"",o=e?` ‚Ä¢ ${e}`:"";return`<option value="${t.id}">${t["–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã"]||t.id}${o}</option>`}));e.innerHTML=r.join(""),e.disabled=!1,t&&(e.value=String(t),e.value!==String(t)&&(e.value=""))}function updateEditReportWorkDetails(t){const e=document.getElementById("editReportWorkDetails"),o=document.getElementById("editReportWorkUnit"),r=document.getElementById("editReportQuantity");if(!Number.isInteger(t))return e&&(e.textContent="–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏."),o&&(o.textContent=""),void(r&&(r.placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"));const n=Array.isArray(works)?works.find(e=>e&&e.id===t):null;if(!n)return e&&(e.textContent="–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ."),o&&(o.textContent=""),void(r&&(r.placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"));const a=n["–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è"]||"—à—Ç",i=n["–ù–∞ –±–∞–ª–∞–Ω—Å–µ"],c="number"==typeof i?i:parseFloat(i),s=Number.isFinite(c)?c.toLocaleString("ru-RU",{maximumFractionDigits:2}):i||"0",l=n["–†–∞–∑–¥–µ–ª"]||n["–ö–∞—Ç–µ–≥–æ—Ä–∏—è"]||"‚Äî";e&&(e.textContent=`–†–∞–∑–¥–µ–ª: ${l} ‚Ä¢ –ù–∞ –±–∞–ª–∞–Ω—Å–µ: ${s} ${a}`),o&&(o.textContent=a),r&&(r.placeholder=`–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (${a})`)}async function editReport(t){const e=document.getElementById("editReportModal");if(!e)return void showNotification("–û–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ","error");showEditReportError(""),currentEditingReportId=t;const o=document.getElementById("saveEditReportButton");o&&(o.disabled=!0);try{Array.isArray(foremen)&&0!==foremen.length||await loadForemen(),Array.isArray(works)&&0!==works.length||await loadWorks()}catch(t){console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—Ç—á–µ—Ç–∞:",t)}populateEditReportForemanSelect(null),populateEditReportWorkSelect(null),updateEditReportWorkDetails(null);try{const o=await makeApiRequest(`${API_CONFIG.ENDPOINTS.REPORT}/${t}`);if(!o||!o.success||!o.data){return showNotification(o?.error||o?.detail||"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞","error"),void(currentEditingReportId=null)}const r=o.data;populateEditReportForemanSelect(r.foreman_id),populateEditReportWorkSelect(r.work_id);const n=Number.isInteger(r.work_id)?r.work_id:parseInt(r.work_id,10);updateEditReportWorkDetails(Number.isInteger(n)?n:null);const a=document.getElementById("editReportQuantity");a&&(a.value=r.quantity??"");const i=document.getElementById("editReportDate");i&&(i.value=r.report_date||"");const c=document.getElementById("editReportTime");if(c){const t=(r.report_time||"").toString();c.value=t.length>8?t.slice(0,8):t}const s=document.getElementById("editReportPhoto");s&&(s.value=r.photo_report_url||"");const l=document.getElementById("editReportForemanSelect");l&&r.foreman_id&&(l.value=String(r.foreman_id),l.value!==String(r.foreman_id)&&(l.value=""));const u=document.getElementById("editReportWorkSelect");u&&r.work_id&&(u.value=String(r.work_id),u.value!==String(r.work_id)&&(u.value="")),e.style.display="flex"}catch(t){console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–∞:",t),showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ç—á–µ—Ç–∞: "+t.message,"error"),currentEditingReportId=null}finally{o&&(o.disabled=!1)}}async function submitEditReportForm(t){if(t.preventDefault(),!currentEditingReportId)return void showNotification("–û—Ç—á–µ—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω","error");const e=document.getElementById("editReportForemanSelect"),o=document.getElementById("editReportWorkSelect"),r=document.getElementById("editReportQuantity"),n=document.getElementById("editReportDate"),a=document.getElementById("editReportTime"),i=document.getElementById("editReportPhoto"),c=document.getElementById("saveEditReportButton"),s=e?parseInt(e.value,10):NaN,l=o?parseInt(o.value,10):NaN,u=r?parseFloat(r.value):NaN,d=n?n.value:"",m=a?a.value:"",p=i?i.value.trim():"";if(!Number.isInteger(s))return void showEditReportError("–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–∏–≥–∞–¥–∏—Ä–∞");if(!Number.isInteger(l))return void showEditReportError("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É");if(!Number.isFinite(u)||u<=0)return void showEditReportError("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–±–æ–ª—å—à–µ 0)");if(!d)return void showEditReportError("–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –æ—Ç—á–µ—Ç–∞");if(!m)return void showEditReportError("–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –æ—Ç—á–µ—Ç–∞");showEditReportError("");const f={foreman_id:s,work_id:l,quantity:u,report_date:d,report_time:m};p&&(f.photo_report_url=p),c&&(c.disabled=!0);try{const t=await makeApiRequest(`${API_CONFIG.ENDPOINTS.REPORT}/${currentEditingReportId}`,{method:"PUT",body:JSON.stringify(f)});if(!t||!t.success){return void showEditReportError(t?.error||t?.detail||"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞")}showNotification(t.message||"–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω","success"),closeEditReportModal(),await loadWorks(),await loadAllReports()}catch(t){console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞:",t),showEditReportError("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞: "+t.message)}finally{c&&(c.disabled=!1)}}async function loadWorks(){const t=document.getElementById("worksLoading"),e=document.getElementById("worksTableBody");t.style.display="block",e.innerHTML="";try{const t=await makeApiRequest("/api/all-works");t.success?(works=t.data||[],displayWorks(works)):showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞–±–æ—Ç: "+t.error,"error")}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞–±–æ—Ç: "+t.message,"error")}finally{t.style.display="none"}}function displayWorks(t){const e=document.getElementById("worksTableBody");if(e.innerHTML="",0===t.length)return e.innerHTML='<tr><td colspan="9" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞–±–æ—Ç–∞—Ö</td></tr>',void refreshTableSorting("worksTable");t.forEach(t=>{const o=t.–†–∞–∑–¥–µ–ª||t["–ö–∞—Ç–µ–≥–æ—Ä–∏—è"]||"",r=categories.map(t=>`<option value="${t.name}" ${t.name===o?"selected":""}>${t.name}</option>`).join(""),n=o&&!categories.find(t=>t.name===o)?`<option value="${o}" selected>${o}</option>`:"",a=document.createElement("tr");a.innerHTML=`\n                <td class="checkbox-cell">\n                    <input type="checkbox" class="work-checkbox" value="${t.id}">\n                </td>\n                <td><input type="text" value="${t.id}" readonly></td>\n                <td>\n                    <select class="editable" data-field="category">\n                        ${r}\n                        ${n}\n                    </select>\n                </td>\n                <td><input type="text" value="${t["–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã"]}" class="editable" data-field="name"></td>\n                <td>\n                    <select class="editable" data-field="unit">\n                        ${UNITS.map(e=>`<option value="${e}" ${e===t["–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è"]?"selected":""}>${e}</option>`).join("")}\n                        <option value="${t["–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è"]}" ${UNITS.includes(t["–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è"])?"":"selected"}>${t["–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è"]}</option>\n                    </select>\n                </td>\n                <td><input type="number" value="${t["–ù–∞ –±–∞–ª–∞–Ω—Å–µ"]}" class="editable" data-field="balance" step="1"></td>\n                <td><input type="number" value="${t["–ü—Ä–æ–µ–∫—Ç"]||0}" class="editable" data-field="project_total" step="1"></td>\n                <td>\n                    <select class="editable" data-field="is_active">\n                        <option value="1" ${t.is_active?"selected":""}>–î–∞</option>\n                        <option value="0" ${t.is_active?"":"selected"}>–ù–µ—Ç</option>\n                    </select>\n                </td>\n                <td class="action-buttons">\n                    <button onclick="saveWork(${t.id})" class="secondary">üíæ</button>\n                    <button onclick="openWorkMaterials(${t.id})" class="secondary" title="–ú–∞—Ç–µ—Ä–∏–∞–ª—ã —Ä–∞–±–æ—Ç—ã">üßæ</button>\n                    <button onclick="addBalance(${t.id})" class="success" title="–î–æ–±–∞–≤–∏—Ç—å –∫ –±–∞–ª–∞–Ω—Å—É">‚ûï</button>\n                    <button onclick="deleteWork(${t.id})" class="danger">üóëÔ∏è</button>\n                </td>\n            `,e.appendChild(a)}),initializeWorkCheckboxes(),refreshTableSorting("worksTable")}function populateWorkMaterialSelect(){const t=document.getElementById("workMaterialSelect");if(!t)return;const e=new Set(currentWorkMaterials.map(t=>t.material_id)),o=Array.isArray(materials)&&materials.length>0;let r='<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª</option>';o?materials.forEach(t=>{const o=[];o.push(t.name||`ID ${t.id}`),t.unit&&o.push(t.unit),t.category&&o.push(t.category);const n=o.join(" ‚Ä¢ "),a=e.has(t.id)?"disabled":"";r+=`<option value="${t.id}" ${a}>${n}</option>`}):r='<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</option>',t.innerHTML=r,t.disabled=!o}function displayWorkMaterialsList(){const t=document.getElementById("workMaterialsTableBody");if(!t)return;if(!currentWorkMaterials||0===currentWorkMaterials.length)return void(t.innerHTML='<tr><td colspan="6" style="text-align: center;">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</td></tr>');const e=currentWorkMaterials.map(t=>{const e=Number(t.available_quantity),o=Number.isFinite(e)?e.toLocaleString("ru-RU",{maximumFractionDigits:2}):"0",r=Number(t.quantity_per_unit),n=Number.isFinite(r)?r:0;return`\n                <tr data-material-id="${t.material_id}">\n                    <td>${t.material_name||`ID ${t.material_id}`}</td>\n                    <td>${t.unit||""}</td>\n                    <td>${t.category||""}</td>\n                    <td>${o}</td>\n                    <td><input type="number" min="0" step="1" value="${n}" oninput="handleWorkMaterialQuantityChange(${t.material_id}, this.value)"></td>\n                    <td class="action-buttons">\n                        <button type="button" class="danger" onclick="removeMaterialFromWork(${t.material_id})">üóëÔ∏è</button>\n                    </td>\n                </tr>\n            `}).join("");t.innerHTML=e}function roundMoneyValue(t){const e=Number(t);return Number.isFinite(e)?Math.round(100*(e+Number.EPSILON))/100:null}function normalizeCostValue(t){if(null==t)return null;const e=Number(t);return Number.isFinite(e)?e<0?0:roundMoneyValue(e):null}function parseMoneyInput(t){if(null==t)return null;const e=String(t).replace(",",".").trim();if(""===e)return null;const o=parseFloat(e);return Number.isNaN(o)||o<0?0:o}function formatMoneyValue(t){return null==t?"":Number(t).toFixed(2)}function updateWorkPricingInputs(t=[]){const e=Array.isArray(t)?new Set(t):new Set([t]),o=document.getElementById("workPriceUnit"),r=document.getElementById("workPriceTotal"),n="number"==typeof currentWorkPricing.unitCost?roundMoneyValue(Math.max(currentWorkPricing.unitCost,0)):null,a="number"==typeof currentWorkPricing.totalCost?roundMoneyValue(Math.max(currentWorkPricing.totalCost,0)):null;o&&!e.has("workPriceUnit")&&(o.value=formatMoneyValue(n)),r&&!e.has("workPriceTotal")&&(r.value=formatMoneyValue(a))}function handlePricingInput(t,e){const o=parseMoneyInput(e);"unitCost"===t?currentWorkPricing.unitCost=null===o?null:roundMoneyValue(o):"totalCost"===t&&(currentWorkPricing.totalCost=null===o?null:roundMoneyValue(o))}function resetWorkPricing(){currentWorkPricing={unitCost:null,totalCost:null},updateWorkPricingInputs()}function updateMaterialPricingInputs(t=[]){const e=Array.isArray(t)?new Set(t):new Set([t]),o=document.getElementById("materialPriceUnit"),r=document.getElementById("materialPriceTotal"),n=document.getElementById("materialPriceQuantity"),a="number"==typeof currentMaterialPricing.unitCost?roundMoneyValue(Math.max(currentMaterialPricing.unitCost,0)):null,i=Number.isFinite(currentMaterialQuantityForPricing)?Math.max(currentMaterialQuantityForPricing,0):null;let c="number"==typeof currentMaterialPricing.totalCost?roundMoneyValue(Math.max(currentMaterialPricing.totalCost,0)):null;"number"==typeof a&&"number"==typeof i&&(c=roundMoneyValue(a*i),currentMaterialPricing.totalCost=c),o&&!e.has("materialPriceUnit")&&(o.value=formatMoneyValue(a)),n&&!e.has("materialPriceQuantity")&&(n.value=null!==i?i:""),r&&!e.has("materialPriceTotal")&&(r.value=formatMoneyValue(c))}function handleMaterialPricingInput(t,e){const o=parseMoneyInput(e);"unitCost"===t?currentMaterialPricing.unitCost=null===o?null:roundMoneyValue(o):"totalCost"===t&&(currentMaterialPricing.totalCost=null===o?null:roundMoneyValue(o))}function resetMaterialPricing(){currentMaterialPricing={unitCost:null,totalCost:null},updateMaterialPricingInputs()}async function loadMaterialPricing(t){try{const e=await makeApiRequest(`/api/materials/${t}/pricing`);if(e&&e.success){const t=e.data||{};currentMaterialPricing={unitCost:normalizeCostValue(t.unit_cost_without_vat),totalCost:normalizeCostValue(t.total_cost_without_vat)}}else{const t=e?.error||e?.detail;resetMaterialPricing(),t&&showNotification("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∞: "+t,"error")}}catch(t){resetMaterialPricing(),showNotification("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞: "+t.message,"error")}updateMaterialPricingInputs()}async function openMaterialPricing(t){const e=document.getElementById("materialPricingModal");if(!e)return;const o=materials.find(e=>e.id===t);if(!o)return void showNotification("–ú–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω","error");currentMaterialIdForPricing=t;const r=document.getElementById("materialPricingName");if(r){const e=o.unit?` (${o.unit})`:"";r.textContent=`${o.name||`ID ${t}`}${e}`}currentMaterialQuantityForPricing=Number.isFinite(Number(o.quantity))?Number(o.quantity):0,resetMaterialPricing(),e.style.display="flex",await loadMaterialPricing(t)}async function saveMaterialPricing(){if(!currentMaterialIdForPricing)return void showNotification("–ú–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ –≤—ã–±—Ä–∞–Ω","error");const t=document.getElementById("materialPricingSaveButton");t&&(t.disabled=!0);const e={unit_cost_without_vat:"number"==typeof currentMaterialPricing.unitCost&&roundMoneyValue(Math.max(currentMaterialPricing.unitCost,0))||0,total_cost_without_vat:"number"==typeof currentMaterialPricing.totalCost&&roundMoneyValue(Math.max(currentMaterialPricing.totalCost,0))||0};try{const t=await makeApiRequest(`/api/materials/${currentMaterialIdForPricing}/pricing`,{method:"PUT",body:JSON.stringify(e)});if(t&&t.success){const o=t.data||e;currentMaterialPricing={unitCost:normalizeCostValue(o.unit_cost_without_vat),totalCost:normalizeCostValue(o.total_cost_without_vat)},updateMaterialPricingInputs();const r=materials.findIndex(t=>t.id===currentMaterialIdForPricing);-1!==r&&(materials[r]={...materials[r],unit_cost_without_vat:currentMaterialPricing.unitCost||0,total_cost_without_vat:currentMaterialPricing.totalCost||0}),showNotification(t.message||"–°—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞","success")}else{showNotification(t?.error||t?.detail||t?.message||"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∞","error")}}catch(t){showNotification("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞: "+t.message,"error")}finally{t&&(t.disabled=!1)}}function closeMaterialPricingModal(){const t=document.getElementById("materialPricingModal");t&&(t.style.display="none"),currentMaterialIdForPricing=null,currentMaterialQuantityForPricing=0,resetMaterialPricing()}async function loadWorkMaterials(t){try{const e=await makeApiRequest(`/api/works/${t}/materials`);if(e&&e.success){const t=Array.isArray(e.data)?e.data:[];currentWorkMaterials=t.map(t=>({material_id:t.material_id,material_name:t.material_name||`ID ${t.material_id}`,unit:t.unit,category:t.category,quantity_per_unit:parseFloat(t.quantity_per_unit)||0,available_quantity:void 0!==t.available_quantity?Number(t.available_quantity):0})),e.pricing&&"object"==typeof e.pricing?(currentWorkPricing={unitCost:normalizeCostValue(e.pricing.unit_cost_without_vat),totalCost:normalizeCostValue(e.pricing.total_cost_without_vat)},updateWorkPricingInputs()):resetWorkPricing()}else{currentWorkMaterials=[],resetWorkPricing();const t=e?.error||e?.detail;t&&showNotification("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Ä–∞–±–æ—Ç—ã: "+t,"error")}}catch(t){currentWorkMaterials=[],resetWorkPricing(),showNotification("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Ä–∞–±–æ—Ç—ã: "+t.message,"error")}populateWorkMaterialSelect(),displayWorkMaterialsList(),updateWorkPricingInputs()}async function openWorkMaterials(t){const e=document.getElementById("workMaterialsModal");if(!e)return;const o=works.find(e=>e.id===t);if(!o)return void showNotification("–†–∞–±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞","error");currentWorkIdForMaterials=t;const r=document.getElementById("workMaterialsWorkName");if(r){const t=o["–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è"]?` (${o["–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è"]})`:"";r.textContent=`${o["–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã"]}${t}`}const n=document.getElementById("workMaterialSelect"),a=document.getElementById("workMaterialQuantity");n&&(n.value=""),a&&(a.value="");const i=document.getElementById("workMaterialsTableBody");i&&(i.innerHTML='<tr><td colspan="6" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>'),resetWorkPricing(),e.style.display="flex",materials&&0!==materials.length||await loadMaterials(),await loadWorkMaterials(t)}function addMaterialToWorkList(){const t=document.getElementById("workMaterialSelect"),e=document.getElementById("workMaterialQuantity");if(!t||!e)return;const o=parseInt(t.value,10),r=parseFloat(e.value);if(!o)return void showNotification("–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è","error");if(isNaN(r)||r<=0)return void showNotification("–í–≤–µ–¥–∏—Ç–µ —Ä–∞—Å—Ö–æ–¥ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –±–æ–ª—å—à–µ 0","error");const n=materials.find(t=>t.id===o);if(!n)return void showNotification("–ú–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω","error");const a=Number(r),i=currentWorkMaterials.find(t=>t.material_id===o);i?(i.quantity_per_unit=a,i.material_name=n.name||i.material_name,i.unit=n.unit,i.category=n.category,i.available_quantity=void 0!==n.quantity?Number(n.quantity):i.available_quantity):currentWorkMaterials.push({material_id:o,material_name:n.name||`ID ${o}`,unit:n.unit,category:n.category,quantity_per_unit:a,available_quantity:void 0!==n.quantity?Number(n.quantity):0}),e.value="",t.value="",populateWorkMaterialSelect(),displayWorkMaterialsList()}function handleWorkMaterialQuantityChange(t,e){const o=currentWorkMaterials.find(e=>e.material_id===t);if(!o)return;let r=parseFloat(e);(isNaN(r)||r<0)&&(r=0),o.quantity_per_unit=r}function removeMaterialFromWork(t){currentWorkMaterials=currentWorkMaterials.filter(e=>e.material_id!==t),populateWorkMaterialSelect(),displayWorkMaterialsList()}async function saveWorkMaterials(){if(!currentWorkIdForMaterials)return void showNotification("–ù–µ –≤—ã–±—Ä–∞–Ω–∞ —Ä–∞–±–æ—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤","error");const t={materials:currentWorkMaterials.map(t=>({material_id:t.material_id,quantity_per_unit:Number(t.quantity_per_unit)||0})),pricing:{unit_cost_without_vat:"number"==typeof currentWorkPricing.unitCost&&roundMoneyValue(Math.max(currentWorkPricing.unitCost,0))||0,total_cost_without_vat:"number"==typeof currentWorkPricing.totalCost&&roundMoneyValue(Math.max(currentWorkPricing.totalCost,0))||0}};try{const e=await makeApiRequest(`/api/works/${currentWorkIdForMaterials}/materials`,{method:"PUT",body:JSON.stringify(t)});if(e&&e.success){const t=Array.isArray(e.data)?e.data:[];currentWorkMaterials=t.map(t=>({material_id:t.material_id,material_name:t.material_name||`ID ${t.material_id}`,unit:t.unit,category:t.category,quantity_per_unit:parseFloat(t.quantity_per_unit)||0,available_quantity:void 0!==t.available_quantity?Number(t.available_quantity):0})),e.pricing&&"object"==typeof e.pricing&&(currentWorkPricing={unitCost:normalizeCostValue(e.pricing.unit_cost_without_vat),totalCost:normalizeCostValue(e.pricing.total_cost_without_vat)}),displayWorkMaterialsList(),populateWorkMaterialSelect(),updateWorkPricingInputs(),showNotification("–ú–∞—Ç–µ—Ä–∏–∞–ª—ã —Ä–∞–±–æ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã","success")}else{showNotification(e?.error||e?.message||"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã","error")}}catch(t){showNotification("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: "+t.message,"error")}}function closeWorkMaterialsModal(){const t=document.getElementById("workMaterialsModal");t&&(t.style.display="none"),currentWorkIdForMaterials=null,currentWorkMaterials=[],resetWorkPricing(),populateWorkMaterialSelect(),displayWorkMaterialsList()}function initializeWorkCheckboxes(){const t=document.getElementById("selectAllWorks"),e=document.querySelectorAll(".work-checkbox"),o=document.getElementById("deleteSelectedWorks"),r=document.getElementById("massActions"),n=document.getElementById("selectedCount");function a(){const a=document.querySelectorAll(".work-checkbox:checked").length;if(a>0){o.style.display="inline-block",r.style.display="flex",n.textContent=a;const i=a===e.length;t.checked=i,t.indeterminate=!i,t.dataset.allSelected=i?"true":"false"}else o.style.display="none",r.style.display="none",n.textContent="0",t.checked=!1,t.indeterminate=!1,t.dataset.allSelected="false"}t.checked=!1,t.addEventListener("click",function(o){const r="true"!==t.dataset.allSelected;e.forEach(t=>{t.checked=r}),t.checked=r,t.indeterminate=!1,t.dataset.allSelected=r?"true":"false",a()}),e.forEach(t=>{t.addEventListener("change",a)}),o.onclick=deleteSelectedWorks,a()}async function deleteSelectedWorks(){const t=document.querySelectorAll(".work-checkbox:checked");if(0===t.length)return void showNotification("–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π —Ä–∞–±–æ—Ç—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è","error");const e=Array.from(t).map(t=>parseInt(t.value));if(confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${e.length} –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç?`))try{t.forEach(t=>{t.closest("tr").classList.add("fade-out")}),await new Promise(t=>setTimeout(t,300));const o=e.map(t=>makeApiRequest(`${API_CONFIG.ENDPOINTS.WORKS}/${t}`,{method:"DELETE"}));await Promise.all(o),await loadWorks(),showNotification(`–£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ ${e.length} —Ä–∞–±–æ—Ç`,"success")}catch(e){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç: "+e.message,"error"),t.forEach(t=>{t.closest("tr").classList.remove("fade-out")})}}function addNewWork(){const t=document.getElementById("addWorkModal");t&&t.remove();const e=document.createElement("div");e.className="modal",e.id="addWorkModal",e.style.display="flex";const o=document.createElement("div");o.className="modal-content";const r=document.createElement("h3");r.className="modal-title",r.textContent="–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç";const n=document.createElement("p");n.className="modal-subtitle",n.textContent="–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –¥–æ–±–∞–≤—å—Ç–µ –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–±–æ—Ç.";const a=document.createElement("form");a.id="addWorkForm";const i=document.createElement("div");i.id="addWorkItemsContainer",i.style.display="flex",i.style.flexDirection="column",i.style.gap="12px";const c=document.createElement("button");c.type="button",c.className="secondary",c.textContent="‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ —Ä–∞–±–æ—Ç—É";const s=document.createElement("div");s.className="modal-actions";const l=document.createElement("button");l.type="button",l.className="secondary",l.textContent="–û—Ç–º–µ–Ω–∞";const u=document.createElement("button");u.type="submit",u.className="success",u.textContent="üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å",s.appendChild(l),s.appendChild(u),a.appendChild(i),a.appendChild(c),a.appendChild(s),o.appendChild(r),o.appendChild(n),o.appendChild(a),e.appendChild(o),document.body.appendChild(e);const d=Array.isArray(categories)&&categories.length>0?categories.map(t=>t.name):[""],m=Array.isArray(UNITS)&&UNITS.length>0?UNITS.slice():["—à—Ç"];function p(t,e=""){return t.map(t=>{const o=t??"";return`<option value="${o}"${o===e?" selected":""}>${o}</option>`}).join("")}function f(t={}){const e=function(t={}){const e=document.createElement("div");return e.className="report-work-item add-work-item",e.innerHTML=`\n                <div class="modal-form-group">\n                    <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</label>\n                    <input type="text" class="editable" data-field="name" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã" value="${t.name||""}" required>\n                </div>\n                <div class="modal-form-group">\n                    <label>–†–∞–∑–¥–µ–ª</label>\n                    <select class="editable" data-field="category"></select>\n                </div>\n                <div class="modal-form-group">\n                    <label>–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</label>\n                    <select class="editable" data-field="unit"></select>\n                </div>\n                <div class="modal-form-group">\n                    <label>–ù–∞ –±–∞–ª–∞–Ω—Å–µ</label>\n                    <input type="number" class="editable" data-field="balance" step="1" value="${t.balance??0}">\n                </div>\n                <div class="modal-form-group">\n                    <label>–ü—Ä–æ–µ–∫—Ç</label>\n                    <input type="number" class="editable" data-field="project_total" step="1" value="${t.project_total??0}">\n                </div>\n                <div class="modal-form-group">\n                    <label>–ê–∫—Ç–∏–≤–Ω–æ</label>\n                    <select class="editable" data-field="is_active">\n                        <option value="1"${0===t.is_active?"":" selected"}>–î–∞</option>\n                        <option value="0"${0===t.is_active?" selected":""}>–ù–µ—Ç</option>\n                    </select>\n                </div>\n                <button type="button" class="secondary remove-add-work-button">–£–¥–∞–ª–∏—Ç—å</button>\n            `,e.querySelector('select[data-field="category"]').innerHTML=p(d,t.category||d[0]||""),e.querySelector('select[data-field="unit"]').innerHTML=p(m,t.unit||m[0]),e.querySelector(".remove-add-work-button").addEventListener("click",()=>{e.remove(),i.querySelector(".add-work-item")||f()}),e}(t);i.appendChild(e)}c.addEventListener("click",()=>f()),l.addEventListener("click",()=>{e.remove()}),e.addEventListener("click",t=>{t.target===e&&e.remove()}),o.addEventListener("click",t=>t.stopPropagation()),f(),a.addEventListener("submit",async t=>{t.preventDefault();const o=Array.from(i.querySelectorAll(".add-work-item"));if(0===o.length)return void showNotification("–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ä–∞–±–æ—Ç—É","error");const r=[];for(const t of o){const e=e=>t.querySelector(e),o=e('input[data-field="name"]'),n=e('select[data-field="category"]'),a=e('select[data-field="unit"]'),i=e('input[data-field="balance"]'),c=e('input[data-field="project_total"]'),s=e('select[data-field="is_active"]'),l=(o.value||"").trim();if(!l)return showNotification("–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º","error"),void o.focus();r.push({name:l,category:(n?.value||"").trim(),unit:a?.value||"",balance:parseFloat(i?.value||"0")||0,project_total:parseFloat(c?.value||"0")||0,is_active:parseInt(s?.value||"1",10)||0})}u.disabled=!0,l.disabled=!0,c.disabled=!0;let n=0,a=[];for(const t of r)try{showNotification("–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...","success");const e=await fetch(buildApiUrl(API_CONFIG.ENDPOINTS.WORKS),{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({name:t.name,category:t.category,unit:t.unit,balance:t.balance,project_total:t.project_total,is_active:t.is_active})});if(await checkIfWorkExists(t.name,t.category))n++,showNotification(`–†–∞–±–æ—Ç–∞ "${t.name}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞`,"success");else{let t="–†–∞–±–æ—Ç–∞ –Ω–µ –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö";try{const o=await e.text();if(o){const e=JSON.parse(o);t=e.detail||e.error||t}}catch(t){}a.push(t)}}catch(t){a.push("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã: "+t.message)}n>0?e.remove():(u.disabled=!1,l.disabled=!1,c.disabled=!1),a.length>0&&showNotification(a.join(" "),"error")})}function removeNewWork(t){t.closest("tr").remove();const e=document.getElementById("worksTableBody");0===e.children.length&&(e.innerHTML='<tr><td colspan="8" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞–±–æ—Ç–∞—Ö</td></tr>')}async function saveNewWork(t){const e=t.closest("tr").querySelectorAll(".editable"),o={};e.forEach(t=>{const e=t.getAttribute("data-field");let r=t.value;"balance"!==e&&"project_total"!==e||(r=parseFloat(r)),"is_active"===e&&(r=parseInt(r)),o[e]=r});const r=o.name,n=o.category,a={name:o.name,category:o.category,unit:o.unit,balance:o.balance,project_total:o.project_total,is_active:o.is_active};try{showNotification("–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...","success");const t=await fetch(buildApiUrl(API_CONFIG.ENDPOINTS.WORKS),{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(a)});if(await checkIfWorkExists(r,n))showNotification("–†–∞–±–æ—Ç–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞","success");else{let e="–†–∞–±–æ—Ç–∞ –Ω–µ –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö";try{const o=await t.text();if(o){const t=JSON.parse(o);e=t.detail||t.error||e}}catch(t){}showNotification(`–û—à–∏–±–∫–∞: ${e}`,"error")}}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã: "+t.message,"error")}}async function checkIfWorkExists(t,e,o=5){for(let r=0;r<o;r++){await loadWorks();if(works.some(o=>{const r=o.–†–∞–∑–¥–µ–ª||o["–ö–∞—Ç–µ–≥–æ—Ä–∏—è"]||"";return o["–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã"]===t&&r===e}))return!0;await new Promise(t=>setTimeout(t,500))}return!1}async function saveWork(t){const e=document.querySelector(`tr:has(input[value="${t}"])`).querySelectorAll(".editable"),o={id:t};e.forEach(t=>{const e=t.getAttribute("data-field");let r=t.value;"balance"!==e&&"project_total"!==e||(r=parseFloat(r)),"is_active"===e&&(r=parseInt(r)),o[e]=r});const r={name:o.name,category:o.category,unit:o.unit,balance:o.balance,project_total:o.project_total,is_active:o.is_active};try{if(!works.find(e=>e.id===t))return void showNotification("–†–∞–±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞","error");showNotification("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...","success");const e=await fetch(buildApiUrl(`${API_CONFIG.ENDPOINTS.WORKS}/${t}`),{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(r)});await new Promise(t=>setTimeout(t,1e3)),await loadWorks();const n=works.find(e=>e.id===t);if(n){const t=n.–†–∞–∑–¥–µ–ª||n["–ö–∞—Ç–µ–≥–æ—Ä–∏—è"]||"";n["–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã"]===o.name&&t===o.category&&n["–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è"]===o.unit&&parseFloat(n["–ù–∞ –±–∞–ª–∞–Ω—Å–µ"])===o.balance&&parseFloat(n["–ü—Ä–æ–µ–∫—Ç"]||0)===o.project_total&&Boolean(n.is_active)===Boolean(o.is_active)?showNotification("–†–∞–±–æ—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞","success"):showNotification("–†–∞–±–æ—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞, –Ω–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ –±—ã–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã","warning")}else{let t="–†–∞–±–æ—Ç–∞ –Ω–µ –±—ã–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö";try{const o=await e.text();if(o){const e=JSON.parse(o);t=e.detail||e.error||t}}catch(t){}showNotification(`–û—à–∏–±–∫–∞: ${t}`,"error")}}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã: "+t.message,"error")}}async function saveAllWorks(){const t=document.querySelectorAll("#worksTableBody tr");let e=!1,o=0,r=0;showNotification("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π...","success");for(const n of t){const a=n.querySelector("td:nth-child(2) input");if(!a||"–Ω–æ–≤—ã–π"===a.value)continue;const i=parseInt(a.value),c=n.querySelectorAll(".editable"),s={id:i};c.forEach(t=>{const e=t.getAttribute("data-field");let o=t.value;"balance"!==e&&"project_total"!==e||(o=parseFloat(o)),"is_active"===e&&(o=parseInt(o)),s[e]=o});const l={name:s.name,category:s.category,unit:s.unit,balance:s.balance,project_total:s.project_total,is_active:s.is_active};try{await fetch(buildApiUrl(`${API_CONFIG.ENDPOINTS.WORKS}/${i}`),{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(l)});await new Promise(t=>setTimeout(t,500)),o+r===t.length-1&&await loadWorks(),o++,e=!0}catch(t){r++}}if(await loadWorks(),e){let t=`–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –û–±–Ω–æ–≤–ª–µ–Ω–æ —Ä–∞–±–æ—Ç: ${o}`;r>0&&(t+=`, –æ—à–∏–±–æ–∫: ${r}`),showNotification(t,"success")}else showNotification("–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è","success")}async function deleteWork(t){if(confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ä–∞–±–æ—Ç—É?"))try{document.querySelector(`tr:has(input[value="${t}"])`).classList.add("fade-out"),await new Promise(t=>setTimeout(t,300));const e=await makeApiRequest(`${API_CONFIG.ENDPOINTS.WORKS}/${t}`,{method:"DELETE"});e.success?(await loadWorks(),showNotification("–†–∞–±–æ—Ç–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞","success")):showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã: "+(e.error||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"),"error")}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã: "+t.message,"error")}}function filterWorks(){const t=document.getElementById("searchWorks").value.toLowerCase();displayWorks(works.filter(e=>{const o=(e.–†–∞–∑–¥–µ–ª||e["–ö–∞—Ç–µ–≥–æ—Ä–∏—è"]||"").toLowerCase();return e["–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã"].toLowerCase().includes(t)||o.includes(t)||e["–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è"].toLowerCase().includes(t)}))}async function exportWorksToExcel(){try{showNotification("–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è...","success");const t=XLSX.utils.book_new();t.Props={Title:"–°–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç",Subject:"–†–∞–±–æ—Ç—ã —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–π –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏",Author:"WiTech System",CreatedDate:new Date};const e=works.map(t=>({ID:t.id,"–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã":t["–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã"],"–†–∞–∑–¥–µ–ª":t.–†–∞–∑–¥–µ–ª||t["–ö–∞—Ç–µ–≥–æ—Ä–∏—è"]||"","–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è":t["–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è"],"–ù–∞ –±–∞–ª–∞–Ω—Å–µ":t["–ù–∞ –±–∞–ª–∞–Ω—Å–µ"],"–ü—Ä–æ–µ–∫—Ç":t["–ü—Ä–æ–µ–∫—Ç"]||0,"–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É":t["–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É"]??t.unit_cost_without_vat??0,"–ê–∫—Ç–∏–≤–Ω–∞":t.is_active?"–î–∞":"–ù–µ—Ç"})),o=XLSX.utils.json_to_sheet(e),r=[{wch:8},{wch:40},{wch:20},{wch:15},{wch:12},{wch:12},{wch:18},{wch:10}];o["!cols"]=r,XLSX.utils.book_append_sheet(t,o,"–†–∞–±–æ—Ç—ã");const n=`works_export_${(new Date).toISOString().split("T")[0]}.xlsx`;XLSX.writeFile(t,n),showNotification("–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω","success")}catch(t){console.error("Export error:",t),showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ —Ñ–∞–π–ª–∞: "+t.message,"error")}}function triggerImportWorks(){document.getElementById("importFileInput").click()}async function handleWorksImport(t){const e=t.target.files[0];if(e){t.target.value="";try{showNotification("–ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞...","success");const t=await readExcelFile(e);await importWorksFromExcel(t)}catch(t){console.error("Import error:",t),showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Ñ–∞–π–ª–∞: "+t.message,"error")}}}function readExcelFile(t){return new Promise((e,o)=>{const r=new FileReader;r.onload=function(t){try{const o=new Uint8Array(t.target.result),r=XLSX.read(o,{type:"array"}),n=r.SheetNames[0],a=r.Sheets[n],i=XLSX.utils.sheet_to_json(a);e(i)}catch(t){o(t)}},r.onerror=function(){o(new Error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞"))},r.readAsArrayBuffer(t)})}async function importWorksFromExcel(t){if(!t||0===t.length)throw new Error("–§–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö");let e=0,o=0,r=[];showNotification(`–ù–∞—á–∏–Ω–∞–µ–º –∏–º–ø–æ—Ä—Ç ${t.length} –∑–∞–ø–∏—Å–µ–π...`,"success");for(let n=0;n<t.length;n++){const a=t[n];try{const t=a["–†–∞–∑–¥–µ–ª"]??a["–ö–∞—Ç–µ–≥–æ—Ä–∏—è"];if(!a["–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã"]||!t||!a["–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è"]){r.push(`–°—Ç—Ä–æ–∫–∞ ${n+2}: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è`);continue}const i=String(t).trim(),c=parseFloat(a["–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É"])||0,s={name:String(a["–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã"]).trim(),category:i,unit:String(a["–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è"]).trim(),balance:parseFloat(a["–ù–∞ –±–∞–ª–∞–Ω—Å–µ"])||0,project_total:parseFloat(a["–ü—Ä–æ–µ–∫—Ç"])||0,unit_cost_without_vat:c,total_cost_without_vat:c*(parseFloat(a["–ü—Ä–æ–µ–∫—Ç"])||0),is_active:"–¥–∞"===String(a["–ê–∫—Ç–∏–≤–Ω–∞"]).toLowerCase()?1:0},l=a.ID?parseInt(a.ID):null;if(l&&works.find(t=>t.id===l)){const t=await makeApiRequest(`${API_CONFIG.ENDPOINTS.WORKS}/${l}`,{method:"PUT",body:JSON.stringify(s)});t&&t.success?o++:r.push(`–°—Ç—Ä–æ–∫–∞ ${n+2}: –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã ID ${l}`)}else{const t=await makeApiRequest(API_CONFIG.ENDPOINTS.WORKS,{method:"POST",body:JSON.stringify(s)});t&&t.success?e++:r.push(`–°—Ç—Ä–æ–∫–∞ ${n+2}: –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã "${s.name}"`)}}catch(t){r.push(`–°—Ç—Ä–æ–∫–∞ ${n+2}: ${t.message}`)}}await loadWorks();let n=`–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –î–æ–±–∞–≤–ª–µ–Ω–æ: ${e}, –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${o}`;r.length>0&&(n+=`. –û—à–∏–±–æ–∫: ${r.length}`,console.error("Import errors:",r)),showNotification(n,r.length>0?"error":"success")}async function loadMaterials(){const t=document.getElementById("materialsLoading"),e=document.getElementById("materialsTableBody");if(t&&e){t.style.display="block",e.innerHTML="";try{const t=await makeApiRequest(API_CONFIG.ENDPOINTS.MATERIALS);t.success?(materials=t.data||[],displayMaterials(materials),currentWorkMaterials&&currentWorkMaterials.length>0&&(currentWorkMaterials=currentWorkMaterials.map(t=>{const e=materials.find(e=>e.id===t.material_id);return e?{...t,material_name:e.name||t.material_name,unit:e.unit,category:e.category,available_quantity:void 0!==e.quantity?Number(e.quantity):t.available_quantity}:t}),displayWorkMaterialsList()),populateWorkMaterialSelect()):showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: "+(t.error||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"),"error")}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: "+t.message,"error")}finally{t.style.display="none"}}}function displayMaterials(t=materials){const e=document.getElementById("materialsTableBody");if(e){if(e.innerHTML="",!t||0===t.length)return e.innerHTML='<tr><td colspan="6" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö</td></tr>',void refreshTableSorting("materialsTable");t.forEach(t=>{const o=document.createElement("tr");o.setAttribute("data-material-id",t.id);const r=void 0!==t.quantity&&null!==t.quantity?Number(t.quantity):0,n=[...categories.map(e=>`<option value="${e.name}" ${e.name===t.category?"selected":""}>${e.name}</option>`)];!categories.find(e=>e.name===t.category)&&t.category&&n.push(`<option value="${t.category}" selected>${t.category}</option>`),t.category||n.unshift('<option value="" selected>–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>');const a=[...UNITS.map(e=>`<option value="${e}" ${e===t.unit?"selected":""}>${e}</option>`)];t.unit&&!UNITS.includes(t.unit)&&a.push(`<option value="${t.unit}" selected>${t.unit}</option>`),t.unit||a.unshift('<option value="" selected>–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>'),o.innerHTML=`\n                <td><input type="text" value="${t.id}" readonly></td>\n                <td>\n                    <select class="editable" data-field="category">\n                        ${n.join("")}\n                    </select>\n                </td>\n                <td><input type="text" value="${t.name||""}" class="editable" data-field="name"></td>\n                <td>\n                    <select class="editable" data-field="unit">\n                        ${a.join("")}\n                    </select>\n                </td>\n                <td><input type="number" value="${r}" class="editable" data-field="quantity" step="1" min="0"></td>\n                <td class="action-buttons">\n                    <button onclick="saveMaterial(${t.id})" class="secondary">üíæ</button>\n                    <button onclick="openMaterialPricing(${t.id})" class="secondary" title="–°—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∞">üßæ</button>\n                    <button onclick="addMaterialQuantity(${t.id})" class="success" title="–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ —Å–∫–ª–∞–¥">‚ûï</button>\n                    <button onclick="deleteMaterial(${t.id})" class="danger">üóëÔ∏è</button>\n                </td>\n            `,e.appendChild(o)}),refreshTableSorting("materialsTable")}}async function loadMaterialHistory(t=!1){const e=document.getElementById("materialsHistoryLoading"),o=document.getElementById("materialHistoryTableBody");if(e&&o)if(t&&(materialHistoryLoaded=!1),!materialHistoryLoaded||t){e.style.display="block",o.innerHTML="";try{const t=await makeApiRequest(API_CONFIG.ENDPOINTS.MATERIALS_HISTORY);t.success?(materialHistory=t.data||[],materialHistoryLoaded=!0,displayMaterialHistory(materialHistory)):showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: "+(t.error||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"),"error")}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: "+t.message,"error")}finally{e.style.display="none"}}else displayMaterialHistory(materialHistory)}function formatHistoryNumber(t,e){if(null==t||""===t)return"";const o=Number(t);if(!Number.isFinite(o))return t;const r=o.toLocaleString("ru-RU",{maximumFractionDigits:2});return e?`${r} ${e}`:r}function formatHistoryChange(t,e){if(null==t||""===t)return"";const o=Number(t);if(!Number.isFinite(o))return t;const r=o>0?"+":o<0?"-":"",n=Math.abs(o).toLocaleString("ru-RU",{maximumFractionDigits:2});return e?`${r}${n} ${e}`:`${r}${n}`}function formatHistoryDate(t){if(!t)return"";const e="string"==typeof t?t.replace(" ","T"):t,o=new Date(e);return Number.isNaN(o.getTime())?t:o.toLocaleString("ru-RU")}function displayMaterialHistory(t=materialHistory){const e=document.getElementById("materialHistoryTableBody");if(e){if(e.innerHTML="",!t||0===t.length)return e.innerHTML='<tr><td colspan="8" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∏—Å—Ç–æ—Ä–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</td></tr>',void refreshTableSorting("materialHistoryTable");t.forEach(t=>{const o=document.createElement("tr"),r=t.unit||"",n=Number(t.change_amount),a=Number(t.resulting_quantity),i=Number.isFinite(n)?n:"",c=Number.isFinite(a)?a:"",s=t.created_at?String(t.created_at).replace(" ","T"):"";o.innerHTML=`\n                <td>${t.id??""}</td>\n                <td>${t.material_name||"-"}</td>\n                <td>${t.change_type||"-"}</td>\n                <td data-sort-value="${i}">${formatHistoryChange(t.change_amount,r)}</td>\n                <td data-sort-value="${c}">${formatHistoryNumber(t.resulting_quantity,r)}</td>\n                <td>${t.description||""}</td>\n                <td>${t.performed_by||""}</td>\n                <td data-sort-value="${s}">${formatHistoryDate(t.created_at)}</td>\n            `,e.appendChild(o)}),refreshTableSorting("materialHistoryTable")}}function filterMaterialHistory(t){if(!t)return void displayMaterialHistory(materialHistory);const e=t.toLowerCase();displayMaterialHistory(materialHistory.filter(t=>[t.id,t.material_id,t.material_name,t.change_type,t.change_amount,t.resulting_quantity,t.performed_by,t.description,t.created_at].some(t=>null!=t&&String(t).toLowerCase().includes(e))))}async function toggleMaterialHistoryView(){const t=document.getElementById("toggleMaterialsHistory"),e=document.getElementById("materialsTableContainer"),o=document.getElementById("materialHistoryContainer"),r=document.getElementById("materialsLoading"),n=document.getElementById("materialsHistoryLoading"),a=document.getElementById("searchMaterials"),i=document.getElementById("addMaterial"),c=document.getElementById("exportMaterials"),s=document.getElementById("importMaterials");t&&e&&o&&(isMaterialHistoryView?(isMaterialHistoryView=!1,t.textContent="üìú –ò—Å—Ç–æ—Ä–∏—è",o.style.display="none",n&&(n.style.display="none"),e.style.display="block",i&&(i.style.display=""),c&&(c.style.display=""),s&&(s.style.display=""),a?filterMaterials({target:a}):displayMaterials(materials)):(isMaterialHistoryView=!0,t.textContent="üì¶ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã",e.style.display="none",r&&(r.style.display="none"),o.style.display="block",n&&(n.style.display="block"),i&&(i.style.display="none"),c&&(c.style.display="none"),s&&(s.style.display="none"),await loadMaterialHistory(!0),a&&a.value&&filterMaterialHistory(a.value.toLowerCase())))}function filterMaterials(t){const e=(t.target.value||"").toLowerCase();if(isMaterialHistoryView)return void filterMaterialHistory(e);if(!e)return void displayMaterials(materials);displayMaterials(materials.filter(t=>[t.id,t.name,t.category,t.unit,t.quantity].some(t=>null!=t&&String(t).toLowerCase().includes(e))))}function addNewMaterial(){const t=document.getElementById("addMaterialModal");t&&t.remove();const e=document.createElement("div");e.className="modal",e.id="addMaterialModal",e.style.display="flex";const o=document.createElement("div");o.className="modal-content";const r=document.createElement("h3");r.className="modal-title",r.textContent="–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤";const n=document.createElement("p");n.className="modal-subtitle",n.textContent="–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –¥–æ–±–∞–≤—å—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.";const a=document.createElement("form");a.id="addMaterialForm";const i=document.createElement("div");i.id="addMaterialItemsContainer",i.style.display="flex",i.style.flexDirection="column",i.style.gap="12px";const c=document.createElement("button");c.type="button",c.className="secondary",c.textContent="‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ –º–∞—Ç–µ—Ä–∏–∞–ª";const s=document.createElement("div");s.className="modal-actions";const l=document.createElement("button");l.type="button",l.className="secondary",l.textContent="–û—Ç–º–µ–Ω–∞";const u=document.createElement("button");u.type="submit",u.className="success",u.textContent="üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å",s.appendChild(l),s.appendChild(u),a.appendChild(i),a.appendChild(c),a.appendChild(s),o.appendChild(r),o.appendChild(n),o.appendChild(a),e.appendChild(o),document.body.appendChild(e);const d=Array.isArray(categories)&&categories.length>0?categories.map(t=>t.name).filter(Boolean):[],m=Array.isArray(UNITS)&&UNITS.length>0?UNITS.slice():["—à—Ç"];function p(t,e,o="",r="–ù–µ –≤—ã–±—Ä–∞–Ω–æ"){const n=Array.from(new Set((e||[]).map(t=>(t??"").trim()).filter(t=>t))),a=[];r&&a.push(`<option value=""${o?"":" selected"}>${r}</option>`),n.forEach(t=>{const e=t===o;a.push(`<option value="${t}"${e?" selected":""}>${t}</option>`)}),o&&!n.includes(o)&&a.push(`<option value="${o}" selected>${o}</option>`),t.innerHTML=a.join("")}function f(t={}){const e=function(t={}){const e=document.createElement("div");return e.className="report-work-item add-material-item",e.innerHTML=`\n                <div class="modal-form-group">\n                    <label>–†–∞–∑–¥–µ–ª</label>\n                    <select class="editable" data-field="category"></select>\n                </div>\n                <div class="modal-form-group">\n                    <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</label>\n                    <input type="text" class="editable" data-field="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞" value="${t.name||""}" required>\n                </div>\n                <div class="modal-form-group">\n                    <label>–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</label>\n                    <select class="editable" data-field="unit"></select>\n                </div>\n                <div class="modal-form-group">\n                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>\n                    <input type="number" class="editable" data-field="quantity" step="1" min="0" value="${t.quantity??0}">\n                </div>\n                <button type="button" class="secondary remove-add-material-button">–£–¥–∞–ª–∏—Ç—å</button>\n            `,p(e.querySelector('select[data-field="category"]'),d,t.category||"","–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª"),p(e.querySelector('select[data-field="unit"]'),m,t.unit||"","–í—ã–±–µ—Ä–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è"),e.querySelector(".remove-add-material-button").addEventListener("click",()=>{e.remove(),i.querySelector(".add-material-item")||f()}),e}(t);i.appendChild(e)}c.addEventListener("click",()=>f()),l.addEventListener("click",()=>{e.remove()}),e.addEventListener("click",t=>{t.target===e&&e.remove()}),o.addEventListener("click",t=>t.stopPropagation()),f(),a.addEventListener("submit",async t=>{t.preventDefault();const o=Array.from(i.querySelectorAll(".add-material-item"));if(0===o.length)return void showNotification("–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –º–∞—Ç–µ—Ä–∏–∞–ª","error");const r=[];for(const t of o){const e=e=>t.querySelector(e),o=e('select[data-field="category"]'),n=e('input[data-field="name"]'),a=e('select[data-field="unit"]'),i=e('input[data-field="quantity"]'),c=(n?.value||"").trim(),s=(o?.value||"").trim(),l=(a?.value||"").trim(),u=parseFloat(i?.value||"0")||0;if(!s)return showNotification("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –¥–ª—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞","error"),void o.focus();if(!c)return showNotification("–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º","error"),void n.focus();if(!l)return showNotification("–í—ã–±–µ—Ä–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è","error"),void a.focus();if(u<0)return showNotification("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º","error"),void i.focus();r.push({name:c,category:s,unit:l,quantity:u,performed_by:getCurrentUsername()})}u.disabled=!0,l.disabled=!0,c.disabled=!0;let n=0;const a=[];for(const t of r)try{showNotification(`–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ "${t.name}"...`,"success");const e=await makeApiRequest(API_CONFIG.ENDPOINTS.MATERIALS,{method:"POST",body:JSON.stringify(t)});if(e&&e.success)n++;else{const t=e?.detail||e?.error||"–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª";a.push(t)}}catch(t){a.push("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞: "+t.message)}n>0?(materialHistoryLoaded=!1,await loadMaterials(),e.remove(),showNotification(`–ú–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ: ${n}`,"success")):(u.disabled=!1,l.disabled=!1,c.disabled=!1),a.length>0&&showNotification(a.join("\n"),"error")})}async function saveMaterial(t){const e=document.querySelector(`#materialsTableBody tr[data-material-id="${t}"]`);if(!e)return void showNotification("–°—Ç—Ä–æ–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞","error");const o=e.querySelectorAll(".editable"),r={};if(o.forEach(t=>{const e=t.getAttribute("data-field");r[e]=t.value}),r.performed_by=getCurrentUsername(),r.name&&r.category&&r.unit)if(r.quantity=parseFloat(r.quantity),isNaN(r.quantity)||r.quantity<0)showNotification("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º –±–æ–ª—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω—ã–º –Ω—É–ª—é","error");else try{const e=await makeApiRequest(`${API_CONFIG.ENDPOINTS.MATERIALS}/${t}`,{method:"PUT",body:JSON.stringify(r)});if(e&&e.success)showNotification("–ú–∞—Ç–µ—Ä–∏–∞–ª —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω","success"),materialHistoryLoaded=!1,await loadMaterials();else{showNotification(e?.detail||e?.error||"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª","error")}}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞: "+t.message,"error")}else showNotification("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞","error")}async function deleteMaterial(t){if(confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª?"))try{const e=await makeApiRequest(`${API_CONFIG.ENDPOINTS.MATERIALS}/${t}`,{method:"DELETE"});if(e&&e.success)showNotification("–ú–∞—Ç–µ—Ä–∏–∞–ª —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω","success"),materialHistoryLoaded=!1,await loadMaterials();else{showNotification(e?.detail||e?.error||"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª","error")}}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞: "+t.message,"error")}}async function exportMaterialsToExcel(){try{const t=localStorage.getItem("token"),e=await fetch(buildApiUrl(API_CONFIG.ENDPOINTS.MATERIALS_EXPORT),{headers:t?{Authorization:`Bearer ${t}`}:{}});if(!e.ok){const t=await e.text();throw new Error(t||"–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞")}const o=await e.blob(),r=window.URL.createObjectURL(o),n=document.createElement("a");n.href=r,n.download=`materials_export_${(new Date).toISOString().split("T")[0]}.xlsx`,document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(r),showNotification("–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω","success")}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: "+t.message,"error")}}function triggerImportMaterials(){const t=document.getElementById("materialsImportInput");t&&t.click()}async function handleMaterialsImport(t){const e=t.target.files[0];if(e){t.target.value="";try{const t=new FormData;t.append("file",e);const o=localStorage.getItem("token"),r=await fetch(buildApiUrl(API_CONFIG.ENDPOINTS.MATERIALS_IMPORT),{method:"POST",headers:o?{Authorization:`Bearer ${o}`}:{},body:t}),n=await r.text();let a={};try{a=n?JSON.parse(n):{}}catch(t){throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞")}if(!r.ok||!a.success){const t=a.detail||a.error||"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤";throw new Error(t)}await loadMaterials(),materialHistoryLoaded=!1;let i=a.message||"–ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω";a.errors&&a.errors.length>0?(i+=`. –û—à–∏–±–æ–∫: ${a.errors.length}`,console.warn("–û—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤:",a.errors),showNotification(i,"warning")):showNotification(i,"success")}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: "+t.message,"error")}}}async function downloadMaterialsTemplate(){try{const t=localStorage.getItem("token"),e=await fetch(buildApiUrl(API_CONFIG.ENDPOINTS.MATERIALS_TEMPLATE),{headers:t?{Authorization:`Bearer ${t}`}:{}});if(!e.ok){const t=await e.text();throw new Error(t||"–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —à–∞–±–ª–æ–Ω–∞")}const o=await e.blob(),r=window.URL.createObjectURL(o),n=document.createElement("a");n.href=r,n.download="materials_template.xlsx",document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(r),showNotification("–®–∞–±–ª–æ–Ω —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω","success")}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —à–∞–±–ª–æ–Ω–∞: "+t.message,"error")}}async function loadCategories(){try{const t=await makeApiRequest(API_CONFIG.ENDPOINTS.CATEGORIES);if(t.success){categories=t.data||[],document.getElementById("works").classList.contains("active")&&await loadWorks(),displayMaterials(materials);const e=document.getElementById("foremanSectionsModal");e&&"flex"===e.style.display&&(populateForemanSectionsSelect(),displayForemanSectionsList())}else showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞–∑–¥–µ–ª–æ–≤: "+t.error,"error")}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞–∑–¥–µ–ª–æ–≤: "+t.message,"error")}}function displayCategoriesInModal(){const t=document.getElementById("categoriesList");t.innerHTML="",0!==categories.length?categories.forEach(e=>{const o=document.createElement("div");o.className="category-item",o.dataset.categoryId=e.id;const r=document.createElement("span");r.className="category-name",r.textContent=e.name;const n=document.createElement("div");n.className="category-actions";const a=document.createElement("button");a.className="secondary",a.textContent="‚úèÔ∏è",a.addEventListener("click",()=>startEditCategory(e.id));const i=document.createElement("button");i.className="danger",i.textContent="üóëÔ∏è",i.addEventListener("click",()=>deleteCategory(e.id)),n.appendChild(a),n.appendChild(i),o.appendChild(r),o.appendChild(n),t.appendChild(o)}):t.innerHTML='<div style="text-align: center; color: var(--accent); opacity: 0.7;">–ù–µ—Ç —Ä–∞–∑–¥–µ–ª–æ–≤</div>'}function openCategoryModal(){displayCategoriesInModal(),document.getElementById("categoryModal").style.display="flex",document.getElementById("newCategoryName").value="",document.getElementById("newCategoryName").focus()}function closeCategoryModal(){document.getElementById("categoryModal").style.display="none"}function startEditCategory(t){const e=document.querySelector(`.category-item[data-category-id="${t}"]`);if(!e)return;const o=categories.find(e=>e.id===t);if(!o)return;e.classList.add("editing"),e.innerHTML="";const r=document.createElement("input");r.type="text",r.value=o.name,r.className="login-input",r.setAttribute("data-category-edit","true");const n=document.createElement("div");n.className="category-actions";const a=document.createElement("button");a.className="success",a.textContent="üíæ",a.addEventListener("click",()=>confirmEditCategory(t));const i=document.createElement("button");i.className="secondary",i.textContent="‚Ü©Ô∏è",i.addEventListener("click",()=>cancelEditCategory(t)),n.appendChild(a),n.appendChild(i),e.appendChild(r),e.appendChild(n),r.focus(),r.select(),r.addEventListener("keydown",e=>{"Enter"===e.key?(e.preventDefault(),confirmEditCategory(t)):"Escape"===e.key&&(e.preventDefault(),cancelEditCategory(t))})}function cancelEditCategory(t){displayCategoriesInModal();const e=document.getElementById("categoriesList");if(e){const o=e.querySelector(`.category-item[data-category-id="${t}"] input[data-category-edit]`);o&&o.blur()}}async function confirmEditCategory(t){const e=categories.find(e=>e.id===t);if(!e)return;const o=document.querySelector(`.category-item[data-category-id="${t}"]`),r=o?o.querySelector("input[data-category-edit]"):null,n=r?r.value.trim():"";if(!n)return showNotification("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞","error"),void(r&&r.focus());if(e.name!==n)try{showNotification("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞...","success");const e=await makeApiRequest(`${API_CONFIG.ENDPOINTS.CATEGORIES}/${t}`,{method:"PUT",body:JSON.stringify({name:n})});if(e&&e.success)showNotification("–†–∞–∑–¥–µ–ª —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω","success"),await loadCategories(),displayCategoriesInModal();else{showNotification(`–û—à–∏–±–∫–∞: ${e?.error||e?.detail||"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª"}`,"error"),displayCategoriesInModal()}}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–∞–∑–¥–µ–ª–∞: "+t.message,"error"),displayCategoriesInModal()}else displayCategoriesInModal()}async function saveNewCategory(){const t=document.getElementById("newCategoryName").value.trim();if(t)try{showNotification("–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞...","success");const e=await fetch(buildApiUrl(API_CONFIG.ENDPOINTS.CATEGORIES),{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({name:t})});if(await checkIfCategoryExists(t))showNotification("–†–∞–∑–¥–µ–ª —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω","success"),document.getElementById("newCategoryName").value="",displayCategoriesInModal(),document.getElementById("works").classList.contains("active")&&await loadWorks();else{let t="–†–∞–∑–¥–µ–ª –Ω–µ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö";try{const o=await e.text();if(o){const e=JSON.parse(o);t=e.detail||e.error||t}}catch(t){}showNotification(`–û—à–∏–±–∫–∞: ${t}`,"error")}}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–∞–∑–¥–µ–ª–∞: "+t.message,"error")}else showNotification("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞","error")}async function checkIfCategoryExists(t,e=5){for(let o=0;o<e;o++){await loadCategories();if(categories.some(e=>e.name===t))return!0;await new Promise(t=>setTimeout(t,500))}return!1}async function deleteCategory(t){if(confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª?"))try{const e=categories.find(e=>e.id===t);if(!e)return;e.name;const o=await fetch(buildApiUrl(`${API_CONFIG.ENDPOINTS.CATEGORIES}/${t}`),{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});await new Promise(t=>setTimeout(t,1e3)),await loadCategories();if(categories.some(e=>e.id===t)){let t="–†–∞–∑–¥–µ–ª –Ω–µ –±—ã–ª —É–¥–∞–ª–µ–Ω –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö";try{const e=await o.text();if(e){const o=JSON.parse(e);t=o.detail||o.error||t}}catch(t){}showNotification(`–û—à–∏–±–∫–∞: ${t}`,"error")}else showNotification("–†–∞–∑–¥–µ–ª —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω","success"),displayCategoriesInModal(),document.getElementById("works").classList.contains("active")&&await loadWorks()}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–∞–∑–¥–µ–ª–∞: "+t.message,"error")}}function addBalance(t){const e=works.find(e=>e.id===t);e&&(currentWorkIdForBalance=t,currentWorkBalance=parseFloat(e["–ù–∞ –±–∞–ª–∞–Ω—Å–µ"])||0,document.getElementById("balanceWorkName").textContent=e["–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã"],document.getElementById("currentBalance").textContent=currentWorkBalance+" "+e["–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è"],document.getElementById("addBalanceAmount").value="",document.getElementById("addBalanceModal").style.display="flex",document.getElementById("addBalanceAmount").focus())}function closeAddBalanceModal(){document.getElementById("addBalanceModal").style.display="none",currentWorkIdForBalance=null,currentWorkBalance=0}async function confirmAddBalance(){const t=parseFloat(document.getElementById("addBalanceAmount").value);if(!t||t<=0)showNotification("–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ","error");else try{if(!works.find(t=>t.id===currentWorkIdForBalance))return void showNotification("–†–∞–±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞","error");showNotification("–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫ –±–∞–ª–∞–Ω—Å—É...","success");const e=await fetch(buildApiUrl(`${API_CONFIG.ENDPOINTS.WORKS}/${currentWorkIdForBalance}/add-balance`),{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({amount:t})});if(!e.ok){const t=await e.text();throw new Error(t||`HTTP error! status: ${e.status}`)}const o=await e.json();if(o.success){showNotification("–ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω","success"),closeAddBalanceModal();const e=document.querySelector(`tr:has(input[value="${currentWorkIdForBalance}"]) td:nth-child(6) input`);if(e){const o=currentWorkBalance+t;e.value=o}const o=works.findIndex(t=>t.id===currentWorkIdForBalance);-1!==o&&(works[o]["–ù–∞ –±–∞–ª–∞–Ω—Å–µ"]=currentWorkBalance+t)}else showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞: "+o.error,"error")}catch(t){console.error("Add balance error:",t),showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞: "+t.message,"error")}}function addMaterialQuantity(t){const e=materials.find(e=>e.id===t);if(!e)return void showNotification("–ú–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω","error");currentMaterialIdForQuantity=t,currentMaterialQuantity=void 0!==e.quantity&&null!==e.quantity?Number(e.quantity):0,currentMaterialUnit=e.unit||"";const o=document.getElementById("materialQuantityName");o&&(o.textContent=e.name||`ID ${t}`);const r=document.getElementById("materialCurrentQuantity");if(r){const t=Number.isFinite(currentMaterialQuantity)?currentMaterialQuantity.toLocaleString("ru-RU",{maximumFractionDigits:2}):"0";r.textContent=currentMaterialUnit?`${t} ${currentMaterialUnit}`:t}const n=document.getElementById("addMaterialQuantityAmount");n&&(n.value="",n.focus());const a=document.getElementById("addMaterialQuantityModal");a&&(a.style.display="flex")}function closeAddMaterialQuantityModal(){const t=document.getElementById("addMaterialQuantityModal");t&&(t.style.display="none"),currentMaterialIdForQuantity=null,currentMaterialQuantity=0,currentMaterialUnit=""}async function confirmAddMaterialQuantity(){const t=document.getElementById("addMaterialQuantityAmount");if(!t)return void showNotification("–ü–æ–ª–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ","error");const e=parseFloat(t.value);if(!e||e<=0)return void showNotification("–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ","error");if(!currentMaterialIdForQuantity)return void showNotification("–ú–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ –≤—ã–±—Ä–∞–Ω","error");const o=currentMaterialIdForQuantity,r=currentMaterialQuantity;try{showNotification("–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–∫–ª–∞–¥...","success");const t=await fetch(buildApiUrl(`${API_CONFIG.ENDPOINTS.MATERIALS}/${o}/add-quantity`),{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({amount:e,performed_by:getCurrentUsername(),description:"–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è"})});if(!t.ok){const e=await t.text();throw new Error(e||`HTTP error! status: ${t.status}`)}const n=await t.json();if(n.success){const t=r+e;showNotification("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ","success"),closeAddMaterialQuantityModal(),materialHistoryLoaded=!1;const n=document.querySelector(`#materialsTableBody tr[data-material-id="${o}"] input[data-field="quantity"]`);n&&(n.value=t);const a=materials.findIndex(t=>t.id===o);-1!==a&&(materials[a].quantity=t)}else{showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞: "+(n.error||n.detail||"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ"),"error")}}catch(t){console.error("Add material quantity error:",t),showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞: "+t.message,"error")}}async function loadForemen(){const t=document.getElementById("foremenLoading"),e=document.getElementById("foremenTableBody");t.style.display="block",e.innerHTML="";try{const t=await makeApiRequest(API_CONFIG.ENDPOINTS.FOREMEN);t.success?(foremen=t.data||[],displayForemen(foremen)):showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤: "+t.error,"error")}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤: "+t.message,"error")}finally{t.style.display="none"}}function displayForemen(t){const e=document.getElementById("foremenTableBody");if(e.innerHTML="",0===t.length)return e.innerHTML='<tr><td colspan="7" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –±—Ä–∏–≥–∞–¥–∏—Ä–∞—Ö</td></tr>',void refreshTableSorting("foremenTable");t.forEach(t=>{const o=document.createElement("tr");o.innerHTML=`\n                <td><input type="text" value="${t.id}" readonly></td>\n                <td><input type="text" value="${t.full_name||""}" class="editable" data-field="full_name"></td>\n                <td><input type="text" value="${t.position||""}" class="editable" data-field="position"></td>\n                <td><input type="text" value="${t.username||""}" readonly></td>\n                <td><input type="text" value="${t.registration_date||""}" readonly></td>\n                <td>\n                    <select class="editable" data-field="is_active">\n                        <option value="1" ${t.is_active?"selected":""}>‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω</option>\n                        <option value="0" ${t.is_active?"":"selected"}>‚ùå –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</option>\n                    </select>\n                </td>\n                <td class="action-buttons">\n                    <button onclick="saveForeman(${t.id})" class="secondary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>\n                    <button onclick="openForemanSections(${t.id})" class="secondary" title="–ü—Ä–∏–≤—è–∑–∞—Ç—å —Ä–∞–∑–¥–µ–ª—ã">üßæ</button>\n                    <button onclick="deleteForeman(${t.id})" class="danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>\n                </td>\n            `,e.appendChild(o)}),refreshTableSorting("foremenTable")}async function openForemanSections(t){const e=document.getElementById("foremanSectionsModal");if(!e)return;const o=foremen.find(e=>e.id===t);if(!o)return void showNotification("–ë—Ä–∏–≥–∞–¥–∏—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω","error");currentForemanIdForSections=t;const r=[];o.full_name&&r.push(o.full_name),o.position&&r.push(o.position),document.getElementById("foremanSectionsName").textContent=r.join(" ‚Ä¢ ")||`ID ${t}`,categories&&0!==categories.length||await loadCategories(),await loadForemanSections(t),populateForemanSectionsSelect(),displayForemanSectionsList();const n=document.getElementById("foremanSectionsSelect");n&&(n.value=""),e.style.display="flex"}async function loadForemanSections(t){try{const e=await makeApiRequest(`${API_CONFIG.ENDPOINTS.FOREMEN}/${t}/sections`);if(e&&e.success)currentForemanSections=(e.data||[]).map(t=>({id:t.id,name:t.name}));else{currentForemanSections=[];showNotification(e?.error||e?.detail||"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞–∑–¥–µ–ª—ã –±—Ä–∏–≥–∞–¥–∏—Ä–∞","error")}}catch(t){currentForemanSections=[],showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞–∑–¥–µ–ª–æ–≤ –±—Ä–∏–≥–∞–¥–∏—Ä–∞: "+t.message,"error")}}function populateForemanSectionsSelect(){const t=document.getElementById("foremanSectionsSelect");if(!t)return;const e=new Set((currentForemanSections||[]).map(t=>t.id));if(!categories||0===categories.length)return t.innerHTML='<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤</option>',void(t.disabled=!0);let o='<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª</option>';categories.forEach(t=>{const r=e.has(t.id)?"disabled":"";o+=`<option value="${t.id}" ${r}>${t.name}</option>`}),t.innerHTML=o,t.disabled=!1}function displayForemanSectionsList(){const t=document.getElementById("foremanSectionsList");if(!t)return;if(!currentForemanSections||0===currentForemanSections.length)return void(t.innerHTML='<div class="foreman-sections-list-empty">–†–∞–∑–¥–µ–ª—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</div>');const e=currentForemanSections.map(t=>`\n            <div class="foreman-sections-list-item" data-section-id="${t.id}">\n                <span>${t.name||`ID ${t.id}`}</span>\n                <button type="button" class="danger" onclick="removeSectionFromForeman(${t.id})">üóëÔ∏è</button>\n            </div>\n        `);t.innerHTML=e.join("")}function addSectionToForeman(){const t=document.getElementById("foremanSectionsSelect");if(!t)return;const e=t.value;if(!e)return void showNotification("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è","error");let o;try{o=parseInt(e,10)}catch(t){o=NaN}if(!Number.isInteger(o)||o<=0)return void showNotification("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ä–∞–∑–¥–µ–ª–∞","error");if(currentForemanSections.some(t=>t.id===o))return void showNotification("–†–∞–∑–¥–µ–ª —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω","error");const r=categories.find(t=>t.id===o);r?(currentForemanSections=[...currentForemanSections,{id:r.id,name:r.name}],displayForemanSectionsList(),populateForemanSectionsSelect(),t.value=""):showNotification("–†–∞–∑–¥–µ–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ —Ä–∞–∑–¥–µ–ª–æ–≤","error")}function removeSectionFromForeman(t){currentForemanSections=currentForemanSections.filter(e=>e.id!==t),displayForemanSectionsList(),populateForemanSectionsSelect()}async function saveForemanSections(){if(!currentForemanIdForSections)return void showNotification("–ù–µ –≤—ã–±—Ä–∞–Ω –±—Ä–∏–≥–∞–¥–∏—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–æ–≤","error");const t=currentForemanSections.map(t=>t.id);try{const e=await makeApiRequest(`${API_CONFIG.ENDPOINTS.FOREMEN}/${currentForemanIdForSections}/sections`,{method:"PUT",body:JSON.stringify({category_ids:t})});if(e&&e.success){const t=Array.isArray(e.data)?e.data:null;t&&(currentForemanSections=t.map(t=>({id:t.id,name:t.name})),displayForemanSectionsList(),populateForemanSectionsSelect()),showNotification("–†–∞–∑–¥–µ–ª—ã –±—Ä–∏–≥–∞–¥–∏—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã","success")}else{showNotification(e?.error||e?.detail||"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞–∑–¥–µ–ª—ã –±—Ä–∏–≥–∞–¥–∏—Ä–∞","error")}}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–∞–∑–¥–µ–ª–æ–≤: "+t.message,"error")}}function closeForemanSectionsModal(){const t=document.getElementById("foremanSectionsModal");t&&(t.style.display="none"),currentForemanIdForSections=null,currentForemanSections=[];const e=document.getElementById("foremanSectionsSelect");e&&(e.value=""),displayForemanSectionsList(),populateForemanSectionsSelect()}async function saveForeman(t){const e=document.querySelector(`tr:has(input[value="${t}"])`).querySelectorAll(".editable"),o={id:t};e.forEach(t=>{const e=t.getAttribute("data-field");let r=t.value;"is_active"===e&&(r=parseInt(r)),o[e]=r});try{const e=await makeApiRequest(`${API_CONFIG.ENDPOINTS.FOREMEN}/${t}`,{method:"PUT",body:JSON.stringify(o)});e.success?showNotification("–î–∞–Ω–Ω—ã–µ –±—Ä–∏–≥–∞–¥–∏—Ä–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã","success"):showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±—Ä–∏–≥–∞–¥–∏—Ä–∞: "+(e.error||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"),"error")}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±—Ä–∏–≥–∞–¥–∏—Ä–∞: "+t.message,"error")}}async function deleteForeman(t){if(confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –±—Ä–∏–≥–∞–¥–∏—Ä–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å."))try{const e=await makeApiRequest(`${API_CONFIG.ENDPOINTS.FOREMEN}/${t}`,{method:"DELETE"});e.success?(showNotification("–ë—Ä–∏–≥–∞–¥–∏—Ä —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω","success"),await loadForemen()):showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –±—Ä–∏–≥–∞–¥–∏—Ä–∞: "+(e.error||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"),"error")}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –±—Ä–∏–≥–∞–¥–∏—Ä–∞: "+t.message,"error")}}async function saveAllForemen(){const t=document.getElementById("saveAllForemen"),e=document.querySelectorAll("#foremenTableBody tr");if(!e.length)return void showNotification("–ù–µ—Ç –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è","error");t&&(t.disabled=!0);const o=[];if(e.forEach(t=>{const e=t.querySelector("td:first-child input");if(!e)return;const r=parseInt(e.value,10);if(!Number.isInteger(r))return;const n={id:r};t.querySelectorAll(".editable").forEach(t=>{const e=t.getAttribute("data-field");if(!e)return;let o=t.value;"is_active"===e&&(o=parseInt(o,10)),n[e]=o}),o.push(n)}),!o.length)return t&&(t.disabled=!1),void showNotification("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è","error");let r=0;const n=[];for(const t of o)try{const e=await makeApiRequest(`${API_CONFIG.ENDPOINTS.FOREMEN}/${t.id}`,{method:"PUT",body:JSON.stringify(t)});e&&e.success?r+=1:n.push(t.id)}catch(e){console.error("Bulk foreman update error:",e),n.push(t.id)}t&&(t.disabled=!1),r>0&&(await loadForemen(),showNotification(`–î–∞–Ω–Ω—ã–µ ${r} –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã`,"success")),n.length>0&&showNotification(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–ª—è –±—Ä–∏–≥–∞–¥–∏—Ä–æ–≤: ${n.join(", ")}`,"error")}function filterForemen(){const t=document.getElementById("searchForemen").value.toLowerCase();displayForemen(foremen.filter(e=>e.full_name&&e.full_name.toLowerCase().includes(t)||e.position&&e.position.toLowerCase().includes(t)||e.username&&e.username.toLowerCase().includes(t)))}async function loadReports(){const t=document.getElementById("reportsLoading"),e=document.getElementById("reportsTableBody");t.style.display="block",e.innerHTML="";try{reports=[],displayReports(reports)}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ç—á–µ—Ç–æ–≤: "+t.message,"error")}finally{t.style.display="none"}}function displayReports(t){const e=document.getElementById("reportsTableBody");if(e.innerHTML="",0===t.length)return e.innerHTML='<tr><td colspan="8" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Ç—á–µ—Ç–∞—Ö</td></tr>',void refreshTableSorting("reportsTable");refreshTableSorting("reportsTable")}function addNewReport(){showNotification("–§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏","success")}async function saveAllReports(){showNotification("–§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–æ–≤ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏","success")}function filterReports(){}document.addEventListener("DOMContentLoaded",function(){document.getElementById("username").addEventListener("keypress",function(t){"Enter"===t.key&&login()}),document.getElementById("password").addEventListener("keypress",function(t){"Enter"===t.key&&login()}),checkAuth()});let accumulativeData=[];function initializeAccumulativeTab(){document.getElementById("refreshAccumulative").addEventListener("click",loadAccumulativeStatement),document.getElementById("exportAccumulative").addEventListener("click",exportAccumulativeToExcel),document.getElementById("searchAccumulative").addEventListener("input",filterAccumulative),document.getElementById("foremanFilterButton").addEventListener("click",toggleForemanDropdown),document.addEventListener("click",handleForemanDropdownOutsideClick)}async function loadAccumulativeStatement(){const t=document.getElementById("accumulativeLoading"),e=document.getElementById("accumulativeTableBody");t.style.display="block",e.innerHTML="";try{const t=selectedAccumulativeForemanId?`?foreman_id=${selectedAccumulativeForemanId}`:"",e=await makeApiRequest(`/api/accumulative-statement${t}`);e.success?(accumulativeData=e.data||[],accumulativeForemen=e.foremen||[],updateAccumulativeForemanButton(),populateForemanDropdown(),displayAccumulativeStatement(accumulativeData)):showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ–π –≤–µ–¥–æ–º–æ—Å—Ç–∏: "+e.error,"error")}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ–π –≤–µ–¥–æ–º–æ—Å—Ç–∏: "+t.message,"error")}finally{t.style.display="none"}}function updateAccumulativeForemanButton(){const t=document.getElementById("foremanFilterButton");if(!t)return;const e=accumulativeForemen.find(t=>String(t.id)===String(selectedAccumulativeForemanId)),o=e?e.full_name:"–í—Å–µ –±—Ä–∏–≥–∞–¥–∏—Ä—ã";t.textContent=`üë∑ ${o}`}function populateForemanDropdown(){const t=document.getElementById("foremanDropdownMenu");if(!t)return;t.innerHTML="";const e=document.createElement("button");e.className="dropdown-item",e.type="button",e.textContent="–í—Å–µ –±—Ä–∏–≥–∞–¥–∏—Ä—ã",e.addEventListener("click",()=>selectAccumulativeForeman(null)),t.appendChild(e),accumulativeForemen.forEach(e=>{const o=document.createElement("button");o.className="dropdown-item",o.type="button",o.textContent=e.full_name||`ID ${e.id}`,o.addEventListener("click",()=>selectAccumulativeForeman(e.id)),t.appendChild(o)})}function toggleForemanDropdown(t){t.stopPropagation();const e=document.getElementById("foremanDropdownMenu");e&&e.classList.toggle("show")}function handleForemanDropdownOutsideClick(t){const e=document.getElementById("accumulativeForemanDropdown"),o=document.getElementById("foremanDropdownMenu");e&&o&&(e.contains(t.target)||o.classList.remove("show"))}function selectAccumulativeForeman(t){selectedAccumulativeForemanId=t,updateAccumulativeForemanButton();const e=document.getElementById("foremanDropdownMenu");e&&e.classList.remove("show"),loadAccumulativeStatement()}function displayAccumulativeStatement(t){const e=document.getElementById("accumulativeTableBody");if(e.innerHTML="",0===t.length)return e.innerHTML='<tr><td colspan="8" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>',void refreshTableSorting("accumulativeTable");t.forEach(t=>{const o=t.–†–∞–∑–¥–µ–ª||t.–ö–∞—Ç–µ–≥–æ—Ä–∏—è||"",r=document.createElement("tr"),n=Number(t.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ),a=Number(t.–ü—Ä–æ–µ–∫—Ç),i=Number(t["%–í—ã–ø–æ–ª–Ω–µ–Ω–∏—è"]),c=Number(t["–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É"]??0),s=Number(t["–°—É–º–º–∞"]??0);r.innerHTML=`\n                <td>${o}</td>\n                <td>${t.–†–∞–±–æ—Ç–∞}</td>\n                <td>${t["–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è"]}</td>\n                <td data-sort-value="${Number.isFinite(c)?c:""}">${formatMoneyValue(c)}</td>\n                <td data-sort-value="${Number.isFinite(n)?n:""}">${t.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ}</td>\n                <td data-sort-value="${Number.isFinite(a)?a:""}">${t.–ü—Ä–æ–µ–∫—Ç}</td>\n                <td data-sort-value="${Number.isFinite(i)?i:""}">${t["%–í—ã–ø–æ–ª–Ω–µ–Ω–∏—è"]}%</td>\n                <td data-sort-value="${Number.isFinite(s)?s:""}">${formatMoneyValue(s)}</td>\n            `,e.appendChild(r)}),refreshTableSorting("accumulativeTable")}function filterAccumulative(){const t=document.getElementById("searchAccumulative").value.toLowerCase();displayAccumulativeStatement(accumulativeData.filter(e=>(e.–†–∞–∑–¥–µ–ª||e.–ö–∞—Ç–µ–≥–æ—Ä–∏—è||"").toLowerCase().includes(t)||e.–†–∞–±–æ—Ç–∞.toLowerCase().includes(t)))}async function exportAccumulativeToExcel(){try{showNotification("–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è...","success");const t=XLSX.utils.book_new();t.Props={Title:"–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è –≤–µ–¥–æ–º–æ—Å—Ç—å",Subject:"–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è –≤–µ–¥–æ–º–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç",Author:"WiTech System",CreatedDate:new Date};const e=accumulativeData.map(t=>({"–†–∞–∑–¥–µ–ª":t.–†–∞–∑–¥–µ–ª||t.–ö–∞—Ç–µ–≥–æ—Ä–∏—è||"","–†–∞–±–æ—Ç–∞":t.–†–∞–±–æ—Ç–∞,"–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è":t["–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è"],"–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É":formatMoneyValue(t["–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É"]),"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ":t.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ,"–ü—Ä–æ–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ":t.–ü—Ä–æ–µ–∫—Ç,"% –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è":t["%–í—ã–ø–æ–ª–Ω–µ–Ω–∏—è"],"–°—É–º–º–∞":formatMoneyValue(t["–°—É–º–º–∞"])})),o=XLSX.utils.json_to_sheet(e),r=[{wch:25},{wch:40},{wch:18},{wch:18},{wch:16},{wch:18},{wch:18},{wch:18}];o["!cols"]=r,XLSX.utils.book_append_sheet(t,o,"–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è –≤–µ–¥–æ–º–æ—Å—Ç—å");const n=`accumulative_statement_${(new Date).toISOString().split("T")[0]}.xlsx`;XLSX.writeFile(t,n),showNotification("–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω","success")}catch(t){console.error("Export error:",t),showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ —Ñ–∞–π–ª–∞: "+t.message,"error")}}async function loadAllReports(){const t=document.getElementById("allReportsLoading"),e=document.getElementById("allReportsTableBody");t.style.display="block",e.innerHTML="";try{const t=await makeApiRequest(API_CONFIG.ENDPOINTS.ALL_REPORTS);t.success?(allReports=t.data||[],displayAllReportsTable(allReports)):showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ç—á–µ—Ç–æ–≤: "+t.error,"error")}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ç—á–µ—Ç–æ–≤: "+t.message,"error")}finally{t.style.display="none"}}function displayAllReportsTable(t){const e=document.getElementById("allReportsTableBody");if(e.innerHTML="",0===t.length)return e.innerHTML='<tr><td colspan="9" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Ç—á–µ—Ç–∞—Ö</td></tr>',void refreshTableSorting("allReportsTable");t.forEach(t=>{const o=t.photo_report_url?`<a href="${t.photo_report_url}" target="_blank" style="color: var(--primary);">üì∑ –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å</a>`:"–ù–µ—Ç —Ñ–æ—Ç–æ",r=Boolean(t.is_verified),n="verify-button"+(r?" verified":""),a=r?"‚úÖ":"–ü—Ä–æ–≤–µ—Ä–∏—Ç—å",i=r?"–û—Ç—á–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω":"–û—Ç–º–µ—Ç–∏—Ç—å –æ—Ç—á–µ—Ç –∫–∞–∫ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π",c=Number(t.quantity),s=t.report_date?String(t.report_date).replace(" ","T"):"",l=document.createElement("tr");l.innerHTML=`\n                <td>${t.id}</td>\n                <td>${t.foreman_name||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}</td>\n                <td>${t.foreman_position||"‚Äî"}</td>\n                <td>${t.work_name||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}</td>\n                <td data-sort-value="${Number.isFinite(c)?c:""}">${t.quantity} ${t.unit||"—à—Ç"}</td>\n                <td data-sort-value="${s}">${t.report_date}</td>\n                <td>${t.report_time}</td>\n                <td>${o}</td>\n                <td class="action-buttons">\n                    <button onclick="editReport(${t.id})" class="secondary">‚úèÔ∏è</button>\n                    <button onclick="deleteReport(${t.id})" class="danger">üóëÔ∏è</button>\n                    <button onclick="toggleReportVerification(${t.id}, ${!r})" class="${n}" title="${i}">${a}</button>\n                </td>\n            `,e.appendChild(l)}),refreshTableSorting("allReportsTable")}async function deleteReport(t){if(confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç—á–µ—Ç?"))try{const e=await makeApiRequest(`${API_CONFIG.ENDPOINTS.REPORT}/${t}`,{method:"DELETE"});e.success?(showNotification("–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω","success"),loadAllReports()):showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞: "+(e.error||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"),"error")}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞: "+t.message,"error")}}async function toggleReportVerification(t,e){try{const o=await makeApiRequest(`${API_CONFIG.ENDPOINTS.REPORT}/${t}/verify`,{method:"POST",body:JSON.stringify({is_verified:e})});if(o.success){const r=o.data?.is_verified??e,n=allReports.findIndex(e=>e.id===t);-1!==n&&(allReports[n].is_verified=r);showNotification(r?"–û—Ç—á–µ—Ç –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π":"–û—Ç–º–µ—Ç–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–Ω—è—Ç–∞","success");const a=document.getElementById("searchAllReports");a&&a.value.trim()?filterAllReports():displayAllReportsTable(allReports)}else showNotification("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏: "+(o.error||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"),"error")}catch(t){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: "+t.message,"error")}}function filterAllReports(){const t=document.getElementById("searchAllReports"),e=t?t.value.toLowerCase():"";displayAllReportsTable(allReports.filter(t=>t.foreman_name&&t.foreman_name.toLowerCase().includes(e)||t.foreman_position&&t.foreman_position.toLowerCase().includes(e)||t.work_name&&t.work_name.toLowerCase().includes(e)||t.report_date&&t.report_date.toLowerCase().includes(e)))}function showNotification(t,e){const o=document.getElementById("notification");o.textContent=t,o.className=`notification ${e}`,o.style.display="block",setTimeout(()=>{o.style.display="none"},5e3)}const waves=document.querySelector(".waves");let waveOffset=0;function animateWaves(){waveOffset+=.5,waves.style.backgroundPositionX=-waveOffset+"px",requestAnimationFrame(animateWaves)}document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("addBalanceAmount");t&&t.addEventListener("keypress",function(t){"Enter"===t.key&&confirmAddBalance()});const e=document.getElementById("addMaterialQuantityAmount");e&&e.addEventListener("keypress",function(t){"Enter"===t.key&&confirmAddMaterialQuantity()})}),animateWaves();